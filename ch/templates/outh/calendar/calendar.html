<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Calendar Events</title>

    <!-- Bootstrap 5 & FullCalendar CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@3.2.0/dist/fullcalendar.min.css">

    <!-- jQuery, Bootstrap JS, Moment.js, and FullCalendar -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@3.2.0/dist/fullcalendar.min.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            padding: 20px;
        }
        #calendar {
            max-width: 900px;
            margin: 0 auto;
        }
    </style>
</head>
<body>

    <h2 class="text-center">Google Calendar Events</h2>
    <div id="calendar"></div>

    <!-- Bootstrap Modal for Creating New Event -->
    <!-- Bootstrap Modal for Creating Google Calendar Event -->
    <div class="modal fade" id="createEventModal" tabindex="-1" aria-labelledby="createEventModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="createEventModalLabel">Create Google Calendar Event</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="createEventForm">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="eventTitleInput" class="form-label">Event Title</label>
                            <input type="text" class="form-control" id="eventTitleInput" required>
                        </div>
                        <div class="mb-3">
                            <label for="eventStartDateInput" class="form-label">Start Date</label>
                            <input type="date" class="form-control" id="eventStartDateInput" required>
                        </div>
                        <div class="mb-3">
                            <label for="eventStartTimeInput" class="form-label">Start Time</label>
                            <input type="time" class="form-control" id="eventStartTimeInput" required>
                        </div>
                        <div class="mb-3">
                            <label for="eventEndDateInput" class="form-label">End Date</label>
                            <input type="date" class="form-control" id="eventEndDateInput" required>
                        </div>
                        <div class="mb-3">
                            <label for="eventEndTimeInput" class="form-label">End Time</label>
                            <input type="time" class="form-control" id="eventEndTimeInput" required>
                        </div>
                        <div class="mb-3">
                            <label for="eventLocationInput" class="form-label">Location</label>
                            <input type="text" class="form-control" id="eventLocationInput">
                        </div>
                        <div class="mb-3">
                            <label for="eventDescriptionInput" class="form-label">Description</label>
                            <textarea class="form-control" id="eventDescriptionInput"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="eventGuestsInput" class="form-label">Guests (Emails, comma-separated)</label>
                            <input type="text" class="form-control" id="eventGuestsInput">
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="generateMeetingLinkToggle">
                            <label class="form-check-label" for="generateMeetingLinkToggle">Generate Google Meet Link</label>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="notifyGuestsToggle">
                            <label class="form-check-label" for="notifyGuestsToggle">Notify Guests</label>
                        </div>
                        <button type="submit" class="btn btn-primary">Create Event</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap Modal for Viewing Event Details -->
    <div class="modal fade" id="viewEventModal" tabindex="-1" aria-labelledby="viewEventModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="viewEventModalLabel">Event Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p><strong>Title:</strong> <span id="eventTitleDetail"></span></p>
                    <p><strong>Start:</strong> <span id="eventStartDetail"></span></p>
                    <p><strong>End:</strong> <span id="eventEndDetail"></span></p>
                    <p><strong>Location:</strong> <span id="eventLocationDetail"></span></p>
                    <p><strong>Description:</strong> <span id="eventDescriptionDetail"></span></p>
                    <p><strong>Organizer:</strong> <span id="eventOrganizerDetail"></span></p>
                    <p><strong>Guests:</strong> <span id="eventGuestsDetail"></span></p>
                    <p><strong>Meeting Link:</strong> <span id="eventMeetingLinkDetail"></span></p>
                    <p><strong>Attachments:</strong> <span id="eventAttachmentsDetail"></span></p>
                </div>
            </div>
        </div>
    </div>

    <script>
       
        $(document).ready(function() {
            $('#calendar').fullCalendar({
                events: '/oauth/calendar/google_events/',
                selectable: true,
                select: function(start) {
                    // Automatically set the selected date as the start date
                    $('#eventStartDateInput').val(moment(start).format('YYYY-MM-DD'));
                    $('#eventStartTimeInput').val(moment(start).format('HH:mm'));
                    $('#eventEndDateInput').val(moment(start).add(1, 'hour').format('YYYY-MM-DD')); // Default end date is 1 hour after start
                    $('#eventEndTimeInput').val(moment(start).add(1, 'hour').format('HH:mm')); // Default end time is 1 hour after start
                    $('#createEventModal').modal('show');
                },
                eventClick: function(calEvent) {
                    // Fetch event details using AJAX
                    $.ajax({
                        url: '/oauth/google_event_details/' + calEvent.id + '/',
                        method: 'GET',
                        success: function(data) {
                            // Populate modal with event details
                            $('#eventTitleDetail').text(data.title);
                            $('#eventStartDetail').text(moment(data.start).format('YYYY-MM-DD HH:mm'));
                            $('#eventEndDetail').text(moment(data.end).format('YYYY-MM-DD HH:mm'));
                            $('#eventLocationDetail').text(data.location);
                            $('#eventDescriptionDetail').text(data.description);
                            $('#eventOrganizerDetail').text(data.organizer);
                            $('#eventGuestsDetail').text(data.guests.join(', '));

                            // Display the meeting link as "Join Meeting" if available
                            if (data.meeting_link && data.meeting_link !== "No Meeting Link") {
                                $('#eventMeetingLinkDetail').html(`<a href="${data.meeting_link}" target="_blank">Join Meeting</a>`);
                            } else {
                                $('#eventMeetingLinkDetail').text(data.meeting_link);
                            }

                            // Display attachments
                            let attachmentsHtml = '';
                            data.attachments.forEach(function(attachment) {
                                attachmentsHtml += `<br><a href="${attachment.fileUrl}" target="_blank">${attachment.title}</a>`;
                            });
                            $('#eventAttachmentsDetail').html(attachmentsHtml || "No Attachments");

                            // Show the modal
                            $('#viewEventModal').modal('show');
                        },
                        error: function() {
                            alert('Error fetching event details');
                        }
                    });
                }
            });


           


            // Create Google Event (Form submission)
             // Create Google Event
             $('#createEventForm').submit(function (e) {
                e.preventDefault();

                // Get values from the form
                let title = $('#eventTitleInput').val();
                let startDate = $('#eventStartDateInput').val();
                let startTime = $('#eventStartTimeInput').val();
                let endDate = $('#eventEndDateInput').val();
                let endTime = $('#eventEndTimeInput').val();
                let location = $('#eventLocationInput').val();
                let description = $('#eventDescriptionInput').val();
                let guests = $('#eventGuestsInput').val().split(',').map(email => email.trim());
                let generateMeetingLink = $('#generateMeetingLinkToggle').is(':checked');
                let notifyGuests = $('#notifyGuestsToggle').is(':checked');

                // Ensure start and end date-time are correctly formatted
                let startDateTime = `${startDate}T${startTime}:00`;
                let endDateTime = `${endDate}T${endTime}:00`;

                let eventData = {
                    title: title,
                    start: startDateTime,
                    end: endDateTime,
                    location: location,
                    description: description,
                    guests: guests.filter(email => email !== ""), // Remove empty emails
                    meeting_link: generateMeetingLink,
                    notify_guests: notifyGuests
                };

                // Debugging Log
                console.log("üìå Sending Event Data:", eventData);

                $.ajax({
                    url: '/oauth/google_create_event/',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(eventData),
                    headers: { 'X-CSRFToken': '{{ csrf_token }}' },
                    success: function (response) {
                        alert('‚úÖ Event Created Successfully!');
                        $('#createEventModal').modal('hide');

                        // Refresh calendar events (if using FullCalendar)
                        if ($('#calendar').length) {
                            $('#calendar').fullCalendar('refetchEvents');
                        }
                    },
                    error: function (xhr) {
                        alert('‚ùå Error Creating Event: ' + xhr.responseText);
                    }
                });
            });
        });

    </script>

</body>
</html>
