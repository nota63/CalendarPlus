<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat in Channel: {{ channel.name }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Add Bootstrap 5 CSS in your <head> section -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<style>
  /* Style for the modal */
  .modal-content {
        background-color: #f8f9fa; /* Light background for modal */
        border-radius: 15px;
        padding: 20px;
    }

    /* Title of the modal */
    .modal-title {
        font-size: 1.5rem;
        font-weight: bold;
        color: #007bff;
    }

    /* Table style inside modal */
    .modal-body table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
    }

    .modal-body table th,
    .modal-body table td {
        padding: 10px;
        text-align: left;
        border: 1px solid #ddd;
    }

    .modal-body table th {
        background-color: #007bff;
        color: #fff;
    }

    .modal-body table td {
        background-color: #f1f1f1;
    }

    /* Members List */
    #membersList {
        margin-top: 15px;
        list-style: none;
        padding: 0;
    }

    #membersList li {
        padding: 5px 0;
        font-size: 1rem;
        color: #333;
    }

    #membersList li:hover {
        background-color: #f1f1f1;
    }

    /* Footer styling */
    .modal-footer {
        background-color: #f1f1f1;
        border-top: 1px solid #ddd;
        padding: 10px;
    }

    .modal-footer .btn-secondary {
        background-color: #6c757d;
        color: white;
    }

    .modal-footer .btn-secondary:hover {
        background-color: #5a6268;
    }



    .popup-message {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    padding: 10px 20px;
    background-color: #007bff;
    color: white;
    border-radius: 5px;
    font-size: 16px;
    z-index: 9999;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}


</style>


<!-- Modal for displaying the user list -->
<div id="userListModal" class="modal fade" tabindex="-1" aria-labelledby="userListModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="userListModalLabel">Channel Users including you</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <ul id="userList" class="list-group">
                    <!-- List of users will be dynamically populated here -->
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>


<!-- Bootstrap 5 Modal to show the logs -->
<div class="modal fade" id="activityLogsModal" tabindex="-1" aria-labelledby="activityLogsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="activityLogsModalLabel">Activity Logs</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="max-height: 400px; overflow-y: auto;">
                <div id="activityLogsList" class="list-group">
                    <!-- Logs will be dynamically populated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>


<!-- Modal for Channel Details -->
<div id="channelDetailsModal" class="modal fade" tabindex="-1" aria-labelledby="channelDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="channelDetailsModalLabel">Channel Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- About Section -->
                <h5>About</h5>
                <p><i class="bi bi-card-text text-primary" style="font-size: 1.2rem;"></i> <strong>Name:</strong> <span id="channelName"></span></p>
                <p><i class="bi bi-type text-primary" style="font-size: 1.2rem;"></i> <strong>Type:</strong> <span id="channelType"></span></p>
                <p><i class="bi bi-eye text-primary" style="font-size: 1.2rem;"></i> <strong>Visibility:</strong> <span id="channelVisibility"></span></p>
                <p><i class="bi bi-calendar text-primary" style="font-size: 1.2rem;"></i> <strong>Created At:</strong> <span id="channelCreatedAt"></span></p>
                <p><i class="bi bi-person text-primary" style="font-size: 1.2rem;"></i> <strong>Created By:</strong> <span id="channelCreatedBy"></span></p>

                <!-- Members Section -->
                <h5>Members</h5>
                <ul id="membersList" class="list-group">
                    <!-- Members will be dynamically populated here -->
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Popup Message -->
<div id="popupMessage" class="popup-message" style="display: none;">
    We'll export the data and send it to {{request.user.email}}. You can proceed with other tasks in the meantime...
</div>




<!-- Modal to Display the Channel Statistics -->
<div class="modal fade" id="statisticsModal" tabindex="-1" aria-labelledby="statisticsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="statisticsModalLabel">Channel Statistics</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <h5>Total Messages: <span id="totalMessages"></span></h5>
          <h5>Total Links: <span id="totalLinks"></span></h5>
          <h5>King User: <span id="kingUser"></span></h5>
  
          <!-- Chart Section -->
          <div class="row">
            <!-- Messages Chart -->
            <div class="col-md-6 mb-4">
              <canvas id="messagesChart"></canvas>
            </div>
  
            <!-- Links Chart -->
            <div class="col-md-6 mb-4">
              <canvas id="linksChart"></canvas>
            </div>
  
            <!-- Chart 3: User Message Counts -->
            <div class="col-md-6 mb-4">
              <canvas id="userMessageCountsChart"></canvas>
            </div>
  
            <!-- Chart 4: User Link Counts -->
            <div class="col-md-6 mb-4">
              <canvas id="userLinkCountsChart"></canvas>
            </div>
  
            <!-- Chart 5: Total Messages -->
            <div class="col-md-6 mb-4">
              <canvas id="totalMessagesChart"></canvas>
            </div>
  
            <!-- Chart 6: Total Links -->
            <div class="col-md-6 mb-4">
              <canvas id="totalLinksChart"></canvas>
            </div>
  
            <!-- Chart 7: King User Stats -->
            <div class="col-md-6 mb-4">
              <canvas id="kingUserChart"></canvas>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
  
<!-- ---------------------------------------------------------------------------------------------------------------------------------------------------------- -->

<!-- Button to trigger fetching logs -->
<button id="fetchLogsButton" class="btn btn-primary">Fetch Activity Logs</button>
 <!-- Button to open the user list modal -->

<!-- Button to open the user list modal -->
<button id="userListButton" 
        class="btn btn-primary btn-lg shadow-sm px-3 py-1 rounded text-white">
    View Users
</button>

<!-- VIEW CHANNEL DETAILS -->
<button id="viewChannelDetailsButton" class="btn btn-info">
    View Channel Details
</button>

<a href="{% url 'export_data' org_id=channel.organization.id channel_id=channel.id %}" class="btn btn-primary" id="exportDataButton">Export Data</a>


<!-- Button to Trigger the Modal -->
<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#statisticsModal">
    Show Channel Statistics
  </button>



<!-- -------------------------------------------------------------------------------------------------------------------------------------------------------- -->
<section class="d-flex align-items-center py-4">
    <img src="https://th.bing.com/th/id/OIP.MQrqu3lrda8Tc7LOTnisxgHaHa?rs=1&pid=ImgDetMain" class="img-fluid rounded-circle" style="max-width: 80px; height: auto;" alt="Channel Image">
    <div class="ms-3">
        <h5 class="text-primary">
            Everyone‚Äôs all here in <strong>#{{channel.name}}</strong>
        </h5>
        <p class="text-muted">
            Share announcements and updates about company news, upcoming events, or teammates who deserve some kudos. ‚≠ê
        </p>
    </div>
</section>



<body class="bg-gray-100">
    <div class="max-w-4xl mx-auto mt-10">
        <div class="mb-4">
            <input 
                type="text" 
                id="searchInput" 
                placeholder="Search messages and links..." 
                class="form-control form-control-lg"
            />
        </div>

        <div id="chatWindow" class="bg-white p-4 rounded-lg shadow-lg mb-4 max-h-[400px] overflow-y-auto">
            <!-- Loop through messages and display them -->
            {% for message in messages %}
                <div class="border-b py-2">
                    <strong>{{ message.user.username }}</strong>: 
                    {% if message.link %}
                        <a href="{{ message.link }}" target="_blank" class="text-blue-500 hover:underline">{{ message.link }}</a>
                    {% else %}
                        {{ message.content }}
                    {% endif %}
                    <span class="text-sm text-gray-500 ml-2">{{ message.timestamp|date:"H:i" }}</span>
                </div>
            {% empty %}
                <p class="text-center text-gray-500">No messages yet. Be the first to send a message!</p>
            {% endfor %}

            <!-- Loop through links and display them -->
            {% for link in links %}
                <div class="border-b py-2">
                    <strong>{{ link.user.username }}</strong>: 
                    <a href="{{ link.link }}" target="_blank" class="text-blue-500 hover:underline">{{ link.text }}</a>
                    <span class="text-sm text-gray-500 ml-2">{{ link.timestamp|date:"H:i" }}</span>
                </div>
            {% empty %}
                <p class="text-center text-gray-500">No links shared yet!</p>
            {% endfor %}
        </div>

        <div class="flex">
            <button id="mentionButton" class="bg-yellow-500 text-white p-2 rounded-l-lg">Mention User</button>
            <input id="messageInput" type="text" class="border p-2 w-full rounded-r-lg" placeholder="Type a message...">
            <button id="sendMessage" class="bg-blue-500 text-white p-2 rounded-lg">Send</button>
            <button id="sendLinkButton" class="bg-green-500 text-white p-2 ml-2 rounded-lg">Send Link</button>
            <button id="emojiPickerButton" class="bg-purple-500 text-white p-2 ml-2 rounded-lg">üòä</button>

            <!-- New buttons for uploading audio and video -->
            <button id="uploadAudioButton" class="bg-indigo-500 text-white p-2 ml-2 rounded-lg">üìÄ Upload Audio</button>
            <button id="uploadVideoButton" class="bg-teal-500 text-white p-2 ml-2 rounded-lg">üé• Upload Video</button>
        </div>

        <!-- Modal to mention users -->
        <div id="mentionModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white p-6 rounded-lg w-1/3">
                <h2 class="text-xl font-bold mb-4">Mention a User</h2>
                <ul id="mentionList" class="space-y-2">
                    <!-- List of users will be populated here -->
                </ul>
                <div class="flex justify-end">
                    <button id="closeMentionModal" class="bg-gray-500 text-white p-2 rounded-lg">Close</button>
                </div>
            </div>
        </div>

        <!-- Modal to send link -->
        <div id="sendLinkModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white p-6 rounded-lg w-1/3">
                <h2 class="text-xl font-bold mb-4">Send a Link</h2>
                <input id="linkText" type="text" class="border p-2 w-full mb-4" placeholder="Link Text">
                <input id="linkUrl" type="url" class="border p-2 w-full mb-4" placeholder="URL">
                <div class="flex justify-end">
                    <button id="sendLink" class="bg-blue-500 text-white p-2 rounded-lg">Send Link</button>
                    <button id="closeLinkModal" class="bg-gray-500 text-white p-2 ml-2 rounded-lg">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Emoji Picker Modal -->
        <div id="emojiPickerModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white p-6 rounded-lg w-1/3 max-h-[80vh] overflow-y-auto">
                <h2 class="text-xl font-bold mb-4">Pick an Emoji</h2>
                <div id="emojiContainer" class="grid grid-cols-6 gap-2 max-h-[60vh] overflow-y-auto">
                    <!-- Emoji options will be populated here -->
                </div>
                <div class="flex justify-end mt-4">
                    <button id="closeEmojiPickerModal" class="bg-gray-500 text-white p-2 rounded-lg hover:bg-gray-600">Close</button>
                </div>
            </div>
        </div>

        <!-- Audio Upload Modal -->
        <div id="audioUploadModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white p-6 rounded-lg w-1/3">
                <h2 class="text-xl font-bold mb-4">Upload Audio</h2>
                <input type="file" id="audioFileInput" class="border p-2 w-full mb-4" accept="audio/*">
                <div class="flex justify-end">
                    <button id="uploadAudio" class="bg-blue-500 text-white p-2 rounded-lg">Upload</button>
                    <button id="closeAudioModal" class="bg-gray-500 text-white p-2 ml-2 rounded-lg">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Video Upload Modal -->
        <div id="videoUploadModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white p-6 rounded-lg w-1/3">
                <h2 class="text-xl font-bold mb-4">Upload Video</h2>
                <input type="file" id="videoFileInput" class="border p-2 w-full mb-4" accept="video/*">
                <div class="flex justify-end">
                    <button id="uploadVideo" class="bg-blue-500 text-white p-2 rounded-lg">Upload</button>
                    <button id="closeVideoModal" class="bg-gray-500 text-white p-2 ml-2 rounded-lg">Cancel</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // Get the channel ID from the Django template context
        const channelId = "{{ channel.id }}";
        const chatSocket = new WebSocket(`ws://${window.location.host}/ws/channel/${channelId}/`);
   
        // When the WebSocket connection is opened
        chatSocket.onopen = function(e) {
            console.log('WebSocket connection established!');
        };

        // When a new message is received from the WebSocket
        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            const message = data['message'];
            const username = data['username'];
            // Append the message to the chat window
            const messageElement = document.createElement('div');
            messageElement.className = 'border-b py-2';
            messageElement.innerHTML = `<strong>${username}</strong>: ${message} <span class="text-sm text-gray-500 ml-2">${data['time']}</span>`;
            
            if (data['link']) {
                messageElement.innerHTML = `<strong>${username}</strong>: <a href="${data['link']}" target="_blank" class="text-blue-500 hover:underline">${data['link']}</a> <span class="text-sm text-gray-500 ml-2">${data['time']}</span>`;
            }

            document.getElementById('chatWindow').appendChild(messageElement);
            document.getElementById('chatWindow').scrollTop = document.getElementById('chatWindow').scrollHeight;
        };

        // Emoji Picker Modal Logic
        const emojiPickerButton = document.getElementById('emojiPickerButton');
        const emojiPickerModal = document.getElementById('emojiPickerModal');
        const closeEmojiPickerModal = document.getElementById('closeEmojiPickerModal');
        const emojiContainer = document.getElementById('emojiContainer');
        const emojis = [
            'üöÄ', '‚ö°', 'üí•', 'üî•', 'üåü', 'üèÜ', 'üíØ', '‚úÖ', 'üìù', 'üíª',
        ];

        emojiPickerButton.onclick = () => {
            emojiContainer.innerHTML = '';
            emojis.forEach(emoji => {
                const button = document.createElement('button');
                button.className = 'text-2xl';
                button.textContent = emoji;
                button.onclick = () => {
                    const messageInput = document.getElementById('messageInput');
                    messageInput.value += emoji;
                    emojiPickerModal.classList.add('hidden');
                };
                emojiContainer.appendChild(button);
            });
            emojiPickerModal.classList.remove('hidden');
        };

        closeEmojiPickerModal.onclick = () => emojiPickerModal.classList.add('hidden');

        // Open the audio upload modal
        document.getElementById('uploadAudioButton').onclick = function() {
            document.getElementById('audioUploadModal').classList.remove('hidden');
        };

        // Close the audio upload modal
        document.getElementById('closeAudioModal').onclick = function() {
            document.getElementById('audioUploadModal').classList.add('hidden');
        };

        // Open the video upload modal
        document.getElementById('uploadVideoButton').onclick = function() {
            document.getElementById('videoUploadModal').classList.remove('hidden');
        };

        // Close the video upload modal
        document.getElementById('closeVideoModal').onclick = function() {
            document.getElementById('videoUploadModal').classList.add('hidden');
        };

        // Handle file uploads (Audio and Video)
        document.getElementById('uploadAudio').onclick = function() {
            const audioFile = document.getElementById('audioFileInput').files[0];
            if (audioFile) {
                // Handle audio file upload here (send to server)
                chatSocket.send(JSON.stringify({'audio': audioFile}));
                document.getElementById('audioUploadModal').classList.add('hidden');
            }
        };

        document.getElementById('uploadVideo').onclick = function() {
            const videoFile = document.getElementById('videoFileInput').files[0];
            if (videoFile) {
                // Handle video file upload here (send to server)
                chatSocket.send(JSON.stringify({'video': videoFile}));
                document.getElementById('videoUploadModal').classList.add('hidden');
            }
        };

        // Send the message when the Send button is clicked
        document.getElementById('sendMessage').onclick = function(e) {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value;
            if (message.trim()) {
                chatSocket.send(JSON.stringify({'message': message}));
                messageInput.value = '';  // Clear the input
            }
        };

        // Allow the Enter key to send the message
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('sendMessage').click();
            }
        });


           // Handle WebSocket connection closing
           chatSocket.onclose = function(e) {
            console.log('WebSocket connection closed.');
        };

        // Send the message when the Send button is clicked
        document.getElementById('sendMessage').onclick = function(e) {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value;
            if (message.trim()) {
                chatSocket.send(JSON.stringify({'message': message}));
                messageInput.value = '';  // Clear the input
            }
        };

        // Allow the Enter key to send the message
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('sendMessage').click();
            }
        });

        // Open the mention modal when the "Mention User" button is clicked
        document.getElementById('mentionButton').onclick = function() {
            // Fetch the members from the organization
            fetch(`/channels/get_organization_members/{{ channel.organization.id }}/`)

                .then(response => response.json())
                .then(data => {
                    const mentionList = document.getElementById('mentionList');
                    mentionList.innerHTML = '';  // Clear existing list
                    data.members.forEach(member => {
                        const listItem = document.createElement('li');
                        listItem.className = 'cursor-pointer text-blue-500 hover:underline';
                        listItem.textContent = member.username;
                        listItem.onclick = function() {
                            const messageInput = document.getElementById('messageInput');
                            messageInput.value += `@${member.username} `; // Append mention to input
                            document.getElementById('mentionModal').classList.add('hidden');
                        };
                        mentionList.appendChild(listItem);
                    });
                    document.getElementById('mentionModal').classList.remove('hidden');
                });
        };

        // Close the mention modal when the "Close" button is clicked
        document.getElementById('closeMentionModal').onclick = function() {
            document.getElementById('mentionModal').classList.add('hidden');
        };

        // Open the send link modal when the "Send Link" button is clicked
        document.getElementById('sendLinkButton').onclick = function() {
            document.getElementById('sendLinkModal').classList.remove('hidden');
        };

        // Close the send link modal when the "Cancel" button is clicked
        document.getElementById('closeLinkModal').onclick = function() {
            document.getElementById('sendLinkModal').classList.add('hidden');
        };

        // Send the link when the "Send Link" button in the modal is clicked
        document.getElementById('sendLink').onclick = function() {
            const linkText = document.getElementById('linkText').value;
            const linkUrl = document.getElementById('linkUrl').value;
            if (linkText.trim() && linkUrl.trim()) {
                chatSocket.send(JSON.stringify({'linkText': linkText, 'linkUrl': linkUrl}));
                document.getElementById('linkText').value = '';  // Clear the link text input
                document.getElementById('linkUrl').value = '';   // Clear the link URL input
                document.getElementById('sendLinkModal').classList.add('hidden');
            }
        };

// -----------------------------------------------------------------------------------------------------------------------------------------------------------------





document.getElementById('userListButton').onclick = function () {
    const orgId = "{{ channel.organization.id }}"; // Organization ID from Django template
    const channelId = "{{ channel.id }}"; // Channel ID from Django template

    // Make an AJAX request to fetch users associated with the channel
    fetch(`/channels/channels/get_members/${orgId}/${channelId}/`)
        .then(response => response.json())
        .then(data => {
            const userList = document.getElementById('userList');
            userList.innerHTML = ''; // Clear existing user list

            if (data.members && data.members.length > 0) {
                // Populate the user list with members
                data.members.forEach(user => {
                    const listItem = document.createElement('li');
                    listItem.className = 'list-group-item cursor-pointer text-primary';
                    listItem.textContent = user.username; // Display the username
                    userList.appendChild(listItem);
                });
            } else {
                // Handle case when no users are found
                const noUsersItem = document.createElement('li');
                noUsersItem.className = 'list-group-item text-danger';
                noUsersItem.textContent = "No users found!";
                userList.appendChild(noUsersItem);
            }

            // Show the modal using Bootstrap 5's modal JavaScript
            const modal = new bootstrap.Modal(document.getElementById('userListModal'));
            modal.show();
        })
        .catch(error => {
            console.error('Error fetching users:', error);
        });
};



// Fetch activity logs

document.getElementById('fetchLogsButton').onclick = function() {
    const channelId = "{{ channel.id }}";  // Channel ID from Django template
    const orgId = "{{channel.organization.id}}";

    // Make an AJAX request to fetch activity logs
    fetch(`/channels/channels/fetch_activity_logs/${channelId}/${orgId}`)
        .then(response => response.json())
        .then(data => {
            const logsList = document.getElementById('activityLogsList');
            logsList.innerHTML = '';  // Clear existing logs

            if (data.success) {
                // If logs are found, populate the modal with them
                data.logs.forEach(log => {
                    const logItem = document.createElement('div');
                    logItem.className = 'list-group-item list-group-item-action';
                    logItem.innerHTML = `
                        <strong>${log.user}</strong> ${log.content} 
                        <span class="text-muted text-sm">(${log.timestamp})</span>
                    `;
                    logsList.appendChild(logItem);
                });

                // Show the modal
                var myModal = new bootstrap.Modal(document.getElementById('activityLogsModal'));
                myModal.show();
            } else {
                const noLogsItem = document.createElement('div');
                noLogsItem.className = 'list-group-item text-center text-muted';
                noLogsItem.textContent = "No activity logs found.";
                logsList.appendChild(noLogsItem);
            }
        })
        .catch(error => {
            console.error('Error fetching activity logs:', error);
        });
};



// SEARCH BAR 

document.getElementById('searchInput').addEventListener('input', function () {
    const query = this.value.trim(); // Get the search input
    const orgId = "{{ channel.organization.id }}"; // Pass organization ID dynamically
    const channelId = "{{ channel.id }}"; // Pass channel ID dynamically

    // AJAX request to fetch filtered messages and links
    fetch(`/channels/channels/search/${orgId}/${channelId}/?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
            const chatWindow = document.getElementById('chatWindow');
            chatWindow.innerHTML = ''; // Clear the chat window

            // Display filtered messages
            if (data.messages.length > 0) {
                data.messages.forEach(message => {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'border-b py-2';
                    messageDiv.innerHTML = `
                        <strong>${message.user__username}</strong>: ${message.content}
                        <span class="text-sm text-gray-500 ml-2">${message.timestamp}</span>
                    `;
                    chatWindow.appendChild(messageDiv);
                });
            }

            // Display filtered links
            if (data.links.length > 0) {
                data.links.forEach(link => {
                    const linkDiv = document.createElement('div');
                    linkDiv.className = 'border-b py-2';
                    linkDiv.innerHTML = `
                        <strong>${link.user__username}</strong>: 
                        <a href="${link.link}" target="_blank" class="text-blue-500 hover:underline">${link.text}</a>
                        <span class="text-sm text-gray-500 ml-2">${link.timestamp}</span>
                    `;
                    chatWindow.appendChild(linkDiv);
                });
            }

            // If no results found
            if (data.messages.length === 0 && data.links.length === 0) {
                chatWindow.innerHTML = '<p class="text-center text-gray-500">No results found!</p>';
            }
        })
        .catch(error => {
            console.error('Error fetching search results:', error);
        });
});


// CHANNEL DETAILS
document.getElementById('viewChannelDetailsButton').onclick = function() {
    const channelId = "{{ channel.id }}";  // Get channel ID dynamically from the template
    const orgId = "{{ channel.organization.id }}";  // Get organization ID dynamically from the template

    // Make an AJAX request to fetch channel details
    fetch(`/channels/channels/channel_details/${orgId}/${channelId}/`)
        .then(response => response.json())
        .then(data => {
            // Update the modal with the fetched data
            document.getElementById('channelName').textContent = data.name;
            document.getElementById('channelType').textContent = data.type;
            document.getElementById('channelVisibility').textContent = data.visibility;
            document.getElementById('channelCreatedAt').textContent = data.created_at;
            document.getElementById('channelCreatedBy').textContent = data.created_by;

            // Clear existing members
            const membersList = document.getElementById('membersList');
            membersList.innerHTML = '';

            // Add members to the list
            data.members.forEach(member => {
                const memberItem = document.createElement('li');
                memberItem.textContent = member.full_name;
                membersList.appendChild(memberItem);
            });

            // Show the modal using Bootstrap 5 without jQuery
            var modal = new bootstrap.Modal(document.getElementById('channelDetailsModal'));
            modal.show();
        })
        .catch(error => {
            console.error('Error fetching channel details:', error);
        });
};


// Exporting data pop up

document.getElementById('exportDataButton').onclick = function(event) {
    // Prevent the default action (navigating to the export page)
    event.preventDefault();

    // Show the popup message
    const popupMessage = document.getElementById('popupMessage');
    popupMessage.style.display = 'block';

    // Hide the popup after 5 seconds
    setTimeout(function() {
        popupMessage.style.display = 'none';

        // Redirect to the export data URL after the message disappears
        window.location.href = event.target.href;
    }, 3000);
};


// CHANNEL STATISTICS

 // Event listener for showing the modal
document.getElementById('statisticsModal').addEventListener('show.bs.modal', function () {
    // Fetch the org_id and channel_id dynamically, you can pass them from the context
    var org_id = "{{channel.organization.id}}";  // Replace with dynamic org_id
    var channel_id = "{{channel.id}}";  // Replace with dynamic channel_id

    // Make the AJAX request
    fetch(`/channels/channel/statistics/${org_id}/${channel_id}/`, { // Adjust the URL if necessary
      method: 'GET',
    })
    .then(response => response.json())
    .then(data => {
      if (data.error) {
        alert('Error fetching data: ' + data.error);
      } else {
        // Render the charts
        renderCharts(data);
      }
    })
    .catch(() => {
      alert('An error occurred while fetching the statistics.');
    });
});

// Function to render the charts with data from the response
function renderCharts(data) {
    // Messages Chart
    var ctxMessages = document.getElementById('messagesChart').getContext('2d');
    var messagesChart = new Chart(ctxMessages, {
      type: 'bar',
      data: {
        labels: data.message_chart.labels,
        datasets: [{
          label: data.message_chart.label,
          data: data.message_chart.data,
          backgroundColor: data.message_chart.background_color,
          borderColor: data.message_chart.border_color,
          borderWidth: data.message_chart.border_width
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });

    // Links Chart
    var ctxLinks = document.getElementById('linksChart').getContext('2d');
    var linksChart = new Chart(ctxLinks, {
      type: 'bar',
      data: {
        labels: data.link_chart.labels,
        datasets: [{
          label: data.link_chart.label,
          data: data.link_chart.data,
          backgroundColor: data.link_chart.background_color,
          borderColor: data.link_chart.border_color,
          borderWidth: data.link_chart.border_width
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });

    // User Message Counts Chart
    var ctxUserMessageCounts = document.getElementById('userMessageCountsChart').getContext('2d');
    var userMessageCountsChart = new Chart(ctxUserMessageCounts, {
      type: 'pie',
      data: {
        labels: data.user_message_counts.map(item => item.user),
        datasets: [{
          label: 'User Message Counts',
          data: data.user_message_counts.map(item => item.message_count),
          backgroundColor: ['rgba(75, 192, 192, 0.2)', 'rgba(153, 102, 255, 0.2)', 'rgba(255, 159, 64, 0.2)', 'rgba(54, 162, 235, 0.2)'],
          borderColor: ['rgba(75, 192, 192, 1)', 'rgba(153, 102, 255, 1)', 'rgba(255, 159, 64, 1)', 'rgba(54, 162, 235, 1)'],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true
      }
    });

    // User Link Counts Chart
    var ctxUserLinkCounts = document.getElementById('userLinkCountsChart').getContext('2d');
    var userLinkCountsChart = new Chart(ctxUserLinkCounts, {
      type: 'pie',
      data: {
        labels: data.user_link_counts.map(item => item.user),
        datasets: [{
          label: 'User Link Counts',
          data: data.user_link_counts.map(item => item.link_count),
          backgroundColor: ['rgba(75, 192, 192, 0.2)', 'rgba(153, 102, 255, 0.2)', 'rgba(255, 159, 64, 0.2)', 'rgba(54, 162, 235, 0.2)'],
          borderColor: ['rgba(75, 192, 192, 1)', 'rgba(153, 102, 255, 1)', 'rgba(255, 159, 64, 1)', 'rgba(54, 162, 235, 1)'],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true
      }
    });

    // Total Messages Chart (Bar chart)
    var ctxTotalMessages = document.getElementById('totalMessagesChart').getContext('2d');
    var totalMessagesChart = new Chart(ctxTotalMessages, {
      type: 'bar',
      data: {
        labels: ['Total Messages'],
        datasets: [{
          label: 'Total Messages',
          data: [data.total_messages],
          backgroundColor: 'rgba(75, 192, 192, 0.2)',
          borderColor: 'rgba(75, 192, 192, 1)',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });

    // Total Links Chart (Bar chart)
    var ctxTotalLinks = document.getElementById('totalLinksChart').getContext('2d');
    var totalLinksChart = new Chart(ctxTotalLinks, {
      type: 'bar',
      data: {
        labels: ['Total Links'],
        datasets: [{
          label: 'Total Links',
          data: [data.total_links],
          backgroundColor: 'rgba(153, 102, 255, 0.2)',
          borderColor: 'rgba(153, 102, 255, 1)',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });

    // King User Chart (Pie chart)
    var ctxKingUser = document.getElementById('kingUserChart').getContext('2d');
    var kingUserChart = new Chart(ctxKingUser, {
      type: 'pie',
      data: {
        labels: [data.king_user],
        datasets: [{
          label: 'King User Stats',
          data: [data.total_messages, data.total_links], // Data for the king user
          backgroundColor: ['rgba(255, 159, 64, 0.2)', 'rgba(54, 162, 235, 0.2)'],
          borderColor: ['rgba(255, 159, 64, 1)', 'rgba(54, 162, 235, 1)'],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true
      }
    });
}

</script>

   <!-- Add Bootstrap 5 JS just before the closing </body> tag -->
   <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

