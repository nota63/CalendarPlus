


{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ task.title }} - Task Details</title>
    <link rel="stylesheet" href="{% static 'assets/css/my_tasks.css' %}">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
    
   
  
<!-- FullCalendar CSS -->
<!-- FullCalendar CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.2/fullcalendar.min.css" />

<!-- jQuery (Required) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

<!-- FullCalendar JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.2/fullcalendar.min.js"></script>


     <!-- Tailwind CSS CDN -->
     <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
   
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
</head>

<style>
    /* üåü Calendar Container - Light Theme */
#calendar {
    background: #ffffff; /* Pure White Background */
    padding: 10px;
    border-radius: 8px;
    box-shadow: 0px 3px 10px rgba(0, 0, 0, 0.1);
}

/* üåü Toolbar & Buttons */
.fc-header-toolbar {
    background: #f5f5f5; /* Light Gray */
    padding: 8px;
    border-radius: 6px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.fc-button {
    background-color: #1976d2 !important; /* Material Blue */
    color: white !important;
    border-radius: 5px !important;
    padding: 5px 10px !important;
    font-size: 14px;
    transition: 0.2s ease-in-out;
}

.fc-button:hover {
    background-color: #1565c0 !important; /* Slightly Darker Blue */
}

/* üìÖ Thinner Calendar Days */
.fc-daygrid-day {
    background: #fafafa; /* Very Light Gray */
    border: 1px solid rgba(0, 0, 0, 0.05);
    height: 40px; /* Thinner Height */
}

/* üåü Current Day Highlight */
.fc-day-today {
    background: rgba(25, 118, 210, 0.15) !important;
    border: 1px solid #1976d2 !important;
    font-weight: bold;
}

/* üìÖ Event Styling - Material UI Look */
.fc-event {
    background: #42a5f5; /* Material Light Blue */
    color: white !important;
    border-radius: 4px;
    padding: 4px;
    font-size: 12px;
    font-weight: bold;
    transition: 0.2s ease-in-out;
}

/* üåü Hover Effect */
.fc-event:hover {
    background: #1e88e5;
    transform: scale(1.03);
    box-shadow: 0px 3px 8px rgba(0, 0, 0, 0.2);
}

/* ‚è∞ Week View - Thinner Slots */
.fc-timegrid-slot {
    background: #ffffff;
    border: 1px solid rgba(0, 0, 0, 0.05);
    height: 30px; /* Thinner Slots */
}

/* üåü Sidebar / Labels */
.fc-sidebar {
    background: #eeeeee;
    color: #424242;
    padding: 8px;
    border-radius: 6px;
}

/* Overall body styling */
body {
    font-family: 'Arial', sans-serif;
    background-color: #000; /* Pure black background */
    color: hsl(0, 100%, 1%); /* Light text color */
    margin: 0;
    padding: 0;
}

/* Task container styling */
.task-container {
    width: 90%; /* Increased width */
    max-width: 1400px; /* Maximum width */
    margin: 50px auto; /* Centering the container */
    padding: 30px;
    background-color: #000; /* Pure black background */
    box-shadow: 0 0 20px rgba(255, 255, 255, 0.2); /* Glowing effect */
    border-radius: 20px; /* Rounded corners */
    font-weight: bold; /* Bold text */
    font-size: 20px; /* Adjusted font size */
    border: 2px solid #333; /* Dark border */
    transition: all 0.3s ease; /* Smooth transition */
    position: relative;
    overflow: hidden;
}

/* Glowing border effect */
.task-container::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(45deg, #000, #000, #000, #000); /* Same color for pure black */
    background-size: 400% 400%;
    z-index: -1;
    animation: glowing-border 5s linear infinite; /* Glowing animation */
    border-radius: 20px;
}

/* Glowing effect animation */
@keyframes glowing-border {
    0% {
        background-position: 400% 0;
    }
    50% {
        background-position: 0 100%;
    }
    100% {
        background-position: 400% 0;
    }
}

/* Add hover effect with shine */
.task-container:hover {
    box-shadow: 0 0 25px rgba(255, 255, 255, 0.4); /* Shine effect */
    transform: translateY(-10px); /* Heavy lift on hover */
}

/* Styling the text inside the container */
.task-container p {
    font-size: 18px; /* Adjust paragraph text */
    color: #fff; /* Light text color for contrast */
}
/* Container with dark theme and stylish look */
.task-container {
    opacity: 0;
    transform: translateY(-100vh) scale(0.8); /* Starts from above the page */
    animation: slideInFromTop 1s ease-out forwards; /* Animation to slide in smoothly */
    border-radius: 30px; /* Rounded corners */
    padding: 20px;
    box-shadow: 0 0 25px rgba(255, 255, 255, 0.3), 0 0 50px rgba(255, 255, 255, 0.5); /* Glowing effect */
    background-color: #000; /* Dark theme background */
    color: white; /* White text for contrast */
    transition: transform 0.5s ease-in-out, box-shadow 0.5s ease-in-out; /* Smooth transition on hover */
}

/* Animation for smooth sliding from the top */
@keyframes slideInFromTop {
    0% {
        opacity: 0;
        transform: translateY(-100vh) scale(0.8); /* Starts from above the screen */
        box-shadow: 0 0 25px rgba(255, 255, 255, 0.3); /* Glowing starts softly */
    }
    60% {
        opacity: 0.6;
        transform: translateY(30px) scale(1.05); /* Moving towards its final position */
        box-shadow: 0 0 30px rgba(255, 255, 255, 0.4); /* Increased glow */
    }
    100% {
        opacity: 1;
        transform: translateY(0) scale(1); /* Fully in place, no scaling */
        box-shadow: 0 0 50px rgba(255, 255, 255, 0.7); /* Max glow effect */
    }
}

/* Hover effect to enhance the feel when the user interacts */
.task-container:hover {
    transform: scale(1.05);
    box-shadow: 0 0 60px rgba(255, 255, 255, 0.8), 0 0 120px rgba(255, 255, 255, 1);
}


       /* Import Google Fonts */
@import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');
@import url('https://fonts.googleapis.com/icon?family=Material+Icons');

/* Dark sidebar styling */
/* Dark sidebar styling */
.activity-logs-sidebar {
    position: fixed;
    top: 0;
    right: -400px;  /* Hidden initially */
    width: 400px;
    height: 100%;
    background-color: #333;
    color: white;
    font-family: 'Roboto', sans-serif;  /* Use Roboto font */
    transition: right 0.3s ease;
    z-index: 999;
    box-shadow: -5px 0 15px rgba(0, 0, 0, 0.5);
    overflow-y: auto; /* Enable vertical scrolling */
}

/* Sidebar content */
.sidebar-content {
    padding: 15px;
    overflow-y: auto;
}

/* Activity logs container */
.activity-logs-container {
    max-height: calc(100% - 100px);
    overflow-y: auto;
    margin-top: 10px;
}

/* Individual activity log item */
.activity-log {
    margin-bottom: 12px;
    padding: 12px;
    background-color: #444;
    border-radius: 5px;
    font-size: 14px;  /* Smaller font size */
    font-family: 'Roboto', sans-serif;
}

/* Title of activity log */
.activity-log h5 {
    margin: 0;
    font-weight: 500;
    font-size: 16px;  /* Reduced title font size */
    color: #FFD700;  /* Gold color for the title */
}

/* Description of activity log */
.activity-log p {
    margin: 5px 0;
    color: #ddd;  /* Lighter color for description */
    font-weight: 400;
    font-size: 13px;  /* Reduced font size for description */
}

/* Button to close the sidebar */
#closeSidebarButton {
    background-color: #f8f9fa;
    border: none;
    color: #333;
    font-size: 16px;  /* Slightly reduced button font size */
    padding: 8px 12px;
    border-radius: 5px;
    font-weight: 600;
    font-family: 'Roboto', sans-serif;
}

/* Bu
/* Material Icon for activity log button */
#activityLogsButton i {
    font-size: 16px;  /* Smaller size for the icon */
}

/* When sidebar is open, bring it to the right */
.activity-logs-sidebar.open {
    right: 0;
}

/* Apply hover effects for buttons */
#activityLogsButton:hover {
    background-color: #0056b3;
    cursor: pointer;
}

#closeSidebarButton:hover {
    background-color: #e2e6ea;
    curs.form-check-input {
    width: 50px;
    height: 25px;
    background-color: #ccc;
    border: none;
    transition: background-color 0.3s ease;
}

.form-check-input:checked {
    background-color: #28a745; /* Green when checked */
}

.form-check-label {
    margin-left: 10px;
    font-size: 14px;
    color: #333;
}
or: pointer;
}


/* Style for the tag container and tags */
.badge.bg-warning {
    font-size: 0.85rem;  /* Reduces font size */
    padding: 0.4rem 0.6rem;  /* Adjusts padding to make the tag smaller */
    border-radius: 12px;  /* Adds rounded corners */
    margin-right: 5px;  /* Adds spacing between tags */
    margin-bottom: 5px;  /* Adds spacing below tags */
}

/* Style for the remove button inside the tag */
.badge.bg-warning button.remove-tag {
    font-size: 0.75rem;  /* Reduces the size of the remove button */
    padding: 0.2rem 0.4rem;  /* Adjusts padding of the button */
    margin-left: 8px;  /* Adds space between the tag text and the button */
    border-radius: 50%;  /* Makes the remove button circular */
    background-color: #dc3545;  /* Red background for the remove button */
    color: white;  /* White text color */
    border: none;  /* Removes button border */
    transition: background-color 0.3s ease;  /* Smooth transition for hover effect */
}

.badge.bg-warning button.remove-tag:hover {
    background-color: #c82333;  /* Darker red on hover */
    cursor: pointer;  /* Changes cursor to pointer on hover */
}
/* Style for the add tag button */
#add-tag-btn {
    font-size: 0.9rem;  /* Reduces font size for a smaller button */
    padding: 0.3rem 0.5rem;  /* Adjusts padding to make the button smaller */
    border-radius: 25px;  /* Makes the button more rounded */
    background-color: #28a745;  /* Green color for the add button */
    color: white;  /* White text color */
    border: none;  /* No border */
    transition: background-color 0.3s ease;  /* Smooth transition for hover effect */
}

#add-tag-btn:hover {
    background-color: #218838;  /* Darker green on hover */
    cursor: pointer;  /* Pointer cursor on hover */
}

/* Style for the 'No tags' message */
.badge.bg-secondary {
    font-size: 0.85rem;
    padding: 0.4rem 0.6rem;
    border-radius: 12px;
    background-color: #6c757d;  /* Gray background for 'No tags' */
    color: white;
}

/* Stopwatch Container */
#stopwatch-container {
    background-color: #121212;  /* Black background */
    padding: 15px 25px;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
    max-width: 200px;
    max-height: 170px;
    text-align: center;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    border: 2px solid transparent;  /* Transparent border to start */
    position: relative;
    transition: border-color 0.5s ease, box-shadow 0.5s ease;
}

/* Glowing Border Effect */
#stopwatch-container:hover {
    border-color: #00bfff;  /* Light blue border */
    box-shadow: 0 4px 15px rgba(0, 191, 255, 0.7);  /* Glow effect */
}

/* Time Display */
#time-display {
    font-size: 20px;  /* Medium time display */
    font-weight: bold;
    color: #00bfff;  /* Light blue color */
    letter-spacing: 1px;
    transition: all 0.3s ease;
}

/* Button Styling */
#start-stop-btn, #save-time-btn {
    padding: 8px 18px;
    font-size: 14px;
    border-radius: 5px;
    margin: 5px;
    cursor: pointer;
    transition: transform 0.2s ease, background-color 0.3s ease;
    border: none;
    outline: none;
}

#start-stop-btn {
    background-color: #007bff;  /* Blue button */
    color: white;
}

#start-stop-btn:hover {
    background-color: #0056b3;  /* Darker blue on hover */
    transform: scale(1.05);
}

#save-time-btn {
    background-color: #28a745; /* Green button */
    color: white;
    display: none; /* Initially hidden */
}

#save-time-btn:hover {
    background-color: #218838; /* Darker green on hover */
    transform: scale(1.05);
}

/* Smooth Time Change Transition */
@keyframes timeChange {
    0% {
        transform: scale(1);
        color: #00bfff;
    }
    50% {
        transform: scale(1.1);
        color: #ff9800;  /* Orange momentary effect */
    }
    100% {
        transform: scale(1);
        color: #00bfff;
    }
}

#time-display.animate-time {
    animation: timeChange 0.5s ease-in-out;  /* Smooth transition */
}

/* Optional - For Stopwatch's Start/Stop Button Toggle */
#stopwatch-container .btn {
    transition: all 0.3s ease;
}
#problemsSidebar .offcanvas-body {
    background-color: #f8f9fa; /* Light gray background */
    color: #343a40; /* Dark gray text */
    padding: 1.5rem;
}

#problemsSidebar {
    border-left: 1px solid #ddd;
}

#problems-content ul {
    list-style-type: none;
    padding: 0;
}

#problems-content li {
    padding: 0.5rem 0;
    border-bottom: 1px solid #ddd;
}


/* problem sidebar styles */
/* Importing Google Fonts */
@import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap');

/* Basic Reset */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

/* Sidebar Style */
#problemsSidebar {
    background-color: #2C2C2C; /* Darker background for the sidebar */
    color: white;  /* White text for visibility */
    font-family: 'Roboto', sans-serif;  /* Google Font */
    padding: 15px;
    font-size: 0.9rem;  /* Slightly smaller font size */
    max-width: 400px;  /* Optional: Set a max-width for the sidebar */
    border-left: 3px solid #ffcc00; /* Golden left border for the sidebar */
}

#problemsSidebarLabel {
    color: white;  /* Sidebar header text color */
    font-weight: 500;  /* Bold for the title */
    font-size: 1.2rem; /* Larger font size for the header */
    margin-bottom: 15px; /* Add spacing between the header and the content */
}

#problems-list {
    list-style: none;
    padding-left: 0;
    margin-top: 20px;
}

#problems-list li {
    background-color: #3E3E3E;  /* Slightly lighter dark background for each problem */
    margin: 5px 0;
    padding: 12px;
    border-radius: 5px;
    font-size: 0.9rem;  /* Default font size for the list items */
    color: white;  /* White text for list items */
    border-bottom: 1px solid #444444; /* Subtle border for each list item */
}

/* Add a hover effect for each list item */
#problems-list li:hover {
    background-color: #4a4a4a;
    cursor: pointer;
}

/* For strong text inside list items */
#problems-list li strong {
    color: #ffcc00; /* Golden color for names and important text */
}

/* Responsive Design */
@media (max-width: 768px) {
    #problemsSidebar {
        font-size: 0.85rem;  /* Slightly smaller font size on mobile */
    }
}



/* styles for spinner */
/* Spinner and loading text container */
#loading-spinner {
    display: none;
    width: 40px;
    height: 40px;
    border: 4px solid #f3f3f3; /* Light background */
    border-top: 4px solid #007bff; /* Blue color for the spinner */
    border-radius: 50%;
    animation: spin 2s linear infinite;
}

#loading-text {
    display: none;
    font-size: 16px;
    font-weight: 500;
    color: #007bff; /* Match the blue of the spinner */
    margin-left: 10px;
    vertical-align: middle;
    font-family: 'Roboto', sans-serif;
}

/* Animation for spinner */
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Additional premium feel for the form button and text */
#raise-problem-btn {
    position: relative;
    padding-right: 50px; /* Space for the spinner */
    transition: all 0.3s ease-in-out;
}

#raise-problem-btn:disabled {
    background-color: #d6d6d6;
    cursor: not-allowed;
}

/* Optionally, add a hover effect on the button */
#raise-problem-btn:hover {
    background-color: #e03e3e;
    color: #fff;
}

/* You can also center the spinner and text vertically */
.spinner-container {
    display: flex;
    align-items: center;
}

.dropdown-toggle {
    background: none;
    border: none;
    font-size: 20px;
    cursor: pointer;
    color: #6c757d; /* Subtle gray for premium look */
}

.dropdown-menu {
    border-radius: 5px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.dropdown-item:hover {
    background-color: #28a745; /* Match "success" button color */
    color: white;
}

/* Spinner container */
.loading-spinner {
    display: none;
    text-align: center;
    font-size: 14px;
    color: #007bff; /* Blue color for the spinner text */
}

/* Spinner animation */
.loading-spinner .spinner-border {
    width: 2rem;
    height: 2rem;
    border-width: 0.25em;
    animation: spin 1s linear infinite;
}

/* Spinner spin animation */
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Styling the 'Reporting to manager...' text */
.loading-spinner span {
    margin-left: 10px;
    font-size: 14px;
    font-weight: bold;
    color: #007bff;
}

/* jsonresponse notification */
/* Notification container */
.notification {
    display: none; /* Hidden by default */
    position: fixed;
    top: -70px; /* Initially off-screen */
    left: 50%;
    transform: translateX(-50%);
    padding: 10px 20px;
    background-color: #1e90ff; /* Light blue background */
    color: #fff;
    font-size: 16px;
    font-family: 'Montserrat', sans-serif;
    font-weight: 500;
    border-radius: 8px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    z-index: 9999;
    opacity: 0;
    transition: all 0.6s ease-out; /* Ultra smooth transition */
    text-align: center;
    letter-spacing: 1px; /* Add some spacing for a more premium look */
    text-transform: capitalize;
}

/* To show the notification with smooth animation */
.notification.show {
    display: block;
    top: 20px; /* Slide into view */
    opacity: 1; /* Fade in */
    transform: translateX(-50%) translateY(20px); /* Smooth upward motion */
}

/* Shiny text effect */
.notification .text {
    position: relative;
    animation: shine 1.5s ease-in-out infinite;
}

/* Shiny text animation */
@keyframes shine {
    0% {
        background-position: -200% center;
    }
    100% {
        background-position: 200% center;
    }
}

.notification .text {
    background: linear-gradient(90deg, rgba(255, 255, 255, 0) 25%, rgba(255, 255, 255, 0.6) 50%, rgba(255, 255, 255, 0) 75%);
    background-size: 200% 100%;
    -webkit-background-clip: text;
    color: transparent;
}

/* Close button for the notification */
.notification .close-btn {
    background-color: transparent;
    border: none;
    color: white;
    font-size: 20px;
    font-weight: bold;
    position: absolute;
    top: 8px;
    right: 15px;
    cursor: pointer;
    transition: transform 0.3s ease;
}

/* Hover effect for the close button */
.notification .close-btn:hover {
    transform: rotate(90deg); /* Subtle rotation on hover */
}

/* Styling for the success message */
.notification.success {
    background-color: #1e90ff; /* Light blue background */
    border-left: 5px solid #0f7bcc; /* Darker blue border for a professional touch */
}

/* Optional: Styling for info messages */
.notification.info {
    background-color: #17a2b8; /* Info background (Blue) */
    border-left: 5px solid #117a8b; /* Darker blue border */
}

/* Optional: Styling for warning messages */
.notification.warning {
    background-color: #ffc107; /* Yellow background for warning */
    border-left: 5px solid #e0a800; /* Dark yellow border */
}

/* Greeting */
 /* Base styling for the greeting */
#greeting {
    position: fixed;
    top: 0;
    left: 0;
    transform: translateX(0);
    padding: 20px 40px;
    font-size: 1.5rem;
    font-weight: 700;
    background-color: rgba(0, 0, 0, 0.8);
    color: transparent;
    background-clip: text; /* Clips the background to the text */
    -webkit-background-clip: text; /* For Safari support */
    width: auto;
    z-index: 1000; /* Ensure it stays on top */
    border-radius: 8px;
    opacity: 0; /* Initially hidden for animation */
    animation: slideIn 1s ease-out forwards, fadeIn 1s ease-out forwards;
    font-family: 'Poppins', sans-serif, 'Arial'; /* Modern font */
}

/* Gradient effect for the text */
#greeting {
    background-image: linear-gradient(to right, #00c6ff, #ff6ec7); /* Light blue to pink gradient */
    font-size: 2.5rem; /* Increase font size for more impact */
}

/* Slide in animation */
@keyframes slideIn {
    0% {
        top: -50px;
        opacity: 0;
    }
    100% {
        top: 0;
        opacity: 1;
    }
}

/* Fade-in animation */
@keyframes fadeIn {
    0% {
        opacity: 0;
    }
    100% {
        opacity: 1;
    }
}

body {
    margin: 0; /* Remove margin for better layout */
    font-family: 'Arial', sans-serif; /* Modern font */
    background-color: hsl(240, 3%, 6%); /* Subtle background color for contrast */
}

/* Add a modern font and responsive design */
@media (max-width: 600px) {
    #greeting {
        font-size: 1.5rem; /* Make the text smaller on small screens */
    }
}

#current-date {
    position: fixed;
    top: 10px;
    right: 10px;  /* Position at top-right */
    font-size: 1.4rem;  /* Adjusted size for better readability */
    font-weight: 700;  /* Bold font */
    background-color: rgba(0, 0, 0, 0.7);  /* Slightly darker background */
    color: hsl(175, 87%, 50%);  /* White text color */
    padding: 10px 15px;  /* Padding around the text */
    border-radius: 8px;  /* Rounded corners */
    z-index: 1000;
    font-family: 'Poppins', sans-serif;  /* Modern font */
    letter-spacing: 0.5px;  /* Small letter spacing for better clarity */
    text-align: center;  /* Center the text */
}

/* Optional: Animation for the date when the page loads */
@keyframes fadeInDate {
    0% {
        opacity: 0;
        transform: translateY(-10px);
    }
    100% {
        opacity: 1;
        transform: translateY(0);
    }
}

#current-date {
    animation: fadeInDate 0.8s ease-out forwards;  /* Fade-in and slide-up animation */
}






/* Progress Bar Container */
.progress {
    height: 20px;
    border-radius: 15px;
    background-color: #f1f1f1;
    margin-bottom: 20px;
    box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.1);
}

/* Progress Bar Inner */
.progress-bar {
    height: 100%;
    text-align: center;
    line-height: 20px;
    font-weight: bold;
    color: #fff;
    border-radius: 15px;
    transition: width 0.5s ease-in-out, background-color 0.5s ease;
}

/* Progress Bar Colors Based on Progress */
.progress-bar.bg-success {
    background: linear-gradient(90deg, #00b4d8, #0077b6); /* Blue gradient for good progress */
}

.progress-bar.bg-warning {
    background: linear-gradient(90deg, #f39c12, #f1c40f); /* Yellow gradient for warning */
}

.progress-bar.bg-danger {
    background: linear-gradient(90deg, #e74c3c, #c0392b); /* Red gradient for poor progress */
}

/* Tooltip on Hover (for Progress Bar) */
.progress-bar:hover {
    cursor: pointer;
    opacity: 0.9;
    box-shadow: 0 0 8px rgba(0, 0, 0, 0.2);
}


@import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');

#comments-list {
    list-style: none;
    padding: 0;
}

#comments-list li {
    font-family: 'Roboto', sans-serif;
    font-size: 0.875rem; /* Smaller font size */
    margin-bottom: 1rem;
}

#comments-list strong {
    font-weight: 700;
}

.comment-text {
    display: block;
    font-size: 1rem; /* Slightly increased font size */
    color: #fff; /* White color for highlight */
}

.dropdown-toggle::after {
    display: none; /* Remove default arrow */
}

.dropdown-menu {
    font-size: 0.75rem; /* Smaller font size */
}

.dropdown-item {
    font-size: 0.75rem; /* Smaller font size */
    padding: 0.25rem 1rem;
}

.dropdown-item:hover {
    background-color: #f8f9fa;
}

.btn-sm {
    font-size: 0.75rem; /* Smaller font size */
    padding: 0.25rem 0.5rem;
}

#comments-list span {
    display: block;
    font-size: 0.75rem; /* Smaller font size */
    color: #777;
}

@import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');

#taskNotesList {
    font-family: 'Roboto', sans-serif;
}

</style>
<body>
    
   
<!-- greeting -->
<div id="greeting"></div>


<div id="current-date"></div>
<br>
<br>

    

<!-- PREMIUM MODALS TASKS EXTEND APP  ----------------------------------------------------------------------------------------------->
<!-- FETCH AND MANAGE THE ATTACHMENTS  -->
<!-- ü™ü Premium Attachments Modal -->
<div class="modal fade" id="premiumAttachmentsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg max-w-4xl mx-auto p-4">
        <div class="modal-content border-0 bg-white/70 backdrop-blur-lg rounded-2xl shadow-2xl overflow-hidden">
            <!-- Modal Header -->
            <div class="modal-header bg-white/40 px-6 py-4 border-b border-gray-200/50">
                <div class="flex items-center space-x-3">
                    <span class="material-icons-round text-2xl text-blue-600">folder_open</span>
                    <h5 class="modal-title text-xl font-semibold text-gray-800">Task Attachments</h5>
                </div>
                <button type="button" class="btn-close p-2 hover:bg-gray-100/50 rounded-full transition-all" data-bs-dismiss="modal" aria-label="Close">
                    <span class="material-icons-round text-gray-500">close</span>
                </button>
            </div>

            <!-- Modal Body -->
            <div class="modal-body p-0">
                <div id="attachmentsContainer" class="overflow-y-auto max-h-[60vh]">
                    <!-- Content will be injected here -->
                    <div class="p-6 text-center text-gray-500">
                        <div class="animate-pulse">
                            <span class="material-icons-round text-4xl text-gray-400 mb-2">downloading</span>
                            <p class="text-sm">Fetching files...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="modal-footer bg-white/40 px-6 py-4 border-t border-gray-200/50">
                <button type="button" class="px-5 py-2.5 bg-transparent hover:bg-gray-100/50 text-gray-600 rounded-lg font-medium transition-all flex items-center space-x-2" data-bs-dismiss="modal">
                    <span class="material-icons-round text-lg">arrow_back</span>
                    <span>Close Panel</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- CUSTOM QUERY MODAL  -->
<!-- CUSTOM QUERY MODAL -->
<div class="modal fade" id="queryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content backdrop-blur-sm bg-white/90 border border-white/20 rounded-xl shadow-2xl">
        <div class="modal-header p-6 border-b border-white/20">
          <div class="flex-1">
            <h5 class="modal-title text-2xl font-semibold text-gray-800 mb-1">
              <span class="material-icons text-primary align-middle mr-2">contact_support</span>
              Task Query
            </h5>
            <div class="flex items-center gap-2">
              <p class="text-sm text-gray-500 mb-0">Free plan: {{queries}} used out of 45</p>
              <a href="#" class="text-primary hover:text-primary-dark text-sm font-medium transition-colors flex items-center">
                Upgrade to Pro
                <span class="material-icons text-base ml-1">arrow_forward</span>
              </a>
            </div>
          </div>
          <button type="button" class="btn-close p-2 hover:bg-gray-100/50 rounded-full transition-colors" data-bs-dismiss="modal" aria-label="Close">
            <span class="material-icons text-gray-500">close</span>
          </button>
        </div>
  
        <div class="modal-body p-6">
          <form id="queryForm" class="space-y-5">
            <input type="hidden" id="orgId">
            <input type="hidden" id="groupId">
            <input type="hidden" id="taskId">
  
            <!-- Subject Input -->
            <div class="space-y-1">
              <label class="text-sm font-medium text-gray-700">Subject</label>
              <div class="relative">
                <input type="text" id="querySubject" 
                       class="w-full px-4 py-2.5 rounded-lg border border-gray-300/80 focus:border-primary/80 focus:ring-2 focus:ring-primary/20 bg-white/50 backdrop-blur-sm placeholder-gray-400 transition-all"
                       placeholder="Enter subject"
                       required>
                <span class="material-icons text-gray-400 absolute right-3 top-3">title</span>
              </div>
            </div>
  
            <!-- Predefined Templates -->
            <div class="space-y-1">
              <label class="text-sm font-medium text-gray-700">Template (Optional)</label>
              <div class="relative">
                <select id="queryTemplate" 
                        class="w-full px-4 py-2.5 pr-10 rounded-lg border border-gray-300/80 focus:border-primary/80 focus:ring-2 focus:ring-primary/20 bg-white/50 backdrop-blur-sm appearance-none transition-all">
                  <option value="">Select a template...</option>
                  <option value="Can you clarify the task requirements?" class="flex items-center py-2">
                    <span class="material-icons text-base mr-2 text-gray-600">help_outline</span>
                    Clarify Requirements
                  </option>
                  <option value="What is the deadline for this task?" class="flex items-center py-2">
                    <span class="material-icons text-base mr-2 text-gray-600">schedule</span>
                    Deadline Inquiry
                  </option>
                  <option value="Do you have any reference materials?" class="flex items-center py-2">
                    <span class="material-icons text-base mr-2 text-gray-600">attachment</span>
                    Request References
                  </option>
                </select>
                <span class="material-icons text-gray-400 absolute right-3 top-3">expand_more</span>
              </div>
            </div>
  
            <!-- Custom Message -->
            <div class="space-y-1">
              <label class="text-sm font-medium text-gray-700">Message</label>
              <textarea id="queryMessage" 
                        class="w-full px-4 py-2.5 rounded-lg border border-gray-300/80 focus:border-primary/80 focus:ring-2 focus:ring-primary/20 bg-white/50 backdrop-blur-sm placeholder-gray-400 resize-y min-h-[120px] transition-all"
                        placeholder="Write your message here..."
                        required></textarea>
            </div>
  
            <!-- Loading Spinner -->
            <div id="queryLoading" class="hidden flex-col items-center justify-center space-y-2 py-4">
              <div class="animate-spin h-8 w-8 border-4 border-primary/30 border-t-primary rounded-full"></div>
              <p class="text-sm text-gray-500">Sending your query...</p>
            </div>
  
            <!-- Modal Footer -->
            <div class="modal-footer pt-6 border-t border-white/20">
              <button type="button" 
                      class="px-5 py-2.5 rounded-lg border border-gray-300/80 bg-white/50 hover:bg-gray-50/80 text-gray-600 transition-colors"
                      data-bs-dismiss="modal">
                Cancel
              </button>
              <button type="submit" 
                      class="px-5 py-2.5 rounded-lg bg-primary hover:bg-primary-dark text-white shadow-sm hover:shadow-md transition-all flex items-center">
                <span class="material-icons text-base mr-2">send</span>
                Send Query
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>


<!-- FULLCALENDAR MODAL  -->

<!-- FULLCALENDAR MODAL  -->
<div class="modal fade" id="fullCalendarModal" tabindex="-1" aria-labelledby="fullCalendarLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered max-w-[90%] xl:max-w-7xl">
        <div class="modal-content overflow-hidden bg-white/95 backdrop-blur-lg rounded-2xl shadow-2xl border border-white/20">
            <!-- Modal Header -->
            <div class="modal-header px-6 py-4 bg-gradient-to-r from-blue-50 to-indigo-50 border-b border-white/30">
                <div class="flex-1">
                    <h5 class="text-2xl font-semibold text-gray-800 mb-1">
                        Schedule Meeting: {{task.title}}
                    </h5>
                    <p class="text-sm text-gray-600 font-medium">
                        Available time slots for your manager - Select a slot to schedule
                    </p>
                </div>
                <button type="button" class="btn-close p-2 transition-all hover:bg-gray-100 rounded-lg" data-bs-dismiss="modal">
                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            <!-- Modal Body -->
            <div class="modal-body p-6">
                <div class="flex flex-col lg:flex-row gap-6">
                    <!-- Calendar Container -->
                    <div class="flex-1 bg-white/70 backdrop-blur-sm rounded-xl border border-white/30 shadow-lg p-4">
                        <div id="calendar" class="!h-[550px] [--fc-border-color:theme(colors.gray.200)]"></div>
                    </div>

                    <!-- Time Slots Container -->
                    <div class="w-full lg:w-96">
                        <div class="mb-4">
                            <h6 class="text-lg font-semibold text-gray-800 mb-2">Available Time Slots</h6>
                            <div id="timeSlots" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-2 gap-2"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="modal-footer px-6 py-4 bg-gray-50/80 border-t border-white/30">
                <div class="flex justify-end gap-3 w-full">
                    <button type="button" 
                            class="px-5 py-2 text-sm font-medium text-gray-700 hover:text-gray-900 bg-white hover:bg-gray-100 border border-gray-300 rounded-lg transition-all">
                        Close
                    </button>
                    <button id="proceedToSchedule" 
                            class="px-5 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-lg transition-all 
                                   disabled:opacity-50 disabled:pointer-events-none shadow-sm hover:shadow-md">
                        Schedule Meeting
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
<style>
    .fc {
    --fc-button-bg-color: #3b82f6;
    --fc-button-border-color: #3b82f6;
    --fc-button-hover-bg-color: #2563eb;
    --fc-button-hover-border-color: #2563eb;
    --fc-today-bg-color: #bfdbfe;
}
</style>







<!-- CONFIRM MEET MODAL -->
<!-- Confirmation Modal -->
<div class="modal fade" id="confirmMeetingModal" tabindex="-1" aria-labelledby="confirmMeetingLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-white rounded-2xl shadow-xl border border-gray-200">
            <!-- Modal Header -->
            <div class="modal-header border-b border-gray-200">
                <h5 class="modal-title text-lg font-semibold text-gray-800">Confirm Meeting</h5>
                <button type="button" class="btn-close text-gray-500 hover:text-gray-700" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <!-- Modal Body -->
            <div class="modal-body space-y-4 p-5">
                <p class="text-sm text-gray-600"><strong>Selected Date:</strong> <span id="selectedDate" class="text-gray-800"></span></p>
                <p class="text-sm text-gray-600"><strong>Selected Time Slot:</strong> <span id="selectedTime" class="text-gray-800"></span></p>

                <div>
                    <label for="meetingReason" class="block text-sm font-medium text-gray-700">Reason for Meeting:</label>
                    <select id="meetingReason" class="mt-1 w-full p-2 border border-gray-300 rounded-lg text-sm text-gray-700 focus:ring-2 focus:ring-indigo-400 focus:outline-none">
                        <option value="task_query">Task Queries</option>
                        <option value="facing_bug">Facing Bugs</option>
                        <option value="urgent_issue">Urgent Issue</option>
                        <option value="need_clarification">Need Clarification</option>
                        <option value="other">Other</option>
                    </select>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="modal-footer border-t border-gray-200 flex justify-end space-x-3 p-4">
                <button type="button" class="px-4 py-2 text-sm font-medium bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition" data-bs-dismiss="modal">Cancel</button>
                <button id="scheduleMeeting" class="px-4 py-2 text-sm font-medium bg-green-500 text-white rounded-lg hover:bg-green-600 transition">Schedule Meeting</button>
            </div>
        </div>
    </div>
</div>


<!-- show meeting details (existing) -->
 <!-- Meeting Details Modal -->
<div class="modal fade" id="meetingDetailsModal" tabindex="-1" aria-labelledby="meetingDetailsTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="meetingDetailsTitle">Meeting Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="meetingDetailsBody">
                <!-- Meeting details will be inserted dynamically -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>


<!-- CONVERSATION WITH MANAGER (LIVE) -->


<!-- COMMUNICATE MODAL  -->
 <!-- Chat Modal -->
 <div class="modal fade" id="taskChatModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered max-w-lg">
        <div class="modal-content rounded-xl shadow-2xl">
            <!-- Close Button -->
            <button type="button" class="absolute right-4 top-4 z-10 text-gray-500 hover:text-gray-700 transition-colors" data-bs-dismiss="modal">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>

            <!-- Search Input for Messages -->
          <div class="p-4">
                <input type="text" id="searchMessages" class="w-full p-2 border border-gray-300 rounded-lg" 
                  placeholder="Search messages..." onkeyup="searchMessages()">
             </div>

            <!-- Messages Container -->
            <div class="p-4">
                <div id="chatMessages" class="h-[400px] overflow-y-auto space-y-3 pr-2">
                    <!-- Messages will be loaded here -->
                    <p class="text-sm text-gray-500 text-center py-4">No messages found</p>
                </div>

                <!-- Input Area -->
                <div class="mt-4 flex gap-2">
                    <!-- File Input (hidden) -->
                    <input type="file" id="chatFileInput" class="hidden" />
                    
                    <!-- Attach File Button -->
                    <button onclick="document.getElementById('chatFileInput').click()" class="p-2 text-gray-500 hover:text-blue-600 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/>
                        </svg>
                    </button>

                    <!-- Message Input -->
                    <input type="text" id="chatMessageInput" 
                           class="flex-1 px-4 py-2 rounded-full border border-gray-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all"
                           placeholder="Type a message...">

                    <!-- Send Button -->
                    <button id="sendChatMessage" class="p-2 bg-blue-500 text-white rounded-full hover:bg-blue-600 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                        </svg>
                    </button>
                </div>

                <!-- Action Buttons -->
                <div class="mt-3 flex items-center gap-3">
                    <button id="deleteAllMessages" class="flex items-center gap-1.5 text-red-500 hover:text-red-600 text-sm">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                        </svg>
                        <span>Clear History</span>
                    </button>
                    
                    <button id="exportChat" class="flex items-center gap-1.5 text-gray-600 hover:text-gray-800 text-sm">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                        </svg>
                        <span>Export</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap');

body {
    font-family: 'Inter', -apple-system, sans-serif;
}

video::-webkit-media-controls-panel {
    background-image: linear-gradient(transparent, rgba(0,0,0,0.3));
}
/*CHAT MODAL  */
    #chatMessages::-webkit-scrollbar {
    width: 6px;
}

#chatMessages::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
}

#chatMessages::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 4px;
}

#chatMessages::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}
</style>


<!-- FILE PREVIEW MODAL -->
<!-- File Preview Modal -->
<div class="modal fade" id="filePreviewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered max-w-7xl h-[95vh]">
        <div class="modal-content rounded-xl shadow-2xl bg-white h-full">
            <!-- Close Button -->
            <button type="button" 
                    class="absolute right-4 top-4 z-50 p-2 text-gray-500 hover:text-gray-700 transition-colors"
                    data-bs-dismiss="modal">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>

            <!-- Preview Content -->
            <div class="h-full p-6">
                <div id="filePreviewContent" class="h-full w-full flex items-center justify-center overflow-y-auto">
                    <!-- Preview content will be injected here -->
                    <div class="text-gray-400 text-lg">Loading preview...</div>
                </div>
            </div>
        </div>
    </div>
</div>




















<!-- -------------------------------------------------------------------------------------------------------------------------- -->
<!-- Modal to add note -->
<div class="modal fade" id="addNoteModal" tabindex="-1" aria-labelledby="addNoteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addNoteModalLabel">Add Note</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <textarea id="noteText" class="form-control" rows="4" placeholder="Enter your note"></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="saveNoteButton">Save Note</button>
            </div>
        </div>
    </div>
</div>




<div class="modal fade" id="addTagModal" tabindex="-1" aria-labelledby="addTagModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addTagModalLabel">Add Tag</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Dropdown for predefined tags -->
        <select class="form-select" id="tag-select">
          <option value="">Select a tag</option>
          <option value="Important">Important</option>
          <option value="Urgent">Urgent</option>
          <option value="Low Priority">Low Priority</option>
          <option value="Completed">Completed</option>
        </select>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="save-tag-btn">Save Tag</button>
      </div>
    </div>
  </div>
</div>


<!-- Sidebar for displaying the problems  -->
<!-- Sidebar for Problems -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="problemsSidebar" aria-labelledby="problemsSidebarLabel">
    <div class="offcanvas-header">
        <h5 id="problemsSidebarLabel">Problems</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">

        <h5>Raise a Problem</h5>
        <form id="raise-problem-form">
            <div class="form-group">
                <label for="problem-description">Problem Description</label>
                <textarea id="problem-description" class="form-control" rows="4" placeholder="Describe the problem..."></textarea>
            </div>
            <button type="button" id="raise-problem-btn" data-org-id="{{ organization.id }}" data-group-id="{{ group.id }}" data-task-id="{{ task.id }}" class="btn btn-danger mt-3">Report Problem</button>


             <!-- Spinner for loading indication -->
           <!-- Spinner for loading indication -->
            <div id="loading-spinner" class="spinner-border text-primary" role="status" style="display: none;">
                 <span class="visually-hidden">Loading...</span>
             </div>
              <div id="loading-text" style="display: none;">Reporting the problem to manager...</div>
        </form>

        <ul id="problems-list">
            {% if problems %}
                {% for problem in problems %}
                    <li>
                        <strong>{{ problem.reported_by.username }}:</strong>
                        {{ problem.description }}
                        ({{ problem.created_at|date:"F j, Y, g:i a" }}) 
                        <strong>Is Resolved: {{ problem.is_resolved }}</strong>
                        
                        <!-- Three-dot menu -->
                        <div class="dropdown" style="display: inline-block; position: relative;">
                            <button class="btn btn-secondary dropdown-toggle" 
                                    type="button" 
                                    id="dropdownMenuButton{{ problem.id }}" 
                                    data-bs-toggle="dropdown" 
                                    aria-expanded="false"
                                    style="background: none; border: none; font-size: 20px; cursor: pointer;">
                                &#x22EE; <!-- Vertical ellipsis -->
                            </button>
                            <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton{{ problem.id }}">
                                <li>
                                    <button class="dropdown-item resolve-problem-btn" 
                                            data-org-id="{{ organization.id }}" 
                                            data-group-id="{{ group.id }}" 
                                            data-task-id="{{ task.id }}" 
                                            data-problem-id="{{ problem.id }}">
                                        Mark as Resolved
                                    </button>
                                </li>
                                <li id="loading-spinner-{{ problem.id }}" class="loading-spinner" style="display: none;">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="sr-only">Loading...</span>
                                    </div>
                                    <span>Reporting to manager...</span>
                                </li>
                            </ul>
                        </div>
                    </li>
                {% endfor %}
            {% else %}
                <span>No problems yet.</span>
            {% endif %}
        </ul>
        
    </div>
</div>


<!-- edit note modal -->
 <!-- Edit Note Modal -->
<div class="modal fade" id="editNoteModal" tabindex="-1" aria-labelledby="editNoteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editNoteModalLabel">Edit Note</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="editNoteForm">
            <div class="mb-3">
              <label for="noteContent" class="form-label">Note Content</label>
              <textarea class="form-control" id="noteContent" rows="3"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" id="saveNoteBtn">Save changes</button>
        </div>
      </div>
    </div>
  </div>
  
<!-- Modal for editing comments -->
<div class="modal fade" id="editCommentModal" tabindex="-1" aria-labelledby="editCommentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editCommentModalLabel">Edit Comment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <textarea id="commentContent" class="form-control" rows="4"></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveCommentBtn">Save Changes</button>
            </div>
        </div>
    </div>
</div>



<!-- --------------------------------------------------------------------------------------------------------------------------------------------------- -->
<style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    body {
        font-family: 'Inter', sans-serif;
    }
    
    .glass-card {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05), 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .progress-bar {
        transition: width 0.3s ease-in-out;
    }

    .activity-logs-sidebar {
        transform: translateX(100%);
        transition: transform 0.3s ease-in-out;
    }

    .activity-logs-sidebar.active {
        transform: translateX(0);
    }
</style>
</head>

<body class="bg-gray-50 min-h-screen p-6 font-['Roboto']">
    <!-- Notification -->
    <div id="notification" class="notification hidden fixed top-4 left-1/2 -translate-x-1/2 flex items-center gap-3 px-6 py-3 rounded-lg shadow-md border border-gray-200">
        <span id="notification-text" class="text-sm font-medium text-gray-700"></span>
        <button onclick="closeNotification()" class="material-icons-round text-gray-500 hover:text-gray-700 text-lg">close</button>
    </div>

    <div class="max-w-4xl mx-auto">
        <!-- Main Task Card -->
        <div class="bg-white rounded-xl shadow-sm p-6 mb-6 border border-gray-200">
            <!-- Task Header -->
            <div class="flex items-center gap-3 mb-6">
                <i class="bi bi-list-task text-2xl text-blue-600"></i>
                <h1 class="text-2xl font-bold text-gray-800">{{ task.title }}</h1>
            </div>

            <!-- Task Details -->
            <div class="grid gap-4 mb-6">
                <div>
                    <p class="font-medium text-gray-700 mb-1">Description</p>
                    <p class="text-gray-600">{{ task.description }}</p>
                </div>
                
                <div>
                    <p class="font-medium text-gray-700 mb-1">Priority</p>
                    <span class="inline-block px-3 py-1 bg-red-100 text-red-700 rounded-full text-sm">{{ task.priority }}</span>
                </div>
                
                <div>
                    <p class="font-medium text-gray-700 mb-1">Deadline</p>
                    <p class="text-gray-600">{{ task.deadline }}</p>
                </div>
            </div>

            <!-- Progress Section -->
              <!-- Progress Section -->
            <div class="mb-8">
                <div class="flex items-center justify-between mb-2">
                    <p class="text-sm font-medium text-gray-500">Progress</p>
                    <span class="text-sm font-medium text-blue-600">{{ task.progress }}%</span>
                </div>
                <div class="h-3 bg-gray-100 rounded-full overflow-hidden">
                    <div id="progressBar" class="h-full bg-blue-500 progress-bar" style="width: {{ task.progress }}%"
                    aria-valuenow="{{ task.progress }}" 
                    aria-valuemin="0" 
                    aria-valuemax="100">{{ task.progress }}%></div>
                </div>
                <div class="flex items-center gap-2 mt-3" id="progress-controls">
                    <button id="decreaseProgress" class="w-8 h-8 rounded-lg bg-gray-100 hover:bg-gray-200 flex items-center justify-center">
                        <span class="material-icons-round text-gray-600">remove</span>
                    </button>
                    <button id="increaseProgress" class="w-8 h-8 rounded-lg bg-blue-500 hover:bg-blue-600 flex items-center justify-center">
                        <span class="material-icons-round text-white">add</span>
                    </button>
                </div>
            </div>


            <!-- Action Buttons -->
            <div class="flex flex-wrap gap-3 mb-6">
                <button class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2"
                        data-bs-toggle="offcanvas" data-bs-target="#problemsSidebar" aria-controls="problemsSidebar">
                    <i class="bi bi-bug"></i>
                    View Problems
                </button>

                <button id="activityLogsButton" class="px-4 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-900 flex items-center gap-2">
                    <i class="bi bi-list-check"></i>
                    Activity Logs
                </button>

                <!-- COMMUNICATE WITH MANAGER -->
                <button class="btn btn-primary start-chat-btn" 
                data-org="{{ organization.id }}" 
                data-group="{{ group.id }}" 
                data-task="{{ task.id }}">
                üí¨ Start Chat
              </button>
          
          

                <!-- MANAGE ATTACHEMENTS (PREMIUM) -->
                 {% if extend_tasks%}
                   <button class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2" 
                     data-bs-toggle="modal" 
                     data-bs-target="#premiumAttachmentsModal" 
                     data-org-id="{{ org_id }}" 
                     data-group-id="{{ group.id }}" 
                     data-task-id="{{ task.id }}">
                     Manage Attachments
                     <i class="bi bi-bug"></i>
                   </button>

                   <!-- write custom email -->
                   <button class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2" 
                   data-bs-toggle="modal" 
                   data-bs-target="#queryModal"
                   data-org-id="{{ org_id }}" 
                   data-group-id="{{ group.id }}" 
                   data-task-id="{{ task.id }}">
                  üì© Send Query
              </button>
              <!-- schedule the meet -->
              <button class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2" 
                     data-bs-toggle="modal" 
                     data-bs-target="#fullCalendarModal" 
                     data-org-id="{{ org_id }}" 
                     data-group-id="{{ group.id }}" 
                     data-task-id="{{ task.id }}">
                      Schedule
                     <i class="bi bi-bug"></i>
                   </button>
                {% endif %}


                <div class="flex items-center gap-2 ml-auto">
                    <div class="form-check form-switch">
                        <input class="form-check-input w-10 -ml-10 h-5 align-top rounded-full shadow-sm checked:bg-blue-600 bg-no-repeat bg-contain float-left cursor-pointer"
                               type="checkbox" role="switch" id="toggleTaskStatus" 
                               data-task-id="{{ task.id }}" 
                               data-org-id="{{ org_id }}" 
                               data-group-id="{{ group_id }}" 
                               {% if task.status == 'completed' %} checked {% endif %}>
                    </div>
                    <label class="form-check-label inline-block text-gray-700" for="toggleTaskStatus">
                        {% if task.status == 'completed' %}
                            Mark as Pending
                        {% else %}
                            Mark as Completed
                        {% endif %}
                    </label>
                </div>
            </div>

            <!-- Tags Section -->
            <div class="mb-6">
                <p class="font-medium text-gray-700 mb-2">Tags</p>
                <div class="flex flex-wrap gap-2">
                    {% if task.tags.all %}
                        {% for tag in task.tags.all %}
                            <span class="px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full flex items-center gap-2 text-sm"
                                  id="tag-{{ tag.id }}" 
                                  data-task-id="{{ task.id }}"
                                  data-org-id="{{ org_id }}"
                                  data-group-id="{{ group_id }}">
                                {{ tag.name }}
                                <button class="text-yellow-800 hover:text-yellow-900 text-sm remove-tag"
                                data-tag="{{ tag.name }}" 
                                data-tag-id="{{ tag.id }}"
                                data-task-id="{{ task.id }}"
                                data-org-id="{{ org_id }}"
                                data-group-id="{{ group_id }}">
                            √ó
                        </button>
                            </span>
                        {% endfor %}
                        <button class="w-8 h-8 rounded-full bg-green-100 text-green-600 hover:bg-green-200 flex items-center justify-center"
                                id="add-tag-btn"
                                data-task-id="{{ task.id }}"
                                data-org-id="{{ org_id }}"
                                data-group-id="{{ group_id }}">
                            +
                        </button>
                    {% else %}
                        <span class="px-3 py-1 bg-gray-100 text-gray-600 rounded-full text-sm">No tags</span>
                        <button class="w-8 h-8 rounded-full bg-green-100 text-green-600 hover:bg-green-200 flex items-center justify-center"
                                id="add-tag-btn"
                                data-task-id="{{ task.id }}"
                                data-org-id="{{ org_id }}"
                                data-group-id="{{ group_id }}">
                            +
                        </button>
                    {% endif %}
                </div>
            </div>

            <!-- Time Tracking -->
            <div class="mb-6">
                <p class="font-medium text-gray-700 mb-2">Time Tracking</p>
                <div class="flex flex-wrap gap-2">
                    {% if task.time_tracking.all %}
                        {% for time_entry in task.time_tracking.all %}
                            <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm"
                                  id="time-entry-{{ time_entry.id }}" 
                                  data-task-id="{{ task.id }}"
                                  data-org-id="{{ org_id }}"
                                  data-group-id="{{ group_id }}">
                                {{ time_entry.user.username }}: {{ time_entry.time_spent }}h
                            </span>
                        {% endfor %}
                    {% else %}
                        <span class="px-3 py-1 bg-gray-100 text-gray-600 rounded-full text-sm">No time tracked</span>
                    {% endif %}
                </div>
                
                <!-- Stopwatch -->
                <div class="mt-4 p-4 bg-gray-50 rounded-lg">
                    <p class="font-medium text-gray-700 mb-2">Stopwatch</p>
                    <div class="flex items-center gap-4">
                        <p id="time-display" class="text-2xl font-bold text-gray-800">00:00:00</p>
                        <button id="start-stop-btn" 
                                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                                data-task-id="{{ task.id }}" 
                                data-org-id="{{ org_id }}" 
                                data-group-id="{{ group_id }}">
                            Start
                        </button>
                        <button id="save-time-btn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700" style="display: none;">
                            Save
                        </button>
                    </div>
                </div>
            </div>

            <!-- Notes Section -->
            <div class="mb-6">
                <p class="font-medium text-gray-700 mb-2">Notes</p>
                {% if task.notes.all %}
                    <ul id="taskNotesList" class="space-y-3">
                        {% for note in task.notes.all %}
                            <li id="note-{{ note.id }}" class="p-4 bg-gray-50 rounded-lg">
                                <div class="flex justify-between items-start mb-2">
                                    <div>
                                        <span class="font-medium text-gray-700">{{ note.user.username }}</span>
                                        <span class="text-sm text-gray-500 ml-2">{{ note.created_at|date:"F j, Y, g:i a" }}</span>
                                    </div>
                                    <div class="dropdown relative">
                                        <button class="dropdown-toggle p-1 hover:bg-gray-200 rounded-lg"
                                                type="button" 
                                                id="dropdownMenuButton"
                                                data-bs-toggle="dropdown"
                                                aria-expanded="false">
                                            <i class="bi bi-three-dots-vertical text-gray-600"></i>
                                        </button>
                                        <ul class="dropdown-menu absolute right-0 hidden bg-white shadow-lg rounded-md py-1 z-10">
                                            <li>
                                                <button class="delete-note w-full px-4 py-2 text-left hover:bg-gray-100 text-red-600"
                                                        data-note-id="{{ note.id }}" 
                                                        data-task-id="{{ task.id }}" 
                                                        data-group-id="{{ task.group.id }}" 
                                                        data-org-id="{{ task.group.organization.id }}">
                                                    Delete
                                                </button>
                                            </li>
                                            <li>
                                                <button class="edit-note w-full px-4 py-2 text-left hover:bg-gray-100"
                                                        data-note-id="{{ note.id }}" 
                                                        data-task-id="{{ task.id }}" 
                                                        data-group-id="{{ task.group.id }}" 
                                                        data-org-id="{{ task.group.organization.id }}" 
                                                        data-note-content="{{ note.note }}">
                                                    Edit
                                                </button>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                                <p class="note-content text-gray-600">{{ note.note }}</p>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="text-gray-500">No notes yet.</p>
                {% endif %}
                <button class="mt-3 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                        data-bs-toggle="modal" data-bs-target="#addNoteModal">
                    Add Note
                </button>
            </div>

            <!-- Comments Section -->
            <div>
                <p class="font-medium text-gray-700 mb-2">Comments</p>
                {% if task.comments.all %}
                    <ul id="comments-list" class="space-y-4">
                        {% for comment in task.comments.all %}
                            <li id="comment-{{ comment.id }}" class="p-4 bg-gray-50 rounded-lg">
                                <div class="flex justify-between items-start mb-2">
                                    <div>
                                        <span class="font-medium text-gray-700">{{ comment.user.username }}</span>
                                        <span class="text-sm text-gray-500 ml-2">{{ comment.created_at|date:"F j, Y, g:i a" }}</span>
                                    </div>
                                    <div class="dropdown relative">
                                        <button class="dropdown-toggle p-1 hover:bg-gray-200 rounded-lg"
                                                type="button"
                                                data-bs-toggle="dropdown"
                                                aria-expanded="false">
                                            <i class="bi bi-three-dots-vertical text-gray-600"></i>
                                        </button>
                                        <ul class="dropdown-menu absolute right-0 hidden bg-white shadow-lg rounded-md py-1 z-10">
                                            <li>
                                                <button class="edit-comment w-full px-4 py-2 text-left hover:bg-gray-100"
                                                        data-comment-id="{{ comment.id }}" 
                                                        data-org-id="{{ org_id }}" 
                                                        data-group-id="{{ group_id }}" 
                                                        data-task-id="{{ task.id }}" 
                                                        data-comment-content="{{ comment.comment }}">
                                                    Edit
                                                </button>
                                            </li>
                                            <li>
                                                <button class="delete-comment w-full px-4 py-2 text-left hover:bg-gray-100 text-red-600"
                                                        data-comment-id="{{ comment.id }}" 
                                                        data-org-id="{{ org_id }}" 
                                                        data-group-id="{{ group_id }}" 
                                                        data-task-id="{{ task.id }}">
                                                    Delete
                                                </button>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                                <p class="comment-text text-gray-600">{{ comment.comment }}</p>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="text-gray-500">No comments yet.</p>
                {% endif %}
                
                <div class="mt-4">
                    <textarea id="comment-text" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" 
                              rows="3" placeholder="Add your comment..."></textarea>
                    <button id="submit-comment" 
                            class="mt-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                            data-org-id="{{ org_id }}" 
                            data-group-id="{{ group_id }}" 
                            data-task-id="{{ task.id }}">
                        Add Comment
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Activity Logs Sidebar -->
     <!-- Sidebar for Activity Logs -->
<div id="activityLogsSidebar" class="activity-logs-sidebar">
    <div class="sidebar-content">
        <button id="closeSidebarButton" class="btn btn-light">Close</button>
        <h3>Activity Logs</h3>
        <div id="activityLogsContainer" class="activity-logs-container">
            <!-- Activity logs will be loaded here -->
        </div>
    </div>
</div>

<!-- ---------------------------------------------------------------working on ui------------------------------------- -->

























    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/main.min.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap 5 JS (Includes Popper.js) -->
   <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

   








<!-- FullCalendar & Dependencies -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.2/fullcalendar.min.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.2/fullcalendar.min.js"></script>

<script>
$(document).ready(function () {
    let selectedDate = null;
    let selectedTimeSlot = null;
    let orgId, groupId, taskId;

    // Capture Organization, Group, and Task ID
    $("[data-bs-target='#fullCalendarModal']").on("click", function () {
        orgId = $(this).data("org-id");
        groupId = $(this).data("group-id");
        taskId = $(this).data("task-id");
        fetchExistingMeetings();
    });

    // Initialize FullCalendar with Tailwind styling
    $("#calendar").fullCalendar({
        themeSystem: false,
        header: {
            left: "prev,next today",
            center: "title",
            right: "month,agendaWeek,agendaDay",
        },
        buttonIcons: {
            prev: 'chevron_left',
            next: 'chevron_right',
            prevYear: 'keyboard_double_arrow_left',
            nextYear: 'keyboard_double_arrow_right'
        },
        buttonText: {
            today: 'Today',
            month: 'Month',
            week: 'Week',
            day: 'Day'
        },
        events: [],
        eventRender: function(event, element) {
            element.addClass(`
                rounded-lg shadow-sm transition-all duration-200
                ${event.status === 'confirmed' ? 
                    'bg-emerald-100 border border-emerald-200 hover:bg-emerald-200' : 
                    'bg-amber-100 border border-amber-200 hover:bg-amber-200'}
                text-gray-800 text-sm font-medium p-2
                hover:shadow-md hover:-translate-y-0.5
            `);
        },
        dayRender: function(date, cell) {
            cell.addClass(`
                hover:bg-indigo-50 transition-colors cursor-pointer
                border border-gray-100
            `);
        },
        selectable: true,
        dayClick: function(date) {
            selectedDate = date.format("YYYY-MM-DD");
            fetchAvailableSlots();
        },
        eventClick: function(event) {
            $("#meetingDetailsTitle").text("Meeting Details");
            let meetingLinkHtml = event.meeting_link ? 
                `<a href="${event.meeting_link}" target="_blank" class="
                    inline-flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white
                    rounded-lg hover:bg-indigo-700 transition-colors shadow-sm
                    hover:shadow-md
                ">
                    <span class="material-icons-outlined text-sm">videocam</span>
                    Join Meeting
                </a>` : 
                `<span class="text-red-500 text-sm flex items-center gap-2">
                    <span class="material-icons-outlined text-sm">link_off</span>
                    No meeting link available
                </span>`;

            $("#meetingDetailsBody").html(`
                <div class="space-y-4 text-gray-700">
                    <div class="flex items-center gap-3 p-2 hover:bg-gray-50 rounded-lg">
                        <span class="material-icons-outlined text-indigo-500">calendar_today</span>
                        <span class="font-medium">${event.start.format("YYYY-MM-DD")}</span>
                    </div>
                    <div class="flex items-center gap-3 p-2 hover:bg-gray-50 rounded-lg">
                        <span class="material-icons-outlined text-indigo-500">schedule</span>
                        ${event.start.format("HH:mm")} - ${event.end ? event.end.format("HH:mm") : "N/A"}
                    </div>
                    <div class="flex items-start gap-3 p-2 hover:bg-gray-50 rounded-lg">
                        <span class="material-icons-outlined text-indigo-500">description</span>
                        <span class="flex-1">${event.title}</span>
                    </div>
                    <div class="flex items-center gap-3 p-2 hover:bg-gray-50 rounded-lg">
                        <span class="material-icons-outlined text-indigo-500">info</span>
                        <span class="px-3 py-1 rounded-full text-sm ${
                            event.status === 'confirmed' ? 
                            'bg-emerald-100 text-emerald-800' : 'bg-amber-100 text-amber-800'
                        }">
                            ${event.status || "Pending"}
                        </span>
                    </div>
                    <div class="flex items-center gap-3 p-2 hover:bg-gray-50 rounded-lg">
                        <span class="material-icons-outlined text-indigo-500">link</span>
                        ${meetingLinkHtml}
                    </div>
                </div>
            `);
            $("#meetingDetailsModal").modal("show");
        },
        viewRender: function(view) {
            // Style calendar buttons
            $('.fc-button-group, .fc-button').addClass(`
                bg-white shadow-sm rounded-lg overflow-hidden
                border border-gray-200 hover:shadow-md
            `);
            $('.fc-button').addClass(`
                px-4 py-2 text-gray-700 font-medium
                hover:bg-gray-50 transition-all
                flex items-center gap-2
            `);
            $('.fc-icon').addClass('material-icons-outlined text-sm');
            $('.fc-today-button').addClass('text-indigo-600');
            $('.fc-today').addClass('bg-indigo-50');
        }
    });

    // Fetch Available Time Slots & Meetings
    function fetchAvailableSlots() {
        if (!selectedDate) return;

        $.ajax({
            url: `/tasks/get-available-slots/?org_id=${orgId}&group_id=${groupId}&task_id=${taskId}&date=${selectedDate}`,
            method: "GET",
            dataType: "json",
            success: function(data) {
                let slotsDiv = $("#timeSlots");
                slotsDiv.html("").addClass(`
                    grid grid-cols-2 md:grid-cols-3 gap-2
                    max-h-[60vh] overflow-y-auto p-2
                `);

                if (!data.available_slots || data.available_slots.length === 0) {
                    slotsDiv.html(`
                        <div class="col-span-3 text-center p-6">
                            <span class="material-icons-outlined text-gray-400 text-4xl mb-2">hourglass_empty</span>
                            <p class="text-gray-500">No available slots for this date</p>
                        </div>
                    `);
                    return;
                }

                data.available_slots.forEach((slot, index) => {
                    let time = slot.start_time;
                    let slotBtn = $(`
                        <button class="
                            slot-btn w-full
                            px-4 py-3 text-sm font-medium
                            rounded-xl transition-all duration-300
                            border-2 border-indigo-100 hover:border-indigo-300
                            bg-white/80 backdrop-blur-sm hover:bg-indigo-50
                            hover:scale-[1.02] shadow-sm
                            animate-fade-in-up
                            flex items-center justify-center
                        ">
                            <span class="material-icons-outlined text-sm mr-2 text-indigo-500">schedule</span>
                            ${time}
                        </button>
                    `)
                    .data("time", time)
                    .on("click", function() {
                        $(".slot-btn").removeClass(`
                            bg-indigo-600 text-white border-indigo-600
                            ring-2 ring-indigo-200
                        `);
                        $(this).addClass(`
                            bg-indigo-600 text-white border-indigo-600
                            ring-2 ring-indigo-200
                        `);
                        selectedTimeSlot = $(this).data("time");
                        $("#proceedToSchedule")
                            .prop("disabled", false)
                            .removeClass("opacity-50 cursor-not-allowed")
                            .addClass("hover:bg-indigo-700");
                    })
                    .css('animation-delay', `${index * 50}ms`);

                    slotsDiv.append(slotBtn);
                });

                $("#availableSlotsModal").modal("show");
            },
            error: function(xhr, status, error) {
                console.log("Error fetching slots:", error);
                alert("‚ùå Failed to fetch available slots. Please try again.");
            },
        });
    }

    // Fetch Existing Meetings for Task
    function fetchExistingMeetings() {
        $.ajax({
            url: `/tasks/get-existing-meetings/?org_id=${orgId}&group_id=${groupId}&task_id=${taskId}`,
            method: "GET",
            dataType: "json",
            success: function(data) {
                let meetings = data.meetings || [];
                $("#calendar").fullCalendar("removeEvents");
                meetings.forEach((meeting) => {
                    $("#calendar").fullCalendar("renderEvent", {
                        id: meeting.id,
                        title: meeting.reason.replace("_", " "),
                        start: meeting.date + "T" + meeting.start_time,
                        end: meeting.date + "T" + meeting.end_time,
                        status: meeting.status,
                        meeting_link: meeting.meeting_link,
                        allDay: false,
                    });
                });
            },
            error: function(xhr, status, error) {
                console.log("Error fetching meetings:", error);
            },
        });
    }

    // Proceed to Confirm Modal
    $("#proceedToSchedule").on("click", function() {
        $("#selectedDate").text(selectedDate);
        $("#selectedTime").text(selectedTimeSlot);
        $("#confirmMeetingModal").modal("show");
    });

    // Schedule Meeting AJAX
   // Schedule Meeting AJAX
$("#scheduleMeeting").on("click", function () {
    let reason = $("#meetingReason").val();
    if (!reason) {
        $("#meetingReason").addClass("border-red-500");
        return;
    }

    // Show Loading Spinner
    $("#scheduleMeeting").prop("disabled", true).html(
        `<span class="spinner-border spinner-border-sm"></span> Scheduling...`
    );

    $.ajax({
        url: "/tasks/schedule-the-meeting/",
        method: "POST",
        headers: { "X-CSRFToken": getCSRFToken() },
        contentType: "application/json",
        data: JSON.stringify({
            org_id: orgId,
            group_id: groupId,
            task_id: taskId,
            date: selectedDate,
            start_time: selectedTimeSlot,
            reason: reason,
        }),
        success: function (data) {
            if (data.success) {
                showNotification("‚úÖ Meeting Scheduled Successfully!", "bg-emerald-500");
                setTimeout(() => location.reload(), 1500);
            } else {
                showNotification("‚ùå Error: " + data.error, "bg-red-500");
            }
        },
        error: function (xhr) {
            showNotification("‚ùå Failed to schedule meeting", "bg-red-500");
        },
        complete: function () {
            // Hide Loading Spinner
            $("#scheduleMeeting").prop("disabled", false).html("Schedule Meeting");
        },
    });
});

    // Helper functions
    function getCSRFToken() {
        return $("[name=csrfmiddlewaretoken]").val();
    }

    function showNotification(text, bgColor) {
        let notification = $(`
            <div class="fixed bottom-4 right-4 ${bgColor} text-white px-6 py-3 
                rounded-lg shadow-lg flex items-center gap-2 animate-slide-in">
                <span class="material-icons-outlined">notification_important</span>
                ${text}
            </div>
        `);
        $("body").append(notification);
        setTimeout(() => notification.remove(), 3000);
    }

    // Add custom animations
    const style = document.createElement('style');
    style.textContent = `
        @keyframes fade-in-up {
            0% { opacity: 0; transform: translateY(10px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        @keyframes slide-in {
            0% { transform: translateX(100%); }
            100% { transform: translateX(0); }
        }
        .animate-fade-in-up { animation: fade-in-up 0.3s ease-out forwards; }
        .animate-slide-in { animation: slide-in 0.3s ease-out; }
        
        .fc-toolbar h2 { 
            font-size: 1.25rem;
            font-weight: 600;
            color: #374151;
        }
        
        .fc-day-header {
            background: #f8fafc;
            color: #64748b;
            font-weight: 500;
            padding: 8px;
            border-color: #e2e8f0;
        }
        
        .modal-glass {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
    `;
    document.head.appendChild(style);

    // Style all modals
    $(".modal-content").addClass(`
        modal-glass rounded-xl shadow-2xl
        border border-white/20 overflow-hidden
    `);
    $(".modal-header").addClass(`
        border-b border-gray-200/50 p-4
        flex items-center justify-between
    `);
    $(".modal-title").addClass(`
        text-xl font-semibold text-gray-800
        flex items-center gap-2
    `);
    $(".modal-body").addClass("p-4");
    $(".modal-footer").addClass(`
        border-t border-gray-200/50 px-4 py-3
        flex items-center justify-end gap-2
    `);
    
    // Style form inputs
    $("#meetingReason").addClass(`
        w-full px-4 py-2 border border-gray-200 rounded-lg
        focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500
        transition-all
    `);
});
</script>




<!-- Script -->
<script>
       $(document).ready(function() {
    $('#submit-comment').click(function() {
        var commentText = $('#comment-text').val().trim();
        if (commentText == "") {
            alert("Please write a comment before submitting.");
            return;
        }

        var orgId = $(this).data('org-id');
        var groupId = $(this).data('group-id');
        var taskId = $(this).data('task-id');

        // Construct the URL using JavaScript
        var url = '/tasks/task/' + orgId + '/' + groupId + '/' + taskId + '/add_comment/';

        // Send the comment via AJAX
        $.ajax({
            type: 'POST',
            url: url,
            data: {
                'comment': commentText,
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response) {
                // Append new comment to the list
                $('#comments-list').append('<li><strong>' + response.username + ':</strong> ' + response.comment + ' (' + response.created_at + ')</li>');
                showNotification('Comment has been added to your task')

                // Clear the comment text area
                $('#comment-text').val('');
            },
            error: function(xhr, errmsg, err) {
                alert("Error submitting comment. Please try again.");
            }
        });
    });
});


// Handle add note featue
document.getElementById("saveNoteButton").addEventListener("click", function() {
    // Fetch the task ID, org ID, and group ID from template context
    var taskId = '{{ task.id }}';
    var orgId = '{{ org_id }}';
    var groupId = '{{ group_id }}';

    // Get the note content
    var noteContent = document.getElementById("noteText").value;

    if (noteContent.trim() === "") {
        alert("Please enter a note!");
        return;
    }

    // Construct the URL dynamically using JavaScript syntax
    var url = "/tasks/task/" + orgId + "/" + groupId + "/" + taskId + "/add_note/";

    // Send the note via AJAX
    $.ajax({
        type: 'POST',
        url: url,
        data: {
            'note': noteContent,
            'csrfmiddlewaretoken': '{{ csrf_token }}' // CSRF token for security
        },
        success: function(response) {
            // Close the modal
            $('#addNoteModal').modal('hide');

            // Append the new note to the list of notes (or update UI as needed)
            var newNote = "<li><strong>You:</strong> " + response.note + " (" + response.created_at + ")</li>";
            document.querySelector("#taskNotesList").insertAdjacentHTML('beforeend', newNote);
            showNotification("Note is integrated")

            // Clear the textarea
            document.getElementById("noteText").value = "";
        },
        error: function(xhr, status, error) {
            alert("Error while adding note: " + error);
        }
    });
});

// Handle the timer
function toggleTimer() {
    var taskId = '{{ task.id }}';
    var orgId = '{{ org_id }}';
    var groupId = '{{ group_id }}';
    var button = document.getElementById("startStopButton");
    var icon = document.getElementById("timerIcon");
    
    // Check if timer is running by reading button text
    var isRunning = button.innerText.toLowerCase() === "stop timer";

    // Set action to either start or stop based on current button state
    var action = isRunning ? "stop" : "start";

    // Make AJAX request to start/stop timer
    $.ajax({
        type: 'POST',
        url: '/tasks/task/' + orgId + '/' + groupId + '/' + taskId + '/manage_timer/',
        data: {
            'action': action,  // send the action (start/stop)
            'csrfmiddlewaretoken': '{{ csrf_token }}'  // CSRF token for security
        },
        success: function(response) {
            if (response.status === 'started') {
                button.innerText = "Stop Timer";  // Change button text to "Stop Timer"
                icon.classList.remove("bi-play-circle");  // Remove play icon
                icon.classList.add("bi-pause-circle");   // Add pause icon
                startTimerDisplay();  // Start updating the time display
            } else if (response.status === 'stopped') {
                button.innerText = "Start Timer";  // Change button text back to "Start Timer"
                icon.classList.remove("bi-pause-circle");  // Remove pause icon
                icon.classList.add("bi-play-circle");      // Add play icon
                stopTimerDisplay();  // Stop updating the time display
            }
        },
        error: function(xhr, status, error) {
            alert("Error: " + error);
        }
    });
}

function startTimerDisplay() {
    // Implement the timer countdown functionality in real-time
    var timeSpent = document.getElementById("timeSpent");
    var startTime = Date.now();  // Capture the start time when the timer starts
    
    // Update time every second
    var timerInterval = setInterval(function() {
        var elapsedTime = Date.now() - startTime;
        var seconds = Math.floor((elapsedTime / 1000) % 60);
        var minutes = Math.floor((elapsedTime / 60000) % 60);
        var hours = Math.floor((elapsedTime / 3600000) % 24);
        
        // Format time as HH:mm:ss
        timeSpent.innerText = formatTime(hours, minutes, seconds);
    }, 1000);
    
    // Store interval ID to clear it when stopping the timer
    window.timerInterval = timerInterval;
}

function stopTimerDisplay() {
    // Clear the interval and stop updating the time display
    clearInterval(window.timerInterval);
}

function formatTime(hours, minutes, seconds) {
    // Format time to be displayed as HH:mm:ss
    return (hours < 10 ? "0" + hours : hours) + ":" + 
           (minutes < 10 ? "0" + minutes : minutes) + ":" + 
           (seconds < 10 ? "0" + seconds : seconds);
}


// handle the progress

document.getElementById('increaseProgress').addEventListener('click', function () {
    updateProgress(10); // Increase by 10
});

document.getElementById('decreaseProgress').addEventListener('click', function () {
    updateProgress(-10); // Decrease by 10
});

function updateProgress(delta) {
    const progressBar = document.getElementById('progressBar');
    const currentProgress = parseInt(progressBar.getAttribute('aria-valuenow'));
    const newProgress = Math.min(100, Math.max(0, currentProgress + delta)); // Ensure between 0 and 100

    $.ajax({
        type: 'POST',
        url: '/tasks/tasks/{{ org_id }}/{{ group_id }}/{{ task.id }}/update_progress/',
        data: {
            'progress': newProgress,
            'csrfmiddlewaretoken': '{{ csrf_token }}'
        },
        success: function (response) {
            if (response.status === 'success') {
                progressBar.style.width = response.progress + '%';
                progressBar.setAttribute('aria-valuenow', response.progress);
                progressBar.textContent = response.progress + '%';
                showNotification("Progress has been synced")
            } else {
                alert(response.message || 'An error occurred.');
            }
        },
        error: function (xhr, status, error) {
            alert('Error: ' + error);
        }
    });
}

// Handle activity logs

$(document).ready(function () {
    // Handle the click event to open the sidebar
    $('#activityLogsButton').click(function () {
        // Fetch activity logs via AJAX when the sidebar is opened
        var orgId = '{{ org_id }}';
        var groupId = '{{ group_id }}';
        var taskId = '{{ task.id }}';

        $.ajax({
            type: 'GET',
            url: '/tasks/tasks/' + orgId + '/' + groupId + '/' + taskId + '/activity_logs/',
            success: function (response) {
                if (response.status === 'success') {
                    loadActivityLogs(response.activity_logs);
                    showNotification("Activity Logs up and running")
                    // Show the sidebar
                    $('#activityLogsSidebar').css('right', '0');
                } else {
                    alert('Error: ' + response.message);
                }
            },
            error: function (xhr, status, error) {
                alert('Error fetching activity logs: ' + error);
            }
        });
    });

    // Handle the close button click to hide the sidebar
    $('#closeSidebarButton').click(function () {
        $('#activityLogsSidebar').css('right', '-400px');
    });
    showNotification('Task is fired up and ready')

    // Function to load activity logs into the sidebar
    function loadActivityLogs(logs) {
        var container = $('#activityLogsContainer');
        container.empty();  // Clear any existing logs

        // Loop through and display each log
        logs.forEach(function (log) {
            var logElement = `
                <div class="activity-log">
                    <h5>${log.action}</h5>
                    <p>${log.details}</p>
                    <small>${log.created_at}</small>
                </div>
            `;
            container.append(logElement);
        });
    }
});


// Handle task toggle as completed

document.getElementById('toggleTaskStatus').addEventListener('change', function () {
    const taskId = this.getAttribute('data-task-id');
    const orgId = this.getAttribute('data-org-id');
    const groupId = this.getAttribute('data-group-id');
    const isChecked = this.checked;

    // Determine the action based on the toggle state
    const action = isChecked ? 'completed' : 'pending';

    // Send an AJAX request
    fetch(`/tasks/tasks/${orgId}/${groupId}/${taskId}/toggle_status/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken(), 
        },
        body: JSON.stringify({ status: action }),
    })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Update the label text
                document.querySelector('label[for="toggleTaskStatus"]').textContent = 
                    isChecked ? 'Mark as Pending' : 'Mark as Completed';
                    showNotification("Victory achieved")
            } else {
                alert('Failed to update task status.');
                this.checked = !isChecked; // Revert the toggle state
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred.');
            this.checked = !isChecked; // Revert the toggle state
        });
});

// Function to get the CSRF token
function getCSRFToken() {
    const name = 'csrftoken';
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.startsWith(name + '=')) {
            return cookie.substring(name.length + 1);
        }
    }
    return '';
}

/* Handle add remove tag  */
/* Handle Add/Remove Tag */
// Handle Add Tag Button click
document.getElementById('add-tag-btn').addEventListener('click', function () {
    const taskId = this.getAttribute('data-task-id'); // Fetch task ID
    const orgId = this.getAttribute('data-org-id');  // Fetch org ID
    const groupId = this.getAttribute('data-group-id'); // Fetch group ID

    // Open the modal to choose tags
    $('#addTagModal').modal('show');

    // Ensure we only bind the event handler once
    const saveTagButton = document.getElementById('save-tag-btn');
    saveTagButton.onclick = function () {
        const selectedTag = document.getElementById('tag-select').value; // Get selected tag
        if (!selectedTag) {
            alert('Please select a tag.');
            return;
        }

        // Send an AJAX request to add the tag
        fetch(`/tasks/tasks/${orgId}/${groupId}/${taskId}/update_tags/`, { // Corrected the URL structure
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken(), // Ensure you include your CSRF token
            },
            body: JSON.stringify({ action: 'add', tag_name: selectedTag }), // Send action and tag_name
        })
            .then(response => response.json())
            .then(data => {
                if (data.tag_name) { // Check if tag_name exists in the response
                    // Create the new tag element
                    const tagBadge = document.createElement('span');
                    tagBadge.classList.add('badge', 'bg-warning');
                    tagBadge.setAttribute('id', `tag-${data.tag_name}`); // Set id for the tag
                    tagBadge.setAttribute('data-task-id', taskId);
                    tagBadge.setAttribute('data-org-id', orgId);
                    tagBadge.setAttribute('data-group-id', groupId);
                    tagBadge.innerHTML = `
                        ${data.tag_name}
                        <button class="btn btn-sm btn-danger remove-tag" 
                                data-tag="${data.tag_name}" 
                                data-tag-id="${data.tag_name}" 
                                data-task-id="${taskId}" 
                                data-org-id="${orgId}" 
                                data-group-id="${groupId}">-</button>
                    `;

                    // Append the new tag to the tag container dynamically
                    const tagContainer = document.querySelector('p');
                    if (tagContainer) {
                        // If there's an existing "No tags" message, remove it
                        const noTagsElement = tagContainer.querySelector('.badge.bg-secondary');
                        if (noTagsElement) {
                            noTagsElement.remove(); // Remove "No tags" message
                        }

                        // Insert the new tag badge before the "+" button
                        const addTagButton = tagContainer.querySelector('#add-tag-btn');
                        if (addTagButton) {
                            tagContainer.insertBefore(tagBadge, addTagButton);
                        } else {
                            // If no "+" button, append it to the end
                            tagContainer.appendChild(tagBadge);
                        }
                    }

                    // Show success notification
                    showNotification('Your task has been tagged!');

                    // Close the modal
                    $('#addTagModal').modal('hide');
                } else {
                    alert('Failed to add tag.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred.');
            });
    };
});


// Remove tag event listener (Improved delegation)
document.addEventListener('click', function (event) {
    if (event.target && event.target.classList.contains('remove-tag')) {
        // Make sure the event is triggered by the button with class 'remove-tag'
        
        const tagElement = event.target.closest('.badge');  // Find the parent badge element
        const taskId = tagElement.getAttribute('data-task-id');  // Fetch task ID from the badge parent
        const orgId = tagElement.getAttribute('data-org-id');  // Fetch org ID from the badge parent
        const groupId = tagElement.getAttribute('data-group-id');  // Fetch group ID from the badge parent
        const tagName = event.target.getAttribute('data-tag');  // Fetch tag name
        
        // Send an AJAX request to remove the tag
        fetch(`/tasks/tasks/${orgId}/${groupId}/${taskId}/update_tags/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken(),
            },
            body: JSON.stringify({ action: 'remove', tag_name: tagName }),  // Send action and tag_name
        })
        .then(response => response.json())
        .then(data => {
            if (data.tag_name) {  // Check if tag_name exists in the response
                // Remove the tag from the displayed list
                tagElement.remove();
                showNotification('Tag removed successfully','success');  // Remove the tag element from the DOM
            } else {
                alert('Failed to remove tag.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred.');
        });
    }
});

// Handle time tracking
// Stopwatch Variables
let stopwatchInterval;
let isRunning = false;
let startTime = 0;
let elapsedTime = 0;

// DOM elements for stopwatch
const startStopBtn = document.getElementById('start-stop-btn');
const resetBtn = document.getElementById('reset-btn');  // Ensure this button exists or add it if needed
const timeDisplay = document.getElementById('time-display');

// Capture dynamic task ID, org ID, and group ID from button attributes
const taskId = startStopBtn.getAttribute('data-task-id');
const orgId = startStopBtn.getAttribute('data-org-id');
const groupId = startStopBtn.getAttribute('data-group-id');

// Function to format time (HH:MM:SS)
function formatTime(time) {
    const hours = Math.floor(time / 3600);
    const minutes = Math.floor((time % 3600) / 60);
    const seconds = time % 60;

    return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
}

// Function to start/stop the stopwatch
function toggleStopwatch() {
    if (isRunning) {
        // Stop the stopwatch
        clearInterval(stopwatchInterval);
        startStopBtn.textContent = 'Start';
        saveTime();  // Save the time once stopped
    } else {
        // Start the stopwatch
        startTime = Date.now() - elapsedTime;
        stopwatchInterval = setInterval(updateTimeDisplay, 1000);
        startStopBtn.textContent = 'Stop';
    }
    isRunning = !isRunning;
    showNotification('Stopwatch in action, logging your activity time. It will keep going until you stop it')
}

// Function to update time display
function updateTimeDisplay() {
    elapsedTime = Date.now() - startTime;
    timeDisplay.textContent = formatTime(elapsedTime / 1000);  // Convert to seconds
}

// Function to reset the stopwatch
function resetStopwatch() {
    clearInterval(stopwatchInterval);
    isRunning = false;
    startStopBtn.textContent = 'Start';
    timeDisplay.textContent = '00:00:00';
    elapsedTime = 0;
}

// Function to save time to the database and append it dynamically
// Function to save time to the database
function saveTime() {
    const timeSpent = (elapsedTime / 1000 / 3600).toFixed(2); // Convert to hours

    // Send AJAX request to save time
    fetch(`/tasks/tasks/${orgId}/${groupId}/${taskId}/save_time/`, {  // Correct URL structure
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken(),  // Ensure CSRF token is included
        },
        body: JSON.stringify({
            time_spent: timeSpent,  // Send time spent in hours
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            
            showNotification("Time logged with precision")
            
            
            // Dynamically create a new badge for the new time entry
            const newBadge = document.createElement('span');
            newBadge.classList.add('badge', 'bg-info');
            newBadge.setAttribute('id', `time-entry-${data.time_entry_id}`); // Set unique ID for the time entry badge
            newBadge.setAttribute('data-task-id', taskId);
            newBadge.setAttribute('data-org-id', orgId);
            newBadge.setAttribute('data-group-id', groupId);
            newBadge.textContent = `${data.username}: ${data.time_spent} hours`;

            // Append the new badge to the time tracking section
            const timeTrackingContainer = document.querySelector('p');
            if (timeTrackingContainer) {
                const noTimeElement = timeTrackingContainer.querySelector('.badge.bg-secondary');
                if (noTimeElement) {
                    noTimeElement.remove(); // Remove "No time tracked" message
                }
                timeTrackingContainer.appendChild(newBadge);  // Append the new time entry
            }

            // Optionally reset stopwatch after saving time
            resetStopwatch();
        } else {
            alert('Failed to save time.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while saving the time.');
    });
}

// Event listeners for buttons


document.addEventListener('DOMContentLoaded', function () {
    const raiseProblemButton = document.getElementById('raise-problem-btn');
    const loadingSpinner = document.getElementById('loading-spinner'); // Spinner element
    const loadingText = document.getElementById('loading-text'); // Loading text element

    if (raiseProblemButton) {
        raiseProblemButton.addEventListener('click', function () {
            const orgId = this.getAttribute('data-org-id');
            const groupId = this.getAttribute('data-group-id');
            const taskId = this.getAttribute('data-task-id');
            const problemDescription = document.getElementById('problem-description').value;

            if (!problemDescription) {
                alert('Please provide a description for the problem.');
                return;
            }

            // Show the spinner and text
            loadingSpinner.style.display = 'inline-block';
            loadingText.style.display = 'inline-block';

            // Send an AJAX request to report the problem
            fetch(`/tasks/tasks/${orgId}/${groupId}/${taskId}/create_problem/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken(), // Ensure CSRF token is added here
                },
                body: JSON.stringify({
                    description: problemDescription,
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                   
                    showNotification('Issue escalated and flagged to your manager')
                      

                    // Create a new list item for the reported problem
                    const newProblemItem = document.createElement('li');
                    newProblemItem.innerHTML = `
                        <strong>${data.reported_by}</strong>: 
                        ${data.description} 
                        (${new Date(data.created_at).toLocaleString()}) 
                        <strong>Is Resolved: ${data.is_resolved}</strong>
                    `;

                    // Append the new problem to the list
                    const problemsList = document.getElementById('problems-list');
                    if (problemsList) {
                        problemsList.appendChild(newProblemItem);
                     
                        // Trigger the animation
                        setTimeout(function () {
                            newProblemItem.classList.add('show');
                        }, 10); // Adding a small delay to trigger the transition
                    }

                    // Optionally, clear the problem description textarea
                    document.getElementById('problem-description').value = '';
                } else {
                    alert('Failed to report the problem.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while reporting the problem.');
            })
            .finally(() => {
                // Hide the spinner and text once the request is complete
                loadingSpinner.style.display = 'none';
                loadingText.style.display = 'none';
            });
        });
    } else {
        console.error('Raise Problem button not found');
    }
});

// Function to get CSRF token from the cookies
function getCSRFToken() {
    let csrfToken = null;
    const cookieValue = document.cookie.split(';').find(cookie => cookie.trim().startsWith('csrftoken='));
    if (cookieValue) {
        csrfToken = cookieValue.split('=')[1];
    }
    return csrfToken;
}



// Handle problem resolve
document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('.resolve-problem-btn').forEach(button => {
        button.addEventListener('click', function () {
            const orgId = this.getAttribute('data-org-id');
            const groupId = this.getAttribute('data-group-id');
            const taskId = this.getAttribute('data-task-id');
            const problemId = this.getAttribute('data-problem-id');

            console.log(`Resolving problem with orgId=${orgId}, groupId=${groupId}, taskId=${taskId}, problemId=${problemId}`);

            // Reference to the current list item
            const problemListItem = this.closest('li');
            if (!problemListItem) {
                console.error("Problem list item not found!");
                return;
            }

            fetch(`/tasks/tasks/${orgId}/${groupId}/${taskId}/resolve_problem/${problemId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken(),
                },
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log("Server response:", data);
                if (data.success) {
                    // Display notification
                    showNotification(data.success);

                    // Update the Is Resolved field in the UI
                    const isResolvedField = problemListItem.querySelector('strong:nth-of-type(2)');
                    if (isResolvedField) {
                        isResolvedField.textContent = 'Is Resolved: True';
                    } else {
                        console.warn("Is Resolved field not found!");
                    }

                    // Remove the resolve button
                    const resolveButton = problemListItem.querySelector('.resolve-problem-btn');
                    if (resolveButton) {
                        resolveButton.remove();
                    } else {
                        console.warn("Resolve button not found!");
                    }
                } else {
                    alert('Failed to mark the problem as resolved.');
                    console.error("Error response from server:", data);
                }
            })
            .catch(error => {
                console.error('Error occurred:', error);
                alert('An error occurred while resolving the problem.');
            });
        });
    });
});

// Function to show notification
function showNotification(message) {
    const notification = document.getElementById('notification');
    const notificationText = document.getElementById('notification-text');
    notificationText.textContent = message;
    notification.classList.add('show');

    // Auto hide notification after 3 seconds
    setTimeout(() => {
        closeNotification();
    }, 5000);
}

// Function to close the notification
function closeNotification() {
    const notification = document.getElementById('notification');
    notification.classList.remove('show');
}

// Function to get CSRF token from cookies
function getCSRFToken() {
    let csrfToken = null;
    const cookieValue = document.cookie.split(';').find(cookie => cookie.trim().startsWith('csrftoken='));
    if (cookieValue) {
        csrfToken = cookieValue.split('=')[1];
    }
    return csrfToken;
}


// Handle note deletion
document.addEventListener('DOMContentLoaded', function () {
    // Add event listener for delete buttons
    document.querySelectorAll('.delete-note').forEach(button => {
        button.addEventListener('click', function () {
            const noteId = this.getAttribute('data-note-id');
            const taskId = this.getAttribute('data-task-id');
            const groupId = this.getAttribute('data-group-id');
            const orgId = this.getAttribute('data-org-id');

            // Send AJAX request to delete the note
            fetch(`/tasks/tasks/${orgId}/${groupId}/${taskId}/${noteId}/delete_note/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'), // Ensure CSRF token is included
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    // Remove the note element from the DOM
                    const noteElement = document.getElementById(`note-${noteId}`);
                    if (noteElement) {
                        noteElement.remove();
                    }
                   
                    showNotification("Note has been expunged and is no longer available.")
                } else if (data.error) {
                    alert(data.error);
                }
            })
            .catch(error => console.error('Error:', error));
        });
    });
});

// Function to get the CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}



// Edit the note
document.addEventListener('DOMContentLoaded', function () {
    // Function to get CSRF token from the cookies
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Handle Edit button click
    document.querySelectorAll('.edit-note').forEach(button => {
        button.addEventListener('click', function () {
            const noteId = this.getAttribute('data-note-id');
            const taskId = this.getAttribute('data-task-id');
            const groupId = this.getAttribute('data-group-id');
            const orgId = this.getAttribute('data-org-id');
            const currentNoteContent = this.getAttribute('data-note-content');
            
            // Populate the modal with the current note content
            document.getElementById('noteContent').value = currentNoteContent;

            // Show the modal
            const editModal = new bootstrap.Modal(document.getElementById('editNoteModal'));
            editModal.show();

            // Set a save handler for the modal save button
            document.getElementById('saveNoteBtn').addEventListener('click', function () {
                const updatedNoteContent = document.getElementById('noteContent').value;

                fetch(`/tasks/tasks/${orgId}/${groupId}/${taskId}/${noteId}/edit_note/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        'note': updatedNoteContent
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.message) {
                        // Find the note item by ID and update the content
                        const noteItem = document.getElementById(`note-${noteId}`);
                        if (noteItem) {
                            const noteContentElement = noteItem.querySelector('.note-content');
                            if (noteContentElement) {
                                noteContentElement.textContent = updatedNoteContent;
                            }
                        }

                        
                        showNotification('Your note has been revised and the updates are now logged')

                        // Close the modal
                        var modal = bootstrap.Modal.getInstance(document.getElementById('editNoteModal'));
                        modal.hide();
                    } else {
                        alert(data.error);
                    }
                })
                .catch(error => console.error('Error:', error));
            });
        });
    });
});

// Edit comment

document.addEventListener('DOMContentLoaded', function () {
    // Function to get CSRF token from the cookies
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Handle Edit Comment button click
    document.querySelectorAll('.edit-comment').forEach(button => {
        button.addEventListener('click', function () {
            const commentId = this.getAttribute('data-comment-id');
            const orgId = this.getAttribute('data-org-id');
            const groupId = this.getAttribute('data-group-id');
            const taskId = this.getAttribute('data-task-id');
            const currentCommentContent = this.getAttribute('data-comment-content');
            
            // Populate the modal with the current comment content
            document.getElementById('commentContent').value = currentCommentContent;

            // Show the modal
            const editModal = new bootstrap.Modal(document.getElementById('editCommentModal'));
            editModal.show();

            // Set up the save button handler
            document.getElementById('saveCommentBtn').addEventListener('click', function saveHandler() {
                const updatedCommentContent = document.getElementById('commentContent').value;

                fetch(`/tasks/tasks/${orgId}/${groupId}/${taskId}/${commentId}/edit_comment/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        'comment': updatedCommentContent
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.message) {
                        // Update the comment text in the list
                        const commentItem = document.querySelector(`#comment-${commentId} .comment-text`);
                        commentItem.textContent = updatedCommentContent;
                        showNotification("The update to the comment was successful.")

                        // Close the modal
                        editModal.hide();
                    } else {
                        alert(data.error);
                    }
                })
                .catch(error => console.error('Error:', error));

                // Remove the save handler after execution to avoid duplicates
                this.removeEventListener('click', saveHandler);
            });
        });
    });
});


// Delete comment

document.addEventListener('DOMContentLoaded', function () {
    // Handle Delete Comment click
    document.querySelectorAll('.delete-comment').forEach(button => {
        button.addEventListener('click', function () {
            const commentId = this.getAttribute('data-comment-id');
            const taskId = this.getAttribute('data-task-id');
            const groupId = this.getAttribute('data-group-id');
            const orgId = this.getAttribute('data-org-id');

            // Show confirmation dialog
            if (confirm("Are you sure you want to delete this comment?")) {
                fetch(`/tasks/tasks/${orgId}/${groupId}/${taskId}/${commentId}/delete_comment/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.message) {
                        // Remove the deleted comment from the list
                        const commentItem = document.getElementById(`comment-${commentId}`);
                        commentItem.remove();

                     
                        showNotification('The comment deletion was successful.')
                    } else {
                        alert(data.error);
                    }
                })
                .catch(error => console.error('Error:', error));
            }
        });
    });
});

// CSRF Token Helper Function
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Greeting
document.addEventListener('DOMContentLoaded', function() {
            // Function to get current hour
            function getGreeting() {
                const currentHour = new Date().getHours();  // Get current hour (0-23)
                let greetingMessage = '';

                // Determine the appropriate greeting based on the time of day
                if (currentHour >= 5 && currentHour < 12) {
                    greetingMessage = 'Good Morning, {{request.user}}!';
                } else if (currentHour >= 12 && currentHour < 17) {
                    greetingMessage = 'Good Afternoon, {{request.user}}!';
                } else if (currentHour >= 17 && currentHour < 21) {
                    greetingMessage = 'Good Evening, {{request.user}}!';
                } else {
                    greetingMessage = 'Good Night, {{request.user}}!';
                }

                // Display the greeting
                document.getElementById('greeting').textContent = greetingMessage;
            }

            // Call the function when the page loads
            getGreeting();
        });

// Current date 

document.addEventListener("DOMContentLoaded", function () {
        // Get current date
        const now = new Date();

        // Format the date
        const dayOfWeek = now.toLocaleString('en-us', { weekday: 'short' }); // "Fri"
        const day = now.getDate(); // "10"
        const month = now.toLocaleString('en-us', { month: 'long' }); // "January"
        const year = now.getFullYear(); // "2025"

        // Create the formatted date string
        const formattedDate = `${dayOfWeek} ${day} ${month}`;

        // Display the date
        const currentDateElement = document.getElementById("current-date");
        currentDateElement.innerHTML = formattedDate;
    });




// FETCH AND MANAGE THE TASKS ATTACHMENTS
document.addEventListener("DOMContentLoaded", () => {
    const modal = document.getElementById("premiumAttachmentsModal");
    const attachmentsContainer = document.getElementById("attachmentsContainer");

    let selectedOrgId = null;
    let selectedGroupId = null;
    let selectedTaskId = null;

    // üìå Open Modal & Fetch Attachments
    modal.addEventListener("show.bs.modal", (event) => {
        const button = event.relatedTarget;
        selectedOrgId = button.getAttribute("data-org-id");
        selectedGroupId = button.getAttribute("data-group-id");
        selectedTaskId = button.getAttribute("data-task-id");

        fetchAttachments();
    });

    // üìå Fetch Attachments via AJAX
    function fetchAttachments() {
        attachmentsContainer.innerHTML = `<p class="text-muted">Loading files...</p>`;

        fetch(`/tasks/fetch-task-attachments/${selectedOrgId}/${selectedGroupId}/${selectedTaskId}/`)
            .then(response => response.json())
            .then(data => {
                if (data.attachments.length === 0) {
                    attachmentsContainer.innerHTML = `<p class="text-muted">No attachments found.</p>`;
                    return;
                }

                let html = `
<div class="max-w-6xl mx-auto p-6 font-['Inter']">
    <div class="bg-white/30 backdrop-blur-lg rounded-2xl shadow-xl overflow-hidden border border-white/20">
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-black/10">
                    <tr class="text-left text-gray-700">
                        <th class="px-6 py-4 font-semibold uppercase text-sm tracking-wider">Name</th>
                        <th class="px-6 py-4 font-semibold uppercase text-sm tracking-wider">Category</th>
                        <th class="px-6 py-4 font-semibold uppercase text-sm tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-white/20">`;

data.attachments.forEach((file, index) => {
    html += `
                    <tr class="${index % 2 === 0 ? 'bg-white/5' : 'bg-black/5'} hover:bg-white/10 transition-colors duration-200">
                        <td class="px-6 py-4 text-gray-200 font-medium">${file.name}</td>
                        <td class="px-6 py-4">
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-indigo-100/30 text-indigo-400">
                                ${file.category}
                            </span>
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex items-center space-x-3">
                                <button onclick="previewFile('${file.file_url}', '${file.category}')" 
                                    class="p-2 hover:bg-white/20 rounded-lg transition-all duration-200 group"
                                    title="Preview">
                                    <span class="material-icons text-blue-400 group-hover:text-blue-300">visibility</span>
                                </button>
                                
                                <a href="${file.file_url}" download
                                    class="p-2 hover:bg-white/20 rounded-lg transition-all duration-200 group"
                                    title="Download">
                                    <span class="material-icons text-green-400 group-hover:text-green-300">download</span>
                                </a>
                                
                                <button class="retry-btn p-2 hover:bg-white/20 rounded-lg transition-all duration-200 group"
                                    data-id="${file.id}"
                                    title="Retry">
                                    <span class="material-icons text-yellow-400 group-hover:text-yellow-300">autorenew</span>
                                </button>
                                
                                <button onclick="deleteAttachment(${file.id})" 
                                    class="p-2 hover:bg-white/20 rounded-lg transition-all duration-200 group"
                                    title="Delete">
                                    <span class="material-icons text-red-400 group-hover:text-red-300">delete</span>
                                </button>
                            </div>
                        </td>
                    </tr>`;
});

html += `
                </tbody>
            </table>
        </div>
    </div>
</div>`;

attachmentsContainer.innerHTML = html;


                // Attach event listeners for Retry buttons
                document.querySelectorAll(".retry-btn").forEach(button => {
                    button.addEventListener("click", function () {
                        retryAttachment(this);
                    });
                });
            })
            .catch(error => {
                console.error("Error fetching attachments:", error);
                attachmentsContainer.innerHTML = `<p class="text-danger">Failed to load files.</p>`;
            });
    }

    // üìå Preview File
    window.previewFile = (fileUrl, category) => {
        let previewHTML = `<p class="text-muted">Preview not available.</p>`;

        if (category.toLowerCase().includes("image")) {
            previewHTML = `<img src="${fileUrl}" class="img-fluid rounded">`;
        } else if (category.toLowerCase().includes("video")) {
            previewHTML = `<video controls class="w-100"><source src="${fileUrl}" type="video/mp4"></video>`;
        } else if (category.toLowerCase().includes("audio")) {
            previewHTML = `<audio controls class="w-100"><source src="${fileUrl}" type="audio/mpeg"></audio>`;
        } else if (category.toLowerCase().includes("document") || category.toLowerCase().includes("pdf")) {
            previewHTML = `<iframe src="${fileUrl}" width="100%" height="500px"></iframe>`;
        } else if (category.toLowerCase().includes("code") || category.toLowerCase().includes("text")) {
            fetch(fileUrl)
                .then(response => response.text())
                .then(text => {
                    previewHTML = `<pre class="bg-light p-3 rounded">${text}</pre>`;
                    attachmentsContainer.innerHTML = previewHTML;
                })
                .catch(() => {
                    previewHTML = `<p class="text-danger">Error loading file preview.</p>`;
                    attachmentsContainer.innerHTML = previewHTML;
                });
            return;
        }

        attachmentsContainer.innerHTML = previewHTML;
    };

    // üìå Delete Attachment via AJAX
    window.deleteAttachment = (attachmentId) => {
        if (!confirm("Are you sure you want to delete this file?")) return;

        fetch(`/tasks/delete-task-attachment/${selectedOrgId}/${selectedGroupId}/${selectedTaskId}/${attachmentId}/`, {
            method: "POST",
            headers: { "X-CSRFToken": getCSRFToken() }
        })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                alert("File deleted successfully!");
                fetchAttachments();  // Refresh list after deletion
            } else {
                alert("Failed to delete file.");
            }
        })
        .catch(error => console.error("Delete Error:", error));
    };

    // üìå Retry Attachment (Send to Task Creator) with Loading Spinner
    function retryAttachment(button) {
        const attachmentId = button.getAttribute("data-id");

        // ‚úÖ Save original button text
        const originalText = button.innerHTML;

        // ‚úÖ Add loading spinner
        button.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Sending...`;
        button.disabled = true;

        fetch(`/tasks/retry-task-attachment/${selectedOrgId}/${selectedGroupId}/${selectedTaskId}/${attachmentId}/`, {
            method: "POST",
            headers: { "X-CSRFToken": getCSRFToken() }
        })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                alert("File successfully sent to task creator!");
            } else {
                alert("Retry failed. Please try again.");
            }
        })
        .catch(error => {
            console.error("Retry Error:", error);
            alert("An error occurred while sending the attachment.");
        })
        .finally(() => {
            // ‚úÖ Restore button text after request completes
            button.innerHTML = originalText;
            button.disabled = false;
        });
    }

    // üìå Get CSRF Token
    function getCSRFToken() {
        return document.cookie.split("; ").find(row => row.startsWith("csrftoken"))?.split("=")[1] || "";
    }
});


// WRITE CUSTOM QUERY TO THE MANAGER
document.addEventListener("DOMContentLoaded", () => {
    const queryModal = document.getElementById("queryModal");
    const queryForm = document.getElementById("queryForm");
    const querySubject = document.getElementById("querySubject");
    const queryTemplate = document.getElementById("queryTemplate");
    const queryMessage = document.getElementById("queryMessage");
    const queryLoading = document.getElementById("queryLoading");

    let selectedOrgId, selectedGroupId, selectedTaskId;

    // üìå Open Modal & Set IDs
    queryModal.addEventListener("show.bs.modal", (event) => {
        const button = event.relatedTarget;
        selectedOrgId = button.getAttribute("data-org-id");
        selectedGroupId = button.getAttribute("data-group-id");
        selectedTaskId = button.getAttribute("data-task-id");

        // Set hidden input fields
        document.getElementById("orgId").value = selectedOrgId;
        document.getElementById("groupId").value = selectedGroupId;
        document.getElementById("taskId").value = selectedTaskId;
    });

    // üìå Autofill message when selecting a template
    queryTemplate.addEventListener("change", () => {
        queryMessage.value = queryTemplate.value;
    });

    // üìå Handle Query Submission
    queryForm.addEventListener("submit", (event) => {
        event.preventDefault();

        // Get values
        const subject = querySubject.value.trim();
        const message = queryMessage.value.trim();
        if (!subject || !message) {
            alert("Please fill out all fields.");
            return;
        }

        // Show loading spinner
        queryLoading.classList.remove("d-none");

        fetch(`/tasks/send-task-query/${selectedOrgId}/${selectedGroupId}/${selectedTaskId}/`, {
            method: "POST",
            headers: {
                "X-CSRFToken": getCSRFToken(),
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ subject, message })
        })
        .then(response => response.json())
        .then(data => {
            queryLoading.classList.add("d-none");
            if (data.message) {
                alert("üì® Query sent successfully!");
                queryForm.reset(); // Reset form after success
            } else {
                alert("‚ö†Ô∏è Error sending query. Try again!");
            }
        })
        .catch(error => {
            console.error("Query Error:", error);
            queryLoading.classList.add("d-none");
            alert("‚ö†Ô∏è Something went wrong. Try again later!");
        });
    });

    // üìå Get CSRF Token Function
    function getCSRFToken() {
        return document.cookie.split("; ").find(row => row.startsWith("csrftoken"))?.split("=")[1] || "";
    }
});


// predifined templates selection
document.querySelectorAll('.template-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        document.getElementById('queryMessage').value = btn.dataset.template;
    });
});

// COMMUNICATE WITH MANAGER IN REAL TIME CHAT 


// COMMUNICATE BOTH USERS (MANAGER & THE TASK ACCOMPLISHER)
document.addEventListener("DOMContentLoaded", function () {
    let orgId, groupId, taskId;

    // Open Modal & Fetch Messages
    document.querySelectorAll(".start-chat-btn").forEach((btn) => {
        btn.addEventListener("click", function () {
            orgId = this.dataset.org;
            groupId = this.dataset.group;
            taskId = this.dataset.task;

            fetchMessages(orgId, groupId, taskId);
            new bootstrap.Modal(document.getElementById("taskChatModal")).show();
        });
    });

    // working on it

    // Fetch Messages & Files
    function fetchMessages(orgId, groupId, taskId) {
    fetch(`/tasks/fetch-task-messages/${orgId}/${groupId}/${taskId}/`)
        .then(response => response.json())
        .then(data => {
            const chatContainer = document.getElementById("chatMessages");
            chatContainer.innerHTML = "";

            if (data.messages.length > 0) {
                data.messages.forEach(msg => {
                    const messageElement = document.createElement("div");
                    messageElement.classList.add("flex", "gap-3", "p-3", "hover:bg-gray-50", "transition-colors");

                    let filePreview = "";
                    if (msg.file) {
                        const fileExt = msg.file.split('.').pop().toLowerCase();
                        const isImage = ["png", "jpg", "jpeg", "gif", "webp"].includes(fileExt);
                        const isVideo = ["mp4", "webm", "ogg"].includes(fileExt);

                        filePreview = `
                            <div class="mt-2 relative group">
                                ${isImage ? 
                                    `<img src="${msg.file}" class="rounded-lg shadow-sm max-w-[240px] cursor-zoom-in object-cover h-32" 
                                       data-file="${msg.file}">` :
                                 isVideo ?
                                    `<video class="rounded-lg max-w-[240px] cursor-pointer" data-file="${msg.file}">
                                        <source src="${msg.file}" type="video/${fileExt}">
                                     </video>` :
                                    `<div class="flex items-center gap-2 px-4 py-2 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors">
                                        <span class="text-xl">üìé</span>
                                        <a href="${msg.file}" target="_blank" class="font-medium text-gray-700">
                                            View File
                                        </a>
                                     </div>`
                                }
                                <div class="absolute bottom-2 right-2 bg-black/50 text-white rounded-full p-1 backdrop-blur-sm">
                                    <span class="material-icons text-sm">${isImage ? 'photo' : 'description'}</span>
                                </div>
                            </div>`;
                    }

                    messageElement.innerHTML = `
                        <div class="shrink-0">
                            <img src="${msg.profile}" alt="Profile" 
                                 class="w-10 h-10 rounded-full object-cover ring-2 ring-white shadow-sm">
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-baseline gap-2">
                                <span class="font-semibold text-gray-800">${msg.sender}</span>
                                <span class="text-sm text-gray-500">${msg.created_at}</span>
                            </div>
                            <p class="mt-1 text-gray-700 whitespace-pre-wrap">${msg.message}</p>
                            ${filePreview}
                        </div>
                    `;

                    chatContainer.appendChild(messageElement);
                });

                // Add event listener for file preview
                document.querySelectorAll(".cursor-zoom-in, .cursor-pointer").forEach((file) => {
                    file.addEventListener("click", function() {
                        openFilePreview(this.dataset.file);
                    });
                });

            } else {
                chatContainer.innerHTML = `
                    <div class="h-full flex items-center justify-center text-gray-400">
                        <div class="text-center">
                            <div class="text-2xl">üí¨</div>
                            <p class="mt-2 font-medium">No messages yet</p>
                        </div>
                    </div>`;
            }
        })
        .catch(err => console.error("Error fetching messages:", err));
}



    // OPEN FILE PREVIEW
    function openFilePreview(fileUrl) {
        const fileExt = fileUrl.split('.').pop().toLowerCase();
        let previewContent = "";

        if (["png", "jpg", "jpeg", "gif", "webp"].includes(fileExt)) {
            previewContent = `<img src="${fileUrl}" class="img-fluid rounded" style="max-width: 100%;">`;
        } else if (["mp4", "webm", "ogg"].includes(fileExt)) {
            previewContent = `<video controls class="w-100">
                                <source src="${fileUrl}" type="video/${fileExt}">
                                Your browser does not support the video tag.
                              </video>`;
        } else {
            previewContent = `<iframe src="${fileUrl}" class="w-100" style="height: 500px;"></iframe>`;
        }

        document.getElementById("filePreviewContent").innerHTML = previewContent;
        new bootstrap.Modal(document.getElementById("filePreviewModal")).show();
    }

    // Send Message (JSON-based)
    document.getElementById("sendChatMessage").addEventListener("click", function () {
        const messageInput = document.getElementById("chatMessageInput");
        const fileInput = document.getElementById("chatFileInput");
        const message = messageInput.value;
        const file = fileInput.files[0];

        if (!message && !file) {
            alert("Please enter a message or select a file.");
            return;
        }

        const reader = new FileReader();
        reader.onload = function (event) {
            const base64File = file ? event.target.result : null;

            fetch("/tasks/send-task-message/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCSRFToken(),
                },
                body: JSON.stringify({
                    task_id: taskId,
                    org_id: orgId,
                    group_id: groupId,
                    message: message,
                    file: base64File,
                    file_name: file ? file.name : null,
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    fetchMessages(orgId, groupId, taskId);
                    messageInput.value = "";
                    fileInput.value = "";
                } else {
                    alert("Error sending message: " + data.error);
                }
            })
            .catch(err => console.error("Error sending message:", err));
        };

        if (file) {
            reader.readAsDataURL(file);
        } else {
            reader.onload();
        }
    });

    // DELETE ALL MESSAGES
    document.getElementById("deleteAllMessages").addEventListener("click", function () {
        if (confirm("Are you sure you want to delete all your messages?")) {
            fetch(`/tasks/delete-task-messages/${orgId}/${groupId}/${taskId}/`, {
                method: "DELETE",
                headers: {
                    "X-CSRFToken": getCSRFToken(),
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    fetchMessages(orgId, groupId, taskId);
                } else {
                    alert("Error deleting messages: " + data.error);
                }
            })
            .catch(err => console.error("Error deleting messages:", err));
        }
    });

    // export task chat
    document.getElementById("exportChat").addEventListener("click", function () {
    const exportUrl = `/tasks/export-task-chat/${orgId}/${groupId}/${taskId}/`;

    fetch(exportUrl, {
        method: "GET",
        headers: {
            "X-CSRFToken": getCSRFToken(),
        },
    })
    .then(response => {
        if (response.ok) {
            return response.blob();
        }
        throw new Error("Failed to export chat");
    })
    .then(blob => {
        const downloadUrl = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = downloadUrl;
        a.download = `task_chat_${taskId}.pdf`;
        document.body.appendChild(a);
        a.click();
        a.remove();
    })
    .catch(err => console.error("Error exporting chat:", err));
});


    // Get CSRF Token
    function getCSRFToken() {
        return document.cookie.split("; ")
            .find(row => row.startsWith("csrftoken"))
            ?.split("=")[1];
    }
});


// handle messages search input
function searchMessages() {
    let input = document.getElementById("searchMessages").value.toLowerCase();
    let messages = document.querySelectorAll("#chatMessages > div");  
    let noMessages = document.getElementById("noMessages");
    let found = false;  

    messages.forEach(msg => {
        let text = msg.innerText.toLowerCase();
        if (text.includes(input)) {
            msg.style.display = "flex";  // Keep flex for alignment
            found = true;
        } else {
            msg.style.display = "none";
        }
    });

    noMessages.style.display = found ? "none" : "block";
}

// Function to Render Messages with Profile Pictures
function renderMessages(messages) {
    let chatMessages = document.getElementById("chatMessages");
    chatMessages.innerHTML = ""; // Clear previous messages

    if (messages.length === 0) {
        chatMessages.innerHTML = `<p class="text-sm text-gray-500 text-center py-4">No messages found</p>`;
        return;
    }

    messages.forEach(msg => {
        let profilePic = msg.profile !== "No url" ? msg.profile : "default-profile.png"; // Use default if no profile pic
        let messageElement = document.createElement("div");
        messageElement.classList.add("flex", "items-start", "gap-3", "p-2", "bg-white", "rounded-lg", "shadow-sm");

        messageElement.innerHTML = `
            <img src="${profilePic}" alt="Profile" class="w-10 h-10 rounded-full object-cover border border-gray-300">
            <div>
                <strong class="block text-gray-800">${msg.sender}</strong>
                <p class="text-gray-600">${msg.message}</p>
                <small class="text-muted d-block">${msg.created_at}</small>
            </div>
        `;

        chatMessages.appendChild(messageElement);
    });
}














// stopwatrch functions
startStopBtn.addEventListener('click', toggleStopwatch);
resetBtn.addEventListener('click', resetStopwatch);

    </script>

    


</body>
</html>


