{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ task.title }} - Task Details</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">


    <!-- Dark Theme -->
    <style>
        body {
            background-color: #121212;
            color: #ffffff;
        }
        .task-container {
            margin: 20px auto;
            background-color: #1e1e1e;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            padding: 20px;
            max-width: 800px;
        }
        .task-icon {
            font-size: 2rem;
            color: #f39c12;
        }
        .btn-back {
            color: #ffffff;
            background-color: #007bff;
            border: none;
            transition: background-color 0.3s;
        }
        .btn-back:hover {
            background-color: #0056b3;
        }


       /* Import Google Fonts */
@import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');
@import url('https://fonts.googleapis.com/icon?family=Material+Icons');

/* Dark sidebar styling */
.activity-logs-sidebar {
    position: fixed;
    top: 0;
    right: -400px;  /* Hidden initially */
    width: 400px;
    height: 100%;
    background-color: #333;
    color: white;
    font-family: 'Roboto', sans-serif;  /* Use Roboto font */
    transition: right 0.3s ease;
    z-index: 999;
    box-shadow: -5px 0 15px rgba(0, 0, 0, 0.5);
}

/* Sidebar content */
.sidebar-content {
    padding: 15px;
    overflow-y: auto;
}

/* Activity logs container */
.activity-logs-container {
    max-height: calc(100% - 100px);
    overflow-y: auto;
    margin-top: 10px;
}

/* Individual activity log item */
.activity-log {
    margin-bottom: 12px;
    padding: 12px;
    background-color: #444;
    border-radius: 5px;
    font-size: 14px;  /* Smaller font size */
    font-family: 'Roboto', sans-serif;
}

/* Title of activity log */
.activity-log h5 {
    margin: 0;
    font-weight: 500;
    font-size: 16px;  /* Reduced title font size */
    color: #FFD700;  /* Gold color for the title */
}

/* Description of activity log */
.activity-log p {
    margin: 5px 0;
    color: #ddd;  /* Lighter color for description */
    font-weight: 400;
    font-size: 13px;  /* Reduced font size for description */
}

/* Button to close the sidebar */
#closeSidebarButton {
    background-color: #f8f9fa;
    border: none;
    color: #333;
    font-size: 16px;  /* Slightly reduced button font size */
    padding: 8px 12px;
    border-radius: 5px;
    font-weight: 600;
    font-family: 'Roboto', sans-serif;
}

/* Bu
/* Material Icon for activity log button */
#activityLogsButton i {
    font-size: 22px;  /* Smaller size for the icon */
}

/* When sidebar is open, bring it to the right */
.activity-logs-sidebar.open {
    right: 0;
}

/* Apply hover effects for buttons */
#activityLogsButton:hover {
    background-color: #0056b3;
    cursor: pointer;
}

#closeSidebarButton:hover {
    background-color: #e2e6ea;
    curs.form-check-input {
    width: 50px;
    height: 25px;
    background-color: #ccc;
    border: none;
    transition: background-color 0.3s ease;
}

.form-check-input:checked {
    background-color: #28a745; /* Green when checked */
}

.form-check-label {
    margin-left: 10px;
    font-size: 14px;
    color: #333;
}
or: pointer;
}





    </style>
</head>
<body>

<!-- Modal to add notes  -->

<!-- Modal to add note -->
<div class="modal fade" id="addNoteModal" tabindex="-1" aria-labelledby="addNoteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addNoteModalLabel">Add Note</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <textarea id="noteText" class="form-control" rows="4" placeholder="Enter your note"></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="saveNoteButton">Save Note</button>
            </div>
        </div>
    </div>
</div>







    <div class="container">
        <div class="task-container">
            <h1 class="mb-4"><i class="bi bi-list-task task-icon"></i> {{ task.title }}</h1>
            <p><strong>Description:</strong> {{ task.description }}</p>
            <p><strong>Priority:</strong> <span class="badge bg-danger">{{ task.priority }}</span></p>
            <p><strong>Deadline:</strong> {{ task.deadline }}</p>
            <p><strong>Progress:</strong></p>
<div class="progress mb-3">
    <div id="progressBar" class="progress-bar bg-success" role="progressbar" 
         style="width: {{ task.progress }}%" 
         aria-valuenow="{{ task.progress }}" 
         aria-valuemin="0" 
         aria-valuemax="100">{{ task.progress }}%</div>
</div>

<div class="progress-controls">
    <button id="decreaseProgress" class="btn btn-secondary btn-sm">-</button>
    <button id="increaseProgress" class="btn btn-primary btn-sm">+</button>
</div>
<br>

<!-- Activity log  -->

<!-- Activity Logs Icon -->
<button id="activityLogsButton" class="btn btn-dark">
    <i class="bi bi-list-check"></i> Activity Logs
</button>

<!-- mark as completed  -->
<div class="form-check form-switch">
    <input 
        class="form-check-input" 
        type="checkbox" 
        role="switch" 
        id="toggleTaskStatus" 
        data-task-id="{{ task.id }}" 
        data-org-id="{{ org_id }}" 
        data-group-id="{{ group_id }}" 
        {% if task.status == 'completed' %} checked {% endif %}>
    <label class="form-check-label" for="toggleTaskStatus">
        {% if task.status == 'completed' %}
            Mark as Pending
        {% else %}
            Mark as Completed
        {% endif %}
    </label>
</div>




            <hr>
            <h4>Additional Features</h4>

            <!-- Displaying tags -->
            <p><strong>Tags:</strong>
                {% if task.tags.all %}
                    {% for tag in task.tags.all %}
                        <span class="badge bg-warning">{{ tag.name }}</span>
                    {% endfor %}
                {% else %}
                    <span class="badge bg-secondary">No tags</span>
                {% endif %}
            </p>



            <!-- Track the time -->

           <!-- Displaying Time Spent -->
         <!-- Displaying Time Spent -->
<p><strong>Time Spent:</strong>
    {% if formatted_time %}
        <span id="timeSpent">{{ formatted_time }}</span>
    {% else %}
        <span id="timeSpent">00:00:00</span>
    {% endif %}
</p>

<!-- Timer Control Button (Icon) -->
<button id="startStopButton" class="btn btn-primary" onclick="toggleTimer()">
    <i id="timerIcon" class="bi bi-play-circle"></i> <!-- Play Icon for start -->
    Track Time
</button>

        
        


           


            

            <!-- Displaying notes -->
        <p><strong>Notes:</strong>
           {% if task.notes.all %}
             <ul id="taskNotesList">
                {% for note in task.notes.all %}
                <li><strong>{{ note.user.username }}:</strong> {{ note.note }} ({{ note.created_at|date:"F j, Y, g:i a" }})</li>
              {% endfor %}
           </ul>
        <!-- Button to open the modal -->
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addNoteModal">
            Add Note
        </button>
    {% else %}
        <span>No notes yet.</span>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addNoteModal">
            Add Note
        </button>
    {% endif %}
</p>



            <!-- Displaying comments -->
            <p><strong>Comments:</strong>
                {% if task.comments.all %}
                    <ul id="comments-list">
                        {% for comment in task.comments.all %}
                            <li><strong>{{ comment.user.username }}:</strong> {{ comment.comment }} ({{ comment.created_at|date:"F j, Y, g:i a" }})</li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <span>No comments yet.</span>
                {% endif %}
            </p>

            <!-- Comment Input -->
            <div class="form-group">
                <textarea id="comment-text" class="form-control" rows="3" placeholder="Add your comment..."></textarea>
            </div>
            <button id="submit-comment" class="btn btn-primary mt-2" 
                    data-org-id="{{ org_id }}" data-group-id="{{ group_id }}" data-task-id="{{ task.id }}">
                Add Comment
            </button>

        </div>
    </div>



    <!-- Modal for activity logs  -->

    <!-- Sidebar for Activity Logs -->
<div id="activityLogsSidebar" class="activity-logs-sidebar">
    <div class="sidebar-content">
        <button id="closeSidebarButton" class="btn btn-light">Close</button>
        <h3>Activity Logs</h3>
        <div id="activityLogsContainer" class="activity-logs-container">
            <!-- Activity logs will be loaded here -->
        </div>
    </div>
</div>







    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
       $(document).ready(function() {
    $('#submit-comment').click(function() {
        var commentText = $('#comment-text').val().trim();
        if (commentText == "") {
            alert("Please write a comment before submitting.");
            return;
        }

        var orgId = $(this).data('org-id');
        var groupId = $(this).data('group-id');
        var taskId = $(this).data('task-id');

        // Construct the URL using JavaScript
        var url = '/tasks/task/' + orgId + '/' + groupId + '/' + taskId + '/add_comment/';

        // Send the comment via AJAX
        $.ajax({
            type: 'POST',
            url: url,
            data: {
                'comment': commentText,
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response) {
                // Append new comment to the list
                $('#comments-list').append('<li><strong>' + response.username + ':</strong> ' + response.comment + ' (' + response.created_at + ')</li>');

                // Clear the comment text area
                $('#comment-text').val('');
            },
            error: function(xhr, errmsg, err) {
                alert("Error submitting comment. Please try again.");
            }
        });
    });
});


// Handle add note featue
// JavaScript to handle the AJAX request for adding a note
document.getElementById("saveNoteButton").addEventListener("click", function() {
    // Fetch the task ID, org ID, and group ID from template context
    var taskId = '{{ task.id }}';
    var orgId = '{{ org_id }}';
    var groupId = '{{ group_id }}';

    // Get the note content
    var noteContent = document.getElementById("noteText").value;

    if (noteContent.trim() === "") {
        alert("Please enter a note!");
        return;
    }

    // Construct the URL dynamically using JavaScript syntax
    var url = "/tasks/task/" + orgId + "/" + groupId + "/" + taskId + "/add_note/";

    // Send the note via AJAX
    $.ajax({
        type: 'POST',
        url: url,
        data: {
            'note': noteContent,
            'csrfmiddlewaretoken': '{{ csrf_token }}' // CSRF token for security
        },
        success: function(response) {
            // Close the modal
            $('#addNoteModal').modal('hide');

            // Append the new note to the list of notes (or update UI as needed)
            var newNote = "<li><strong>You:</strong> " + response.note + " (" + response.created_at + ")</li>";
            document.querySelector("#taskNotesList").insertAdjacentHTML('beforeend', newNote);

            // Clear the textarea
            document.getElementById("noteText").value = "";
        },
        error: function(xhr, status, error) {
            alert("Error while adding note: " + error);
        }
    });
});

// Handle the timer
function toggleTimer() {
    var taskId = '{{ task.id }}';
    var orgId = '{{ org_id }}';
    var groupId = '{{ group_id }}';
    var button = document.getElementById("startStopButton");
    var icon = document.getElementById("timerIcon");
    
    // Check if timer is running by reading button text
    var isRunning = button.innerText.toLowerCase() === "stop timer";

    // Set action to either start or stop based on current button state
    var action = isRunning ? "stop" : "start";

    // Make AJAX request to start/stop timer
    $.ajax({
        type: 'POST',
        url: '/tasks/task/' + orgId + '/' + groupId + '/' + taskId + '/manage_timer/',
        data: {
            'action': action,  // send the action (start/stop)
            'csrfmiddlewaretoken': '{{ csrf_token }}'  // CSRF token for security
        },
        success: function(response) {
            if (response.status === 'started') {
                button.innerText = "Stop Timer";  // Change button text to "Stop Timer"
                icon.classList.remove("bi-play-circle");  // Remove play icon
                icon.classList.add("bi-pause-circle");   // Add pause icon
                startTimerDisplay();  // Start updating the time display
            } else if (response.status === 'stopped') {
                button.innerText = "Start Timer";  // Change button text back to "Start Timer"
                icon.classList.remove("bi-pause-circle");  // Remove pause icon
                icon.classList.add("bi-play-circle");      // Add play icon
                stopTimerDisplay();  // Stop updating the time display
            }
        },
        error: function(xhr, status, error) {
            alert("Error: " + error);
        }
    });
}

function startTimerDisplay() {
    // Implement the timer countdown functionality in real-time
    var timeSpent = document.getElementById("timeSpent");
    var startTime = Date.now();  // Capture the start time when the timer starts
    
    // Update time every second
    var timerInterval = setInterval(function() {
        var elapsedTime = Date.now() - startTime;
        var seconds = Math.floor((elapsedTime / 1000) % 60);
        var minutes = Math.floor((elapsedTime / 60000) % 60);
        var hours = Math.floor((elapsedTime / 3600000) % 24);
        
        // Format time as HH:mm:ss
        timeSpent.innerText = formatTime(hours, minutes, seconds);
    }, 1000);
    
    // Store interval ID to clear it when stopping the timer
    window.timerInterval = timerInterval;
}

function stopTimerDisplay() {
    // Clear the interval and stop updating the time display
    clearInterval(window.timerInterval);
}

function formatTime(hours, minutes, seconds) {
    // Format time to be displayed as HH:mm:ss
    return (hours < 10 ? "0" + hours : hours) + ":" + 
           (minutes < 10 ? "0" + minutes : minutes) + ":" + 
           (seconds < 10 ? "0" + seconds : seconds);
}


// handle the progress

document.getElementById('increaseProgress').addEventListener('click', function () {
    updateProgress(10); // Increase by 10
});

document.getElementById('decreaseProgress').addEventListener('click', function () {
    updateProgress(-10); // Decrease by 10
});

function updateProgress(delta) {
    const progressBar = document.getElementById('progressBar');
    const currentProgress = parseInt(progressBar.getAttribute('aria-valuenow'));
    const newProgress = Math.min(100, Math.max(0, currentProgress + delta)); // Ensure between 0 and 100

    $.ajax({
        type: 'POST',
        url: '/tasks/tasks/{{ org_id }}/{{ group_id }}/{{ task.id }}/update_progress/',
        data: {
            'progress': newProgress,
            'csrfmiddlewaretoken': '{{ csrf_token }}'
        },
        success: function (response) {
            if (response.status === 'success') {
                progressBar.style.width = response.progress + '%';
                progressBar.setAttribute('aria-valuenow', response.progress);
                progressBar.textContent = response.progress + '%';
            } else {
                alert(response.message || 'An error occurred.');
            }
        },
        error: function (xhr, status, error) {
            alert('Error: ' + error);
        }
    });
}

// Handle activity logs

$(document).ready(function () {
    // Handle the click event to open the sidebar
    $('#activityLogsButton').click(function () {
        // Fetch activity logs via AJAX when the sidebar is opened
        var orgId = '{{ org_id }}';
        var groupId = '{{ group_id }}';
        var taskId = '{{ task.id }}';

        $.ajax({
            type: 'GET',
            url: '/tasks/tasks/' + orgId + '/' + groupId + '/' + taskId + '/activity_logs/',
            success: function (response) {
                if (response.status === 'success') {
                    loadActivityLogs(response.activity_logs);
                    // Show the sidebar
                    $('#activityLogsSidebar').css('right', '0');
                } else {
                    alert('Error: ' + response.message);
                }
            },
            error: function (xhr, status, error) {
                alert('Error fetching activity logs: ' + error);
            }
        });
    });

    // Handle the close button click to hide the sidebar
    $('#closeSidebarButton').click(function () {
        $('#activityLogsSidebar').css('right', '-400px');
    });

    // Function to load activity logs into the sidebar
    function loadActivityLogs(logs) {
        var container = $('#activityLogsContainer');
        container.empty();  // Clear any existing logs

        // Loop through and display each log
        logs.forEach(function (log) {
            var logElement = `
                <div class="activity-log">
                    <h5>${log.action}</h5>
                    <p>${log.details}</p>
                    <small>${log.created_at}</small>
                </div>
            `;
            container.append(logElement);
        });
    }
});


// Handle task toggle as completed

document.getElementById('toggleTaskStatus').addEventListener('change', function () {
    const taskId = this.getAttribute('data-task-id');
    const orgId = this.getAttribute('data-org-id');
    const groupId = this.getAttribute('data-group-id');
    const isChecked = this.checked;

    // Determine the action based on the toggle state
    const action = isChecked ? 'completed' : 'pending';

    // Send an AJAX request
    fetch(`/tasks/tasks/${orgId}/${groupId}/${taskId}/toggle_status/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken(), // Ensure you include your CSRF token
        },
        body: JSON.stringify({ status: action }),
    })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Update the label text
                document.querySelector('label[for="toggleTaskStatus"]').textContent = 
                    isChecked ? 'Mark as Pending' : 'Mark as Completed';
            } else {
                alert('Failed to update task status.');
                this.checked = !isChecked; // Revert the toggle state
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred.');
            this.checked = !isChecked; // Revert the toggle state
        });
});

// Function to get the CSRF token
function getCSRFToken() {
    const name = 'csrftoken';
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.startsWith(name + '=')) {
            return cookie.substring(name.length + 1);
        }
    }
    return '';
}



    </script>

</body>
</html>

