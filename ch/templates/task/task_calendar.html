<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ group.name }} Tasks</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: #f8fafc;
        }
        .font-display {
            font-family: 'Space Grotesk', sans-serif;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .priority-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
          /* Material Design Inspired Buttons */
    .btn-material-primary {
      @apply px-5 py-2.5 rounded-lg font-medium text-white bg-blue-600 
             hover:bg-blue-700 focus:ring-4 focus:ring-blue-200 
             transition-all shadow-sm hover:shadow-md
             flex items-center gap-2;
    }
  
    .btn-icon {
      @apply p-2 rounded-full transition-colors;
    }
  
    .btn-icon-close {
      @apply p-2 rounded-full text-gray-500 hover:bg-gray-100 transition-colors;
    }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50/50 to-purple-50/50 min-h-screen">
    <!-- Header -->
    <header class="bg-gradient-to-r from-blue-600 to-purple-600 text-white pt-16 pb-24 px-4 shadow-xl">
        <div class="max-w-6xl mx-auto">
            <div class="text-center space-y-4">
                <h1 class="font-display text-4xl font-bold tracking-tight">{{ group.name }} Tasks</h1>
                <p class="text-lg text-blue-100/90 max-w-2xl mx-auto leading-relaxed">
                    Manage your assigned tasks efficiently. Track progress, meet deadlines, and collaborate seamlessly with your team.
                </p>
            </div>
        </div>
    </header>

    <main class="max-w-6xl mx-auto -mt-12 px-4">
        <!-- Controls Section -->
        <div class="glass-card rounded-2xl p-6 mb-8 shadow-lg flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
            <button class="bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 text-white px-6 py-2.5 rounded-xl font-medium flex items-center gap-2 transition-all transform hover:scale-[1.02]"
                data-bs-toggle="offcanvas" data-bs-target="#learnMoreSidebar">
                <span class="material-icons-round text-lg">help_outline</span>
                Quick Guide
            </button>
            
             <!-- Controls Bar -->
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-8">
            
            
            <div class="glass-effect bg-white/80 p-2 rounded-xl">
                <form method="get" class="flex items-center gap-3">
                    <span class="text-sm font-medium text-gray-600">Priority Filter:</span>
                    <select class="form-select bg-transparent border-none focus:ring-2 focus:ring-blue-500/30 rounded-lg px-4 py-2 text-gray-700"
                            name="priority" onchange="this.form.submit()">
                        <option value="">All</option>
                        <option value="low" {% if request.GET.priority == 'low' %}selected{% endif %}>Low</option>
                        <option value="medium" {% if request.GET.priority == 'medium' %}selected{% endif %}>Medium</option>
                        <option value="high" {% if request.GET.priority == 'high' %}selected{% endif %}>High</option>
                        <option value="urgent" {% if request.GET.priority == 'urgent' %}selected{% endif %}>Urgent</option>
                    </select>
                </form>
            </div>
        </div>

        </div>

        <!-- Tasks Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-12">
            {% for task in tasks %}
            <div class="glass-card group relative rounded-2xl p-6 shadow-md hover:shadow-lg transition-shadow duration-300">
                <!-- Priority Indicator -->
                <div class="absolute top-6 right-6">
                    <span class="priority-badge 
                        {% if task.priority == 'urgent' %}bg-red-100 text-red-800
                        {% elif task.priority == 'high' %}bg-orange-100 text-orange-800
                        {% elif task.priority == 'medium' %}bg-yellow-100 text-yellow-800
                        {% else %}bg-green-100 text-green-800{% endif %}">
                        {{ task.priority }}
                    </span>
                </div>

                <!-- Task Content -->
                <div class="space-y-5">
                    <div>
                        <h3 class="text-xl font-semibold text-gray-800 mb-1">{{ task.title }}</h3>
                        <p class="text-gray-600 text-sm leading-relaxed">{{ task.description }}</p>
                    </div>

                    <!-- Metadata -->
                    <div class="space-y-3">
                        <div class="flex items-center gap-3 text-gray-500">
                            <span class="material-icons-round text-blue-500">calendar_today</span>
                            <span class="text-sm">{{ task.start }}</span>
                        </div>
                        <div class="flex items-center gap-3 text-gray-500">
                            <span class="material-icons-round text-purple-500">schedule</span>
                            <span class="text-sm">Due in 3 days</span>
                        </div>
                    </div>

                    <!-- Progress Bar -->
                    <div>
                        <div class="flex justify-between text-sm mb-2">
                            <span class="text-gray-600">Progress</span>
                            <span class="font-medium text-blue-600">{{ task.progress }}%</span>
                        </div>
                        <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                            <div class="h-full bg-gradient-to-r from-blue-400 to-purple-400 rounded-full transition-all duration-500" 
                                 style="width: {{ task.progress }}%"></div>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="flex items-center justify-between pt-4 border-t border-gray-100">
                        <div class="flex items-center gap-2">
                            <button class="p-2 hover:bg-gray-100 rounded-lg text-gray-500 hover:text-gray-700 transition-colors"
                                onclick="toggleDropdown('{{ task.id }}')">
                                <span class="material-icons-round">more_vert</span>
                            </button>
                            <div class="flex items-center gap-1 text-sm text-gray-500">
                                <span class="material-icons-round text-sm">comment</span>
                                5
                            </div>
                        </div>
                        
                        <div class="flex items-center gap-2">
                            {% if task.in_my_day %}
                            <button class="px-4 py-1.5 bg-green-100 text-green-700 rounded-full text-sm font-medium flex items-center gap-2">
                                <span class="material-icons-round text-sm">check_circle</span>
                                Added
                            </button>
                            {% else %}
                            <button class="px-4 py-1.5 bg-blue-100 text-blue-700 hover:bg-blue-200 rounded-full text-sm font-medium flex items-center gap-2 transition-colors"
                                    onclick="addToMyDay('{{ group.organization.id }}', '{{ group.id }}', '{{ task.id }}')">
                                <span class="material-icons-round text-sm">add_task</span>
                                Add to Day
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Dropdown Menu -->
                <div id="dropdownMenu{{ task.id }}" class="absolute right-6 top-16 hidden w-48 bg-white border border-gray-200 rounded-xl shadow-xl z-10 overflow-hidden">
                    <ul class="py-1.5">
                        <li>
                            <button class="w-full text-left px-4 py-2.5 hover:bg-gray-50 flex items-center gap-3 text-gray-700 text-sm font-medium transition-colors duration-200 ease-out">
                                <i class="material-icons-round text-blue-600 text-[20px]">visibility</i>
                                View Details
                            </button>
                        </li>
                        
                        {% if task.in_my_day %}
                            <li>
                                <a href="{% url 'task_detail' org_id=group.organization.id group_id=group.id task_id=task.id %}" 
                                   class="w-full text-left px-4 py-2.5 hover:bg-gray-50 flex items-center gap-3 text-green-600 text-sm font-medium transition-colors duration-200 ease-out">
                                    <i class="material-icons-round text-green-600 text-[20px]">launch</i>
                                    Launch Task
                                </a>
                            </li>
                        {% else %}
                            <li>
                                <button class="w-full text-left px-4 py-2.5 hover:bg-gray-50 flex items-center gap-3 text-amber-600 text-sm font-medium transition-colors duration-200 ease-out" 
                                        onclick="addToMyDay('{{ group.organization.id }}', '{{ group.id }}', '{{ task.id }}')">
                                    <i class="material-icons-round text-amber-600 text-[20px]">add_task</i>
                                    Add to My Day
                                </button>
                            </li>
                        {% endif %}
                        {% if extend_tasks %}
                          <li>
                              <button class="w-full text-left px-4 py-2 hover:bg-gray-100 flex items-center gap-2 text-red-600" 
                               data-bs-toggle="modal" data-bs-target="#cancelTaskModal" 
                               onclick="setCancelTaskData('{{ organization.id }}', '{{ group.id }}', '{{ task.id }}', '{{ task.title }}')">
                               <i class="material-icons-round">cancel</i>
                                Cancel Task
                             </button>
                         </li>

                         <li>
                            <button class="w-full text-left px-4 py-2 hover:bg-gray-100 flex items-center gap-2 text-blue-600" 
                            data-bs-toggle="modal" data-bs-target="#subTaskModal" 
                             onclick="setSubTaskData('{{ organization.id }}', '{{ group.id }}', '{{ task.id }}')">
                            <i class="material-icons-round">add_task</i>
                            Create SubTask
                             </button>
                         </li>
                         <li>
                            <button class="w-full text-left px-4 py-2 hover:bg-gray-100 flex items-center gap-2 text-purple-600"
                              data-bs-toggle="modal" data-bs-target="#manageSubTaskModal"
                             onclick="loadSubTasks('{{ organization.id }}', '{{ group.id }}', '{{ task.id }}')">
                           <i class="material-icons-round">playlist_add_check</i>
                           Manage SubTasks
                          </button>
                        </li>
                        <li>
                            <button class="w-full text-left px-4 py-2 hover:bg-gray-100 flex items-center gap-2 text-purple-600" 
                              data-bs-toggle="modal" data-bs-target="#exportTaskModal" 
                             onclick="exportTask('{{ organization.id }}', '{{ group.id }}', '{{ task.id }}')"> 
                           <i class="material-icons-round">playlist_add_check</i>
                            Export 
                          </button>
                        </li>

                        <li>
                            <button class="w-full text-left px-4 py-2 hover:bg-gray-100 flex items-center gap-2 text-purple-600" 
                             data-bs-toggle="modal" 
                             data-bs-target="#attachFileModal"
                             data-org-id="{{ organization.id }}"
                             data-group-id="{{ group.id }}"
                             data-task-id="{{ task.id }}">
                            <i class="material-icons-round">playlist_add_check</i>
                            Attach Files
                        </button>

                        </li>
                        {% endif %} 
                    </ul>

                </div>
            </div>
            {% endfor %}
        </div>

        <br><br><br><br><br>

        <!-- Pagination -->
        <div class="glass-card rounded-2xl p-4 mb-12 shadow-md">
            <nav class="flex items-center justify-between">
                <div class="flex items-center gap-1 text-gray-600">
                    <span class="text-sm">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
                </div>
                
                <div class="flex items-center gap-2">
                    {% if page_obj.has_previous %}
                    <a href="?page=1" class="p-2 hover:bg-gray-100 rounded-lg text-gray-500 hover:text-blue-600 transition-colors">
                        <span class="material-icons-round">first_page</span>
                    </a>
                    <a href="?page={{ page_obj.previous_page_number }}" class="p-2 hover:bg-gray-100 rounded-lg text-gray-500 hover:text-blue-600 transition-colors">
                        <span class="material-icons-round">chevron_left</span>
                    </a>
                    {% endif %}

                    {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}" class="p-2 hover:bg-gray-100 rounded-lg text-gray-500 hover:text-blue-600 transition-colors">
                        <span class="material-icons-round">chevron_right</span>
                    </a>
                    <a href="?page={{ page_obj.paginator.num_pages }}" class="p-2 hover:bg-gray-100 rounded-lg text-gray-500 hover:text-blue-600 transition-colors">
                        <span class="material-icons-round">last_page</span>
                    </a>
                    {% endif %}
                </div>
            </nav>
        </div>
    </main>

    <!-- Learn More Sidebar -->
    <div class="fixed inset-0 bg-black/50 z-50 hidden" id="learnMoreOverlay"></div>
    <div class="fixed top-0 right-0 h-full w-96 bg-white shadow-2xl transform translate-x-full transition-transform duration-300 z-50" 
         id="learnMoreSidebar">
        <div class="p-6 h-full flex flex-col">
            <!-- Header -->
            <div class="flex items-center justify-between mb-8">
                <h3 class="text-xl font-semibold text-gray-800 flex items-center gap-2">
                    <span class="material-icons-round text-blue-500">school</span>
                    Task Guide
                </h3>
                <button onclick="closeSidebar()" class="p-2 hover:bg-gray-100 rounded-lg text-gray-500">
                    <span class="material-icons-round">close</span>
                </button>
            </div>

            <!-- Content -->
            <div class="flex-1 overflow-y-auto space-y-6">
                <div class="space-y-4">
                    <h4 class="font-medium text-gray-800 flex items-center gap-2">
                        <span class="material-icons-round text-green-500">rocket_launch</span>
                        Getting Started
                    </h4>
                    <div class="space-y-3 text-gray-600 text-sm">
                        <p>Use priority levels to organize your workflow effectively. Start with urgent tasks and work your way down.</p>
                        <div class="p-4 bg-blue-50/50 rounded-xl">
                            <span class="text-xs font-medium text-blue-600">Pro Tip:</span>
                            <p class="mt-1">Add recurring tasks to "My Day" to build consistent work habits.</p>
                        </div>
                    </div>
                </div>

                <div class="space-y-4">
                    <h4 class="font-medium text-gray-800 flex items-center gap-2">
                        <span class="material-icons-round text-purple-500">priority_high</span>
                        Priority System
                    </h4>
                    <div class="grid grid-cols-2 gap-3 text-sm">
                        <div class="p-3 bg-red-50/50 rounded-xl">
                            <div class="flex items-center gap-2 mb-2">
                                <div class="w-2 h-2 bg-red-500 rounded-full"></div>
                                <span class="font-medium text-red-700">Urgent</span>
                            </div>
                            <p class="text-red-600/80">Immediate action required, critical deadlines</p>
                        </div>
                        <div class="p-3 bg-orange-50/50 rounded-xl">
                            <div class="flex items-center gap-2 mb-2">
                                <div class="w-2 h-2 bg-orange-500 rounded-full"></div>
                                <span class="font-medium text-orange-700">High</span>
                            </div>
                            <p class="text-orange-600/80">Important tasks needing attention</p>
                        </div>
                        <div class="p-3 bg-yellow-50/50 rounded-xl">
                            <div class="flex items-center gap-2 mb-2">
                                <div class="w-2 h-2 bg-yellow-500 rounded-full"></div>
                                <span class="font-medium text-yellow-700">Medium</span>
                            </div>
                            <p class="text-yellow-600/80">Regular priority tasks</p>
                        </div>
                        <div class="p-3 bg-green-50/50 rounded-xl">
                            <div class="flex items-center gap-2 mb-2">
                                <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                                <span class="font-medium text-green-700">Low</span>
                            </div>
                            <p class="text-green-600/80">Can be scheduled for later</p>
                        </div>
                    </div>
                </div>

                <div class="space-y-4">
                    <h4 class="font-medium text-gray-800 flex items-center gap-2">
                        <span class="material-icons-round text-blue-500">tips_and_updates</span>
                        Productivity Tips
                    </h4>
                    <div class="space-y-3 text-sm text-gray-600">
                        <div class="flex items-start gap-3">
                            <span class="material-icons-round text-blue-400 flex-shrink-0">check_circle</span>
                            <div>
                                <p class="font-medium">Daily Review</p>
                                <p class="text-sm">Start each day by reviewing priority tasks</p>
                            </div>
                        </div>
                        <div class="flex items-start gap-3">
                            <span class="material-icons-round text-purple-400 flex-shrink-0">timeline</span>
                            <div>
                                <p class="font-medium">Progress Tracking</p>
                                <p class="text-sm">Update task progress at least twice daily</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="pt-6 border-t border-gray-100">
                <button onclick="closeSidebar()" class="w-full py-2.5 px-4 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-xl text-sm font-medium transition-colors">
                    Close Guide
                </button>
            </div>
        </div>
    </div>
<!-- --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- -->
<!-- Extend Tasks APP modals -->
<!-- Cancel Task Modal -->
<div class="modal fade" id="cancelTaskModal" tabindex="-1" aria-labelledby="cancelTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered max-w-2xl">
        <div class="modal-content rounded-xl shadow-lg">
            <!-- Modal Header -->
            <div class="modal-header bg-red-50 rounded-t-xl p-6 border-b border-red-100">
                <div class="w-full">
                    <h5 class="modal-title text-2xl font-bold text-red-600 mb-2" id="cancelTaskModalLabel">
                        Cancel Task: <span id="cancelTaskTitle" class="break-words"></span>
                    </h5>
                    <p class="text-sm text-red-700 opacity-90">
                        We will notify your manager about this cancellation
                    </p>
                </div>
                <button type="button" class="btn-close opacity-70 hover:opacity-100" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <!-- Modal Body -->
            <div class="modal-body p-6 space-y-4">
                <label for="cancelReason" class="block text-base font-medium text-gray-700">
                    Please provide the reason for cancellation
                </label>
                <textarea 
                    id="cancelReason" 
                    class="form-control w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 placeholder-gray-400" 
                    rows="4"
                    placeholder="Describe the reason for canceling this task..."
                ></textarea>
            </div>

            <!-- Modal Footer -->
            <div class="modal-footer bg-gray-50 rounded-b-xl p-6 border-t border-gray-100">
                <button 
                    type="button" 
                    class="btn btn-secondary px-5 py-2.5 hover:bg-gray-200 transition-colors"
                    data-bs-dismiss="modal"
                >
                    Close
                </button>
                <button 
                    id="cancelTaskButton" 
                    class="btn btn-danger px-6 py-2.5 bg-red-600 hover:bg-red-700 text-white transition-colors flex items-center justify-center gap-2"
                    onclick="submitTaskCancellation()"
                >
                    <span id="loadingSpinner" class="hidden">
                        <i class="fas fa-spinner fa-spin"></i>
                    </span>
                    Confirm Cancellation
                </button>
            </div>
        </div>
    </div>
</div>

<!-- CREATE SUBTASK -->
<!-- SubTask Modal -->
<div class="modal fade" id="subTaskModal" tabindex="-1" aria-labelledby="subTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered max-w-3xl">
        <div class="modal-content rounded-xl shadow-lg">
            <!-- Modal Header -->
            <div class="modal-header bg-blue-50 rounded-t-xl p-6 border-b border-blue-100">
                <div class="w-full">
                    <h5 class="modal-title text-2xl font-bold text-blue-600 mb-1" id="subTaskModalLabel">
                        Create New SubTask
                    </h5>
                    <p class="text-sm text-blue-700 opacity-90">
                        Add detailed information for the subtask
                    </p>
                </div>
                <button type="button" class="btn-close opacity-70 hover:opacity-100" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <!-- Modal Body -->
            <div class="modal-body p-6 space-y-6">
                <form id="subTaskForm" class="space-y-4">
                    <!-- Title Input -->
                    <div class="space-y-2">
                        <label for="subTaskTitle" class="block text-base font-medium text-gray-700">
                            SubTask Title <span class="text-red-500">*</span>
                        </label>
                        <input 
                            type="text" 
                            id="subTaskTitle" 
                            required
                            class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 placeholder-gray-400"
                        >
                    </div>

                    <!-- Description Input -->
                    <div class="space-y-2">
                        <label for="subTaskDescription" class="block text-base font-medium text-gray-700">
                            Description (Optional)
                        </label>
                        <textarea 
                            id="subTaskDescription" 
                            rows="3"
                            class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 placeholder-gray-400"
                        ></textarea>
                    </div>

                    <!-- Priority Select -->
                    <div class="space-y-2">
                        <label for="subTaskPriority" class="block text-base font-medium text-gray-700">
                            Priority Level
                        </label>
                        <select 
                            id="subTaskPriority" 
                            class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white"
                        >
                            <option value="low" class="text-green-600">Low</option>
                            <option value="medium" selected class="text-yellow-600">Medium</option>
                            <option value="high" class="text-orange-600">High</option>
                            <option value="urgent" class="text-red-600">Urgent</option>
                        </select>
                    </div>

                    <!-- Deadline Input -->
                    <div class="space-y-2">
                        <label for="subTaskDeadline" class="block text-base font-medium text-gray-700">
                            Deadline <span class="text-red-500">*</span>
                        </label>
                        <input 
                            type="datetime-local" 
                            id="subTaskDeadline" 
                            required
                            class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white"
                        >
                    </div>

                    <!-- Submit Button -->
                    <div class="pt-4">
                        <button 
                            type="submit" 
                            class="w-full btn btn-success px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg transition-colors flex items-center justify-center gap-2"
                        >
                            <span id="submitText">Create SubTask</span>
                            <span id="loadingSpinner" class="hidden">
                                <i class="fas fa-spinner fa-spin"></i>
                            </span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>


<!-- MANAGE SUBTASK MODAL  -->
<!-- Manage SubTask Modal -->
<div class="modal fade" id="manageSubTaskModal" tabindex="-1" aria-labelledby="manageSubTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
      <div class="modal-content rounded-xl shadow-2xl bg-white border border-gray-200">
        <!-- Modal Header -->
        <div class="modal-header px-6 py-4 bg-gray-50 border-b border-gray-200 rounded-t-xl">
          <div class="flex items-center justify-between w-full">
            <div>
              <h3 class="text-2xl font-semibold text-gray-800">
                <i class="material-icons-round text-blue-600 align-middle mr-2">list_alt</i>
                Manage Subtasks
              </h3>
              <p class="text-sm text-gray-500 mt-1">Manage subtasks for current workflow</p>
            </div>
            <div class="flex items-center gap-3">
              <!-- Add Task Button -->
              <button 
                  class="inline-flex items-center px-4 py-2.5 bg-blue-100 hover:bg-blue-200 text-blue-800 rounded-lg transition-colors duration-300 focus:ring-4 focus:ring-blue-200/50 focus:outline-none font-medium"
                  data-bs-toggle="modal" 
                  data-bs-target="#subTaskModal"
                 onclick="setSubTaskData('{{ organization.id }}', '{{ group.id }}', '{{ task.id }}')"
                    >
              <i class="material-icons-round text-base mr-2 text-blue-600">add_circle</i>
                CREATE SUBTASK
             </button>


              <button 
                type="button" 
                class="btn-icon-close"
                data-bs-dismiss="modal" 
                aria-label="Close"
              >
                <i class="material-icons-round">close</i>
              </button>
            </div>
          </div>
        </div>
  
        <!-- Modal Body -->
        <div class="modal-body p-6 bg-white">
          <div class="space-y-4">
            <h4 class="text-lg font-medium text-gray-700 mb-2">
              <i class="material-icons-round text-gray-500 mr-2">checklist</i>
              Existing Subtasks
            </h4>
            
            <!-- Subtask List -->
            <div id="subtaskList" class="grid gap-2 max-h-[60vh] overflow-y-auto pr-3">
              <!-- Loading State -->
              <div class="animate-pulse flex space-x-4">
                <div class="flex-1 space-y-4 py-1">
                  <div class="h-4 bg-gray-200 rounded w-3/4"></div>
                  <div class="space-y-2">
                    <div class="h-4 bg-gray-200 rounded"></div>
                    <div class="h-4 bg-gray-200 rounded w-5/6"></div>
                  </div>
                </div>
              </div>
  
              <!-- Subtask Item Example -->
              <div class="subtask-item group flex items-center gap-4 p-4 bg-white rounded-lg border border-gray-200 hover:border-blue-200 hover:shadow-sm transition-all">
                <div class="flex-1">
                  <div class="flex items-center gap-3">
                    <i class="material-icons-round text-gray-400 cursor-move hover:text-gray-600">drag_indicator</i>
                    <span class="font-medium text-gray-700">Design Homepage Layout</span>
                    <span class="px-2 py-1 text-xs font-medium rounded-full bg-blue-100 text-blue-800">In Progress</span>
                  </div>
                  <p class="text-sm text-gray-500 ml-8 mt-1">Create responsive design mockups for homepage sections</p>
                </div>
                <div class="flex items-center gap-2">
                  <button class="btn-icon text-gray-500 hover:bg-gray-100">
                    <i class="material-icons-round text-base">edit</i>
                  </button>
                  <button class="btn-icon text-gray-500 hover:bg-red-100 hover:text-red-600">
                    <i class="material-icons-round text-base">delete</i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>


<!-- EXPORT TASKS -->

<!-- EXPORT TASKS -->
 <!-- Export Task Modal -->
 <div id="exportTaskModal" class="modal fade" tabindex="-1" aria-labelledby="exportTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content p-4">
            <!-- Modal Header -->
            <div class="flex justify-between items-center">
                <h2 class="text-lg font-semibold">Export Task</h2>
                <button type="button" class="close text-gray-500 hover:text-gray-700" data-bs-dismiss="modal">
                    &times;
                </button>
            </div>

            <!-- Modal Body -->
            <div class="mt-4">
                <p class="text-gray-600">Choose how you want to export this task:</p>
                <div class="flex flex-col gap-3 mt-3">
                    <!-- Export via Email -->
                    <button id="export-email-btn"
                        class="w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 flex items-center gap-2">
                        <i class="material-icons-round">email</i> Send to Email
                    </button>

                    <!-- Export Now -->
                    <button id="export-now-btn"
                        class="w-full px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 flex items-center gap-2">
                        <i class="material-icons-round">download</i> Export Now
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ATTACH THE FILE TO THE TASK(PREMIUM) -->
<!-- 📌 Attach File Modal -->
<!-- 📌 Attach File Modal -->
<div id="attachFileModal" class="modal fade" tabindex="-1" aria-labelledby="attachFileLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <!-- Modal Header -->
            <div class="modal-header bg-purple-600 text-white">
                <h5 class="modal-title flex items-center gap-2">
                    <i class="material-icons-round">attach_file</i> Attach File to Task
                </h5>
                <button type="button" class="btn-close text-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <!-- Modal Body -->
            <div class="modal-body flex">
                <!-- 📂 Drag & Drop Upload Area (Left) -->
                <div class="w-1/2 pr-4">
                    <label class="block text-gray-700 font-medium">Upload File:</label>
                    <div id="dropArea" class="border-2 border-dashed rounded p-6 text-center cursor-pointer bg-gray-100">
                        <p class="text-gray-500">Drag & Drop a file here</p>
                        <p class="text-gray-500">or</p>
                        <input type="file" id="fileInput" class="hidden" accept="*/*">
                        <button type="button" class="bg-purple-600 text-white px-3 py-1 rounded mt-2"
                                onclick="document.getElementById('fileInput').click();">
                            Select File
                        </button>
                    </div>

                    <label class="block mt-3 text-gray-700 font-medium">File Name:</label>
                    <input type="text" id="fileName" class="w-full border p-2 rounded" placeholder="Enter file name">

                    <label class="block mt-3 text-gray-700 font-medium">Description:</label>
                    <textarea id="fileDescription" class="w-full border p-2 rounded" rows="2" placeholder="Enter description"></textarea>

                    <label class="block mt-3 text-gray-700 font-medium">Category:</label>
                    <select id="fileCategory" class="w-full border p-2 rounded">
                        <option value="document">Document</option>
                        <option value="image">Image</option>
                        <option value="code">Code File</option>
                        <option value="audio">Audio File</option>
                        <option value="video">Video File</option>
                        <option value="other">Other</option>
                    </select>

                    <label class="block mt-3 text-gray-700 font-medium flex items-center">
                        <input type="checkbox" id="isPrivate" class="mr-2"> Mark as Private
                    </label>

                    <label class="block mt-3 text-gray-700 font-medium flex items-center">
                        <input type="checkbox" id="sendCopyToManager" class="mr-2"> Send Copy to Manager
                    </label>
                </div>

                <!-- 📌 Real-Time File Preview (Right) -->
                <div class="w-1/2 border-l pl-4">
                    <h6 class="text-gray-700 font-medium">File Preview:</h6>
                    <div id="filePreview" class="border rounded p-2 mt-2 text-center bg-gray-100">
                        <p class="text-gray-500">No file selected</p>
                    </div>

                    <!-- 🔥 Upload Progress Bar -->
                    <div class="mt-3">
                        <h6 class="text-gray-700 font-medium">Upload Progress:</h6>
                        <div class="w-full bg-gray-200 rounded">
                            <div id="progressBar" class="bg-purple-600 text-white text-center p-1 rounded"
                                style="width: 0%">0%</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="modal-footer">
               
                <button type="button" id="uploadBtn" class="btn btn-secondary">Upload File</button>
            </div>
        </div>
    </div>
</div>



<!-- Bootstrap 5 JS (with Popper.js) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
        // Sidebar Toggle
        function toggleSidebar() {
            document.getElementById('learnMoreOverlay').classList.toggle('hidden');
            document.getElementById('learnMoreSidebar').classList.toggle('translate-x-full');
        }

        function closeSidebar() {
            document.getElementById('learnMoreOverlay').classList.add('hidden');
            document.getElementById('learnMoreSidebar').classList.add('translate-x-full');
        }

        // Dropdown Toggle
        function toggleDropdown(taskId) {
            const dropdown = document.getElementById(`dropdownMenu${taskId}`);
            dropdown.classList.toggle('hidden');
            
            // Close when clicking outside
            document.addEventListener('click', function close(e) {
                if (!dropdown.contains(e.target) && !e.target.closest(`[onclick="toggleDropdown('${taskId}')"]`)) {
                    dropdown.classList.add('hidden');
                    document.removeEventListener('click', close);
                }
            });
        }

        // Add to My Day
        function addToMyDay(orgId, groupId, taskId) {
            const csrfToken = "{{ csrf_token }}";
            fetch(`/tasks/add-to-my-day/${orgId}/${groupId}/${taskId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                }
            })
            .then(response => response.json())
            .then(data => {
                if(data.success) {
                    // Update UI
                    const button = document.querySelector(`[onclick="addToMyDay('${orgId}', '${groupId}', '${taskId}')"]`);
                    if(button) {
                        button.outerHTML = `
                            <button class="px-4 py-1.5 bg-green-100 text-green-700 rounded-full text-sm font-medium flex items-center gap-2">
                                <span class="material-icons-round text-sm">check_circle</span>
                                Added
                            </button>
                        `;
                    }
                }
            })
            .catch(error => console.error('Error:', error));
        }

        // Close sidebar when clicking overlay
        document.getElementById('learnMoreOverlay').addEventListener('click', closeSidebar);


// CANCEL THE TASK
let selectedOrgId = null;
    let selectedGroupId = null;
    let selectedTaskId = null;

    // Function to set task details when opening the cancel modal
    function setCancelTaskData(orgId, groupId, taskId, taskTitle) {
        selectedOrgId = orgId;
        selectedGroupId = groupId;
        selectedTaskId = taskId;

        document.getElementById("cancelTaskTitle").innerText = taskTitle;
    }

    // Function to get CSRF token from cookies
    function getCSRFToken() {
        let cookies = document.cookie.split("; ");
        for (let cookie of cookies) {
            let [name, value] = cookie.split("=");
            if (name === "csrftoken") return value;
        }
        return "";
    }

    // Function to submit task cancellation
    async function submitTaskCancellation() {
        const reason = document.getElementById("cancelReason").value.trim();
        const cancelButton = document.getElementById("cancelTaskButton");
        const spinner = document.getElementById("loadingSpinner");

        if (!reason) {
            alert("Please enter a reason for cancellation.");
            return;
        }

        // Disable button and show spinner
        cancelButton.disabled = true;
        spinner.classList.remove("hidden");

        try {
            const response = await fetch(`/tasks/cancel-task/${selectedOrgId}/${selectedGroupId}/${selectedTaskId}/`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCSRFToken()
                },
                body: JSON.stringify({ reason: reason })
            });

            const data = await response.json();

            if (data.success) {
                alert("Task has been canceled successfully.");
                location.reload();
            } else {
                alert("Error canceling task. Please try again.");
            }
        } catch (error) {
            console.error("Error:", error);
            alert("Something went wrong. Please try again.");
        } finally {
            // Enable button and hide spinner
            cancelButton.disabled = false;
            spinner.classList.add("hidden");
        }
    }




// CREATE SUBTASK
// Variables to store captured IDs
let orgId, groupId, taskId;

// Function to set task data when button is clicked
function setSubTaskData(org, group, task) {
    orgId = org;
    groupId = group;
    taskId = task;
}

// Run this only when the modal form is submitted
document.addEventListener("DOMContentLoaded", function () {
    const subTaskForm = document.getElementById("subTaskForm");
    const submitText = document.getElementById("submitText");
    const loadingSpinner = document.getElementById("loadingSpinner");

    subTaskForm.addEventListener("submit", function (event) {
        event.preventDefault();

        // Get input values
        const title = document.getElementById("subTaskTitle").value.trim();
        const description = document.getElementById("subTaskDescription").value.trim();
        const priority = document.getElementById("subTaskPriority").value;
        const deadline = document.getElementById("subTaskDeadline").value;

        if (!title || !deadline) {
            alert("Title and Deadline are required!");
            return;
        }

        // Show loading spinner
        submitText.classList.add("d-none");
        loadingSpinner.classList.remove("d-none");

        // CSRF Token
        const csrftoken = getCSRFToken();

        // AJAX Request
        fetch(`/tasks/create-subtask/${orgId}/${groupId}/${taskId}/`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrftoken,
            },
            body: JSON.stringify({
                title: title,
                description: description,
                priority: priority,
                deadline: deadline,
            }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert("Error: " + data.error);
            } else {
                alert("SubTask Created Successfully!");
                window.location.reload();
            }
        })
        .catch(error => {
            console.error("Error:", error);
            alert("Something went wrong!");
        })
        .finally(() => {
            // Hide spinner and show button text
            submitText.classList.remove("d-none");
            loadingSpinner.classList.add("d-none");
        });
    });

    // Function to get CSRF Token
    function getCSRFToken() {
        return document.cookie.split("; ").find(row => row.startsWith("csrftoken="))?.split("=")[1];
    }
});



// MANAGE SUBTASKS - Full Material UI Implementation
function loadSubTasks(orgId, groupId, taskId) {
    fetch(`/tasks/subtasks/${orgId}/${groupId}/${taskId}/`)
        .then(response => response.json())
        .then(data => {
            const subtaskList = document.getElementById("subtaskList");
            subtaskList.innerHTML = '';

            if (data.subtasks.length === 0) {
                subtaskList.innerHTML = `
                    <div class="flex flex-col items-center justify-center p-8 rounded-xl bg-white/30 backdrop-blur-sm border border-gray-200/50">
                        <svg class="w-12 h-12 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <p class="text-gray-500 font-medium">No subtasks created yet</p>
                        <p class="text-sm text-gray-400 mt-1">Click the '+' button to add new subtasks</p>
                    </div>
                `;
                return;
            }

            data.subtasks.forEach(subtask => {
                subtaskList.innerHTML += `
                    <div class="group relative mb-4 p-5 rounded-xl bg-white/70 backdrop-blur-sm border border-gray-200/60 shadow-sm hover:shadow-md transition-all duration-200 ease-out">
                        <div class="flex gap-4 items-start">
                            <div class="flex-1 min-w-0">
                                <h3 class="text-gray-800 font-semibold text-base mb-2 truncate">${subtask.title}</h3>
                                
                                <div class="flex flex-wrap items-center gap-4 mb-4">
                                    <div class="flex items-center gap-2">
                                        <span class="text-sm text-gray-500">Status:</span>
                                        <select 
                                            id="status-${subtask.id}"
                                            class="min-w-[120px] px-3 py-1.5 text-sm rounded-lg border border-gray-300/80 bg-white/90 shadow-xs focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500 transition-all"
                                            onchange="changeSubTaskStatus('${orgId}', '${groupId}', '${taskId}', '${subtask.id}')">
                                            <option value="Pending" ${subtask.status === "Pending" ? "selected" : ""}>🟡 Pending</option>
                                            <option value="In Progress" ${subtask.status === "In Progress" ? "selected" : ""}>🔵 In Progress</option>
                                            <option value="Completed" ${subtask.status === "Completed" ? "selected" : ""}>🟢 Completed</option>
                                            <option value="Cancelled" ${subtask.status === "Cancelled" ? "selected" : ""}>⚪ Cancelled</option>
                                            <option value="Overdue" ${subtask.status === "Overdue" ? "selected" : ""}>🔴 Overdue</option>
                                        </select>
                                    </div>

                                    <div class="flex items-center gap-2">
                                        <span class="text-sm text-gray-500">Priority:</span>
                                        <div class="flex items-center gap-1 px-2 py-1 rounded-full bg-blue-50/80 text-blue-600 text-xs font-medium">
                                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03zM12.12 15.12A3 3 0 017 13s.879.5 2.5.5c0-1 .5-4 1.25-4.5.5 1 .786 1.293 1.371 1.879A2.99 2.99 0 0113 13a2.99 2.99 0 01-.879 2.121z" clip-rule="evenodd"/>
                                            </svg>
                                            High
                                        </div>
                                    </div>
                                </div>

                                <div class="space-y-3">
                                    <div class="flex items-center justify-between">
                                        <span class="text-sm text-gray-500">Progress</span>
                                        <span id="progress-${subtask.id}" class="text-sm font-semibold text-blue-600">${subtask.progress}%</span>
                                    </div>
                                    <div class="relative">
                                        <div class="h-2.5 bg-gray-200/80 rounded-full overflow-hidden">
                                            <div 
                                                id="progress-bar-${subtask.id}"
                                                class="h-full rounded-full ${getProgressColor(subtask.progress)} transition-all duration-300 ease-out"
                                                style="width: ${subtask.progress}%">
                                                <div class="absolute inset-0 bg-white/30 animate-pulse"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="flex flex-col gap-2">
                                <button 
                                    onclick="updateSubTask('${orgId}', '${groupId}', '${taskId}', '${subtask.id}', 'increase')"
                                    class="p-2 rounded-full bg-blue-50/80 hover:bg-blue-100 text-blue-600 shadow-xs hover:shadow-sm transition-all duration-150 ease-in-out transform hover:scale-105 active:scale-95">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                                    </svg>
                                </button>
                                
                                <button 
                                    onclick="updateSubTask('${orgId}', '${groupId}', '${taskId}', '${subtask.id}', 'decrease')"
                                    class="p-2 rounded-full bg-gray-100/80 hover:bg-gray-200 text-gray-600 shadow-xs hover:shadow-sm transition-all duration-150 ease-in-out transform hover:scale-105 active:scale-95">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 12H6"/>
                                    </svg>
                                </button>
                                
                                <button 
                                    onclick="deleteSubTask('${orgId}', '${groupId}', '${taskId}', '${subtask.id}')"
                                    class="p-2 rounded-full bg-red-50/80 hover:bg-red-100 text-red-500 shadow-xs hover:shadow-sm transition-all duration-150 ease-in-out transform hover:scale-105 active:scale-95">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
        })
        .catch(error => console.error("Error fetching subtasks:", error));
}

function updateSubTask(orgId, groupId, taskId, subtaskId, action) {
    fetch(`/tasks/subtasks/update/${orgId}/${groupId}/${taskId}/${subtaskId}/`, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCSRFToken()
        },
        body: JSON.stringify({ progress: action === "increase" ? 10 : -10 })
    })
    .then(response => response.json())
    .then(data => {
        const progressBar = document.getElementById(`progress-bar-${subtaskId}`);
        const progressText = document.getElementById(`progress-${subtaskId}`);
        
        progressBar.style.width = `${data.new_progress}%`;
        progressBar.className = `h-full rounded-full ${getProgressColor(data.new_progress)} transition-all duration-300 ease-out`;
        progressText.innerText = data.new_progress;
    })
    .catch(error => console.error("Error updating subtask:", error));
}

function changeSubTaskStatus(orgId, groupId, taskId, subtaskId) {
    const newStatus = document.getElementById(`status-${subtaskId}`).value;
    
    fetch(`/tasks/subtasks/update/${orgId}/${groupId}/${taskId}/${subtaskId}/`, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCSRFToken()
        },
        body: JSON.stringify({ status: newStatus })
    })
    .then(response => response.json())
    .then(data => {
        const statusSelect = document.getElementById(`status-${subtaskId}`);
        statusSelect.classList.add('animate-pulse');
        setTimeout(() => statusSelect.classList.remove('animate-pulse'), 500);
    })
    .catch(error => console.error("Error updating status:", error));
}

function deleteSubTask(orgId, groupId, taskId, subtaskId) {
    if (!confirm('Are you sure you want to delete this subtask?')) return;
    
    fetch(`/tasks/subtasks/delete/${orgId}/${groupId}/${taskId}/${subtaskId}/`, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCSRFToken()
        }
    })
    .then(() => {
        const subtaskElement = document.getElementById(`subtask-${subtaskId}`);
        if (subtaskElement) {
            subtaskElement.classList.add('opacity-0', 'translate-x-10');
            setTimeout(() => loadSubTasks(orgId, groupId, taskId), 300);
        }
    })
    .catch(error => console.error("Error deleting subtask:", error));
}

// Get CSRF Token - Fixed
function getCSRFToken() {
    let csrfToken = document.querySelector("[name=csrfmiddlewaretoken]");
    return csrfToken ? csrfToken.value : ""; // Ensure CSRF token exists
}


function getProgressColor(progress) {
    if (progress < 30) return 'bg-red-500';
    if (progress < 70) return 'bg-yellow-500';
    return 'bg-green-500';
}



// EXPORT TASKS
function exportTask(orgId, groupId, taskId) {
    // Store IDs for export
    window.exportTaskData = { orgId, groupId, taskId };
}

// Utility function to show/hide loader
function toggleLoader(button, show) {
    if (show) {
        button.dataset.originalText = button.innerHTML; // Store original text
        button.innerHTML = `<span class="loader"></span> Processing...`;
        button.disabled = true;
    } else {
        button.innerHTML = button.dataset.originalText;
        button.disabled = false;
    }
}

// Handle Export Now
document.getElementById("export-now-btn").addEventListener("click", function () {
    let { orgId, groupId, taskId } = window.exportTaskData;
    let button = this;
    
    toggleLoader(button, true); // Show loader

    fetch(`/tasks/export-task-data/${orgId}/${groupId}/${taskId}?action=export`)
        .then(response => response.blob())
        .then(blob => {
            let a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = "task_report.pdf";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        })
        .catch(error => console.error("Error exporting:", error))
        .finally(() => toggleLoader(button, false)); // Hide loader
});

// Handle Send to Email
// Handle Send to Email
document.getElementById("export-email-btn").addEventListener("click", function () {
    let { orgId, groupId, taskId } = window.exportTaskData;
    let button = this;

    toggleLoader(button, true); // Show loader

    fetch(`/tasks/export-task-data/${orgId}/${groupId}/${taskId}/?action=email`)  // ✅ FIXED: Correct query param format
        .then(response => response.json())
        .then(data => {
            alert(data.message);
        })
        .catch(error => console.error("Error sending email:", error))
        .finally(() => toggleLoader(button, false)); // Hide loader
});



// attach files to the task (PREMIUM)
document.addEventListener("DOMContentLoaded", () => {
    const fileInput = document.getElementById("fileInput");
    const dropArea = document.getElementById("dropArea");
    const previewContainer = document.getElementById("filePreview");
    const progressBar = document.getElementById("progressBar");
    const uploadBtn = document.getElementById("uploadBtn");

    let selectedOrgId = null;
    let selectedGroupId = null;
    let selectedTaskId = null;

    // 📌 Open Modal and Store Task ID
    document.body.addEventListener("click", (event) => {
        const button = event.target.closest("[data-bs-target='#attachFileModal']");
        if (button) {
            selectedOrgId = button.getAttribute("data-org-id");
            selectedGroupId = button.getAttribute("data-group-id");
            selectedTaskId = button.getAttribute("data-task-id");
        }
    });

    // 📌 Drag & Drop Handling
    ["dragover", "dragenter"].forEach(event => {
        dropArea.addEventListener(event, (e) => {
            e.preventDefault();
            dropArea.classList.add("bg-gray-200");
        });
    });

    ["dragleave", "drop"].forEach(event => {
        dropArea.addEventListener(event, (e) => {
            e.preventDefault();
            dropArea.classList.remove("bg-gray-200");
        });
    });

    dropArea.addEventListener("drop", (e) => {
        const file = e.dataTransfer.files[0];
        handleFileSelection(file);
    });

    // 📌 File Input Change Handling
    fileInput.addEventListener("change", () => {
        handleFileSelection(fileInput.files[0]);
    });

    // 📌 Handle File Selection & Preview
    function handleFileSelection(file) {
        if (!file) {
            previewContainer.innerHTML = `<p class="text-gray-500">No file selected</p>`;
            return;
        }

        document.getElementById("fileName").value = file.name;
        const fileReader = new FileReader();

        fileReader.onload = (e) => {
            const fileType = file.type.split("/")[0];

            if (fileType === "image") {
                previewContainer.innerHTML = `<img src="${e.target.result}" class="max-w-full max-h-40 mx-auto rounded">`;
            } else if (fileType === "video") {
                previewContainer.innerHTML = `<video controls class="max-w-full max-h-40 mx-auto rounded">
                                                <source src="${e.target.result}" type="${file.type}">
                                              </video>`;
            } else {
                previewContainer.innerHTML = `<p class="text-gray-800"><i class="material-icons-round">insert_drive_file</i> ${file.name}</p>`;
            }
        };

        fileReader.readAsDataURL(file);
    }

    // 📌 Upload File via AJAX with Progress Bar
    uploadBtn.addEventListener("click", () => {
        const file = fileInput.files[0];
        if (!file) {
            alert("Please select a file to upload!");
            return;
        }

        if (!selectedTaskId || !selectedOrgId || !selectedGroupId) {
            alert("Task ID is missing. Please try again.");
            return;
        }

        const formData = new FormData();
        formData.append("attachment", file);
        formData.append("name", document.getElementById("fileName").value);
        formData.append("description", document.getElementById("fileDescription").value);
        formData.append("category", document.getElementById("fileCategory").value);
        formData.append("is_private", document.getElementById("isPrivate").checked);
        formData.append("send_copy_to_manager", document.getElementById("sendCopyToManager").checked);

        const uploadUrl = `/tasks/attach-task-file/${selectedOrgId}/${selectedGroupId}/${selectedTaskId}/`;

        fetch(uploadUrl, {
            method: "POST",
            headers: {
                "X-CSRFToken": getCSRFToken(),
            },
            body: formData,
        }).then(response => response.json())
          .then(data => {
              if (data.success) {
                  alert("File uploaded successfully!");
                  location.reload();
              } else {
                  alert("Upload failed: " + data.error);
              }
          })
          .catch(error => console.error("Upload Error:", error));
    });

    function getCSRFToken() {
        return document.cookie.split("; ").find(row => row.startsWith("csrftoken"))?.split("=")[1] || "";
    }
});

</script>
</body>
</html>