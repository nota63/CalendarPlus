<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ group.name }} Tasks</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: #f8fafc;
        }
        .font-display {
            font-family: 'Space Grotesk', sans-serif;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .priority-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50/50 to-purple-50/50 min-h-screen">
    <!-- Header -->
    <header class="bg-gradient-to-r from-blue-600 to-purple-600 text-white pt-16 pb-24 px-4 shadow-xl">
        <div class="max-w-6xl mx-auto">
            <div class="text-center space-y-4">
                <h1 class="font-display text-4xl font-bold tracking-tight">{{ group.name }} Tasks</h1>
                <p class="text-lg text-blue-100/90 max-w-2xl mx-auto leading-relaxed">
                    Manage your assigned tasks efficiently. Track progress, meet deadlines, and collaborate seamlessly with your team.
                </p>
            </div>
        </div>
    </header>

    <main class="max-w-6xl mx-auto -mt-12 px-4">
        <!-- Controls Section -->
        <div class="glass-card rounded-2xl p-6 mb-8 shadow-lg flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
            <button class="bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 text-white px-6 py-2.5 rounded-xl font-medium flex items-center gap-2 transition-all transform hover:scale-[1.02]"
                data-bs-toggle="offcanvas" data-bs-target="#learnMoreSidebar">
                <span class="material-icons-round text-lg">help_outline</span>
                Quick Guide
            </button>
            
             <!-- Controls Bar -->
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-8">
            
            
            <div class="glass-effect bg-white/80 p-2 rounded-xl">
                <form method="get" class="flex items-center gap-3">
                    <span class="text-sm font-medium text-gray-600">Priority Filter:</span>
                    <select class="form-select bg-transparent border-none focus:ring-2 focus:ring-blue-500/30 rounded-lg px-4 py-2 text-gray-700"
                            name="priority" onchange="this.form.submit()">
                        <option value="">All</option>
                        <option value="low" {% if request.GET.priority == 'low' %}selected{% endif %}>Low</option>
                        <option value="medium" {% if request.GET.priority == 'medium' %}selected{% endif %}>Medium</option>
                        <option value="high" {% if request.GET.priority == 'high' %}selected{% endif %}>High</option>
                        <option value="urgent" {% if request.GET.priority == 'urgent' %}selected{% endif %}>Urgent</option>
                    </select>
                </form>
            </div>
        </div>

        </div>

        <!-- Tasks Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-12">
            {% for task in tasks %}
            <div class="glass-card group relative rounded-2xl p-6 shadow-md hover:shadow-lg transition-shadow duration-300">
                <!-- Priority Indicator -->
                <div class="absolute top-6 right-6">
                    <span class="priority-badge 
                        {% if task.priority == 'urgent' %}bg-red-100 text-red-800
                        {% elif task.priority == 'high' %}bg-orange-100 text-orange-800
                        {% elif task.priority == 'medium' %}bg-yellow-100 text-yellow-800
                        {% else %}bg-green-100 text-green-800{% endif %}">
                        {{ task.priority }}
                    </span>
                </div>

                <!-- Task Content -->
                <div class="space-y-5">
                    <div>
                        <h3 class="text-xl font-semibold text-gray-800 mb-1">{{ task.title }}</h3>
                        <p class="text-gray-600 text-sm leading-relaxed">{{ task.description }}</p>
                    </div>

                    <!-- Metadata -->
                    <div class="space-y-3">
                        <div class="flex items-center gap-3 text-gray-500">
                            <span class="material-icons-round text-blue-500">calendar_today</span>
                            <span class="text-sm">{{ task.start }}</span>
                        </div>
                        <div class="flex items-center gap-3 text-gray-500">
                            <span class="material-icons-round text-purple-500">schedule</span>
                            <span class="text-sm">Due in 3 days</span>
                        </div>
                    </div>

                    <!-- Progress Bar -->
                    <div>
                        <div class="flex justify-between text-sm mb-2">
                            <span class="text-gray-600">Progress</span>
                            <span class="font-medium text-blue-600">{{ task.progress }}%</span>
                        </div>
                        <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                            <div class="h-full bg-gradient-to-r from-blue-400 to-purple-400 rounded-full transition-all duration-500" 
                                 style="width: {{ task.progress }}%"></div>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="flex items-center justify-between pt-4 border-t border-gray-100">
                        <div class="flex items-center gap-2">
                            <button class="p-2 hover:bg-gray-100 rounded-lg text-gray-500 hover:text-gray-700 transition-colors"
                                onclick="toggleDropdown('{{ task.id }}')">
                                <span class="material-icons-round">more_vert</span>
                            </button>
                            <div class="flex items-center gap-1 text-sm text-gray-500">
                                <span class="material-icons-round text-sm">comment</span>
                                5
                            </div>
                        </div>
                        
                        <div class="flex items-center gap-2">
                            {% if task.in_my_day %}
                            <button class="px-4 py-1.5 bg-green-100 text-green-700 rounded-full text-sm font-medium flex items-center gap-2">
                                <span class="material-icons-round text-sm">check_circle</span>
                                Added
                            </button>
                            {% else %}
                            <button class="px-4 py-1.5 bg-blue-100 text-blue-700 hover:bg-blue-200 rounded-full text-sm font-medium flex items-center gap-2 transition-colors"
                                    onclick="addToMyDay('{{ group.organization.id }}', '{{ group.id }}', '{{ task.id }}')">
                                <span class="material-icons-round text-sm">add_task</span>
                                Add to Day
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Dropdown Menu -->
                <div id="dropdownMenu{{ task.id }}" class="absolute right-6 top-16 hidden w-48 bg-white border border-gray-200 rounded-xl shadow-xl z-10 overflow-hidden">
                    <ul class="py-1.5">
                        <li>
                            <button class="w-full text-left px-4 py-2.5 hover:bg-gray-50 flex items-center gap-3 text-gray-700 text-sm font-medium transition-colors duration-200 ease-out">
                                <i class="material-icons-round text-blue-600 text-[20px]">visibility</i>
                                View Details
                            </button>
                        </li>
                        
                        {% if task.in_my_day %}
                            <li>
                                <a href="{% url 'task_detail' org_id=group.organization.id group_id=group.id task_id=task.id %}" 
                                   class="w-full text-left px-4 py-2.5 hover:bg-gray-50 flex items-center gap-3 text-green-600 text-sm font-medium transition-colors duration-200 ease-out">
                                    <i class="material-icons-round text-green-600 text-[20px]">launch</i>
                                    Launch Task
                                </a>
                            </li>
                        {% else %}
                            <li>
                                <button class="w-full text-left px-4 py-2.5 hover:bg-gray-50 flex items-center gap-3 text-amber-600 text-sm font-medium transition-colors duration-200 ease-out" 
                                        onclick="addToMyDay('{{ group.organization.id }}', '{{ group.id }}', '{{ task.id }}')">
                                    <i class="material-icons-round text-amber-600 text-[20px]">add_task</i>
                                    Add to My Day
                                </button>
                            </li>
                        {% endif %}
                        {% if extend_tasks %}
                          <li>
                            <button class="w-full text-left px-4 py-2 hover:bg-gray-100 flex items-center gap-2 text-red-600" 
                            data-bs-toggle="modal" data-bs-target="#cancelTaskModal" 
                            onclick="setCancelTaskData('{{ organization.id }}', '{{ group.id }}', '{{ task.id }}', '{{ task.title }}')">
                            <i class="material-icons-round">cancel</i>
                            Cancel Task
                           </button>
                         </li>
                        {% endif %} 
                    </ul>

                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Pagination -->
        <div class="glass-card rounded-2xl p-4 mb-12 shadow-md">
            <nav class="flex items-center justify-between">
                <div class="flex items-center gap-1 text-gray-600">
                    <span class="text-sm">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
                </div>
                
                <div class="flex items-center gap-2">
                    {% if page_obj.has_previous %}
                    <a href="?page=1" class="p-2 hover:bg-gray-100 rounded-lg text-gray-500 hover:text-blue-600 transition-colors">
                        <span class="material-icons-round">first_page</span>
                    </a>
                    <a href="?page={{ page_obj.previous_page_number }}" class="p-2 hover:bg-gray-100 rounded-lg text-gray-500 hover:text-blue-600 transition-colors">
                        <span class="material-icons-round">chevron_left</span>
                    </a>
                    {% endif %}

                    {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}" class="p-2 hover:bg-gray-100 rounded-lg text-gray-500 hover:text-blue-600 transition-colors">
                        <span class="material-icons-round">chevron_right</span>
                    </a>
                    <a href="?page={{ page_obj.paginator.num_pages }}" class="p-2 hover:bg-gray-100 rounded-lg text-gray-500 hover:text-blue-600 transition-colors">
                        <span class="material-icons-round">last_page</span>
                    </a>
                    {% endif %}
                </div>
            </nav>
        </div>
    </main>

    <!-- Learn More Sidebar -->
    <div class="fixed inset-0 bg-black/50 z-50 hidden" id="learnMoreOverlay"></div>
    <div class="fixed top-0 right-0 h-full w-96 bg-white shadow-2xl transform translate-x-full transition-transform duration-300 z-50" 
         id="learnMoreSidebar">
        <div class="p-6 h-full flex flex-col">
            <!-- Header -->
            <div class="flex items-center justify-between mb-8">
                <h3 class="text-xl font-semibold text-gray-800 flex items-center gap-2">
                    <span class="material-icons-round text-blue-500">school</span>
                    Task Guide
                </h3>
                <button onclick="closeSidebar()" class="p-2 hover:bg-gray-100 rounded-lg text-gray-500">
                    <span class="material-icons-round">close</span>
                </button>
            </div>

            <!-- Content -->
            <div class="flex-1 overflow-y-auto space-y-6">
                <div class="space-y-4">
                    <h4 class="font-medium text-gray-800 flex items-center gap-2">
                        <span class="material-icons-round text-green-500">rocket_launch</span>
                        Getting Started
                    </h4>
                    <div class="space-y-3 text-gray-600 text-sm">
                        <p>Use priority levels to organize your workflow effectively. Start with urgent tasks and work your way down.</p>
                        <div class="p-4 bg-blue-50/50 rounded-xl">
                            <span class="text-xs font-medium text-blue-600">Pro Tip:</span>
                            <p class="mt-1">Add recurring tasks to "My Day" to build consistent work habits.</p>
                        </div>
                    </div>
                </div>

                <div class="space-y-4">
                    <h4 class="font-medium text-gray-800 flex items-center gap-2">
                        <span class="material-icons-round text-purple-500">priority_high</span>
                        Priority System
                    </h4>
                    <div class="grid grid-cols-2 gap-3 text-sm">
                        <div class="p-3 bg-red-50/50 rounded-xl">
                            <div class="flex items-center gap-2 mb-2">
                                <div class="w-2 h-2 bg-red-500 rounded-full"></div>
                                <span class="font-medium text-red-700">Urgent</span>
                            </div>
                            <p class="text-red-600/80">Immediate action required, critical deadlines</p>
                        </div>
                        <div class="p-3 bg-orange-50/50 rounded-xl">
                            <div class="flex items-center gap-2 mb-2">
                                <div class="w-2 h-2 bg-orange-500 rounded-full"></div>
                                <span class="font-medium text-orange-700">High</span>
                            </div>
                            <p class="text-orange-600/80">Important tasks needing attention</p>
                        </div>
                        <div class="p-3 bg-yellow-50/50 rounded-xl">
                            <div class="flex items-center gap-2 mb-2">
                                <div class="w-2 h-2 bg-yellow-500 rounded-full"></div>
                                <span class="font-medium text-yellow-700">Medium</span>
                            </div>
                            <p class="text-yellow-600/80">Regular priority tasks</p>
                        </div>
                        <div class="p-3 bg-green-50/50 rounded-xl">
                            <div class="flex items-center gap-2 mb-2">
                                <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                                <span class="font-medium text-green-700">Low</span>
                            </div>
                            <p class="text-green-600/80">Can be scheduled for later</p>
                        </div>
                    </div>
                </div>

                <div class="space-y-4">
                    <h4 class="font-medium text-gray-800 flex items-center gap-2">
                        <span class="material-icons-round text-blue-500">tips_and_updates</span>
                        Productivity Tips
                    </h4>
                    <div class="space-y-3 text-sm text-gray-600">
                        <div class="flex items-start gap-3">
                            <span class="material-icons-round text-blue-400 flex-shrink-0">check_circle</span>
                            <div>
                                <p class="font-medium">Daily Review</p>
                                <p class="text-sm">Start each day by reviewing priority tasks</p>
                            </div>
                        </div>
                        <div class="flex items-start gap-3">
                            <span class="material-icons-round text-purple-400 flex-shrink-0">timeline</span>
                            <div>
                                <p class="font-medium">Progress Tracking</p>
                                <p class="text-sm">Update task progress at least twice daily</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="pt-6 border-t border-gray-100">
                <button onclick="closeSidebar()" class="w-full py-2.5 px-4 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-xl text-sm font-medium transition-colors">
                    Close Guide
                </button>
            </div>
        </div>
    </div>
<!-- --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- -->
<!-- Extend Tasks APP modals -->
<!-- Cancel Task Modal -->
<div class="modal fade" id="cancelTaskModal" tabindex="-1" aria-labelledby="cancelTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-red-600 font-bold" id="cancelTaskModalLabel">
                    Cancel Task: <span id="cancelTaskTitle"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-gray-700">Why are you canceling this task?</p>
                <textarea id="cancelReason" class="form-control mt-2" rows="3" placeholder="Enter reason..."></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button id="cancelTaskButton" class="btn btn-danger flex items-center gap-2" onclick="submitTaskCancellation()">
                    <span id="loadingSpinner" class="hidden">
                        <i class="fas fa-spinner fa-spin"></i>
                    </span>
                    Cancel Task
                </button>
            </div>
        </div>
    </div>
</div>








<!-- Bootstrap 5 JS (with Popper.js) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
        // Sidebar Toggle
        function toggleSidebar() {
            document.getElementById('learnMoreOverlay').classList.toggle('hidden');
            document.getElementById('learnMoreSidebar').classList.toggle('translate-x-full');
        }

        function closeSidebar() {
            document.getElementById('learnMoreOverlay').classList.add('hidden');
            document.getElementById('learnMoreSidebar').classList.add('translate-x-full');
        }

        // Dropdown Toggle
        function toggleDropdown(taskId) {
            const dropdown = document.getElementById(`dropdownMenu${taskId}`);
            dropdown.classList.toggle('hidden');
            
            // Close when clicking outside
            document.addEventListener('click', function close(e) {
                if (!dropdown.contains(e.target) && !e.target.closest(`[onclick="toggleDropdown('${taskId}')"]`)) {
                    dropdown.classList.add('hidden');
                    document.removeEventListener('click', close);
                }
            });
        }

        // Add to My Day
        function addToMyDay(orgId, groupId, taskId) {
            const csrfToken = "{{ csrf_token }}";
            fetch(`/tasks/add-to-my-day/${orgId}/${groupId}/${taskId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                }
            })
            .then(response => response.json())
            .then(data => {
                if(data.success) {
                    // Update UI
                    const button = document.querySelector(`[onclick="addToMyDay('${orgId}', '${groupId}', '${taskId}')"]`);
                    if(button) {
                        button.outerHTML = `
                            <button class="px-4 py-1.5 bg-green-100 text-green-700 rounded-full text-sm font-medium flex items-center gap-2">
                                <span class="material-icons-round text-sm">check_circle</span>
                                Added
                            </button>
                        `;
                    }
                }
            })
            .catch(error => console.error('Error:', error));
        }

        // Close sidebar when clicking overlay
        document.getElementById('learnMoreOverlay').addEventListener('click', closeSidebar);


// CANCEL THE TASK
let selectedOrgId = null;
    let selectedGroupId = null;
    let selectedTaskId = null;

    // Function to set task details when opening the cancel modal
    function setCancelTaskData(orgId, groupId, taskId, taskTitle) {
        selectedOrgId = orgId;
        selectedGroupId = groupId;
        selectedTaskId = taskId;

        document.getElementById("cancelTaskTitle").innerText = taskTitle;
    }

    // Function to get CSRF token from cookies
    function getCSRFToken() {
        let cookies = document.cookie.split("; ");
        for (let cookie of cookies) {
            let [name, value] = cookie.split("=");
            if (name === "csrftoken") return value;
        }
        return "";
    }

    // Function to submit task cancellation
    async function submitTaskCancellation() {
        const reason = document.getElementById("cancelReason").value.trim();
        const cancelButton = document.getElementById("cancelTaskButton");
        const spinner = document.getElementById("loadingSpinner");

        if (!reason) {
            alert("Please enter a reason for cancellation.");
            return;
        }

        // Disable button and show spinner
        cancelButton.disabled = true;
        spinner.classList.remove("hidden");

        try {
            const response = await fetch(`/tasks/cancel-task/${selectedOrgId}/${selectedGroupId}/${selectedTaskId}/`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCSRFToken()
                },
                body: JSON.stringify({ reason: reason })
            });

            const data = await response.json();

            if (data.success) {
                alert("Task has been canceled successfully.");
                location.reload();
            } else {
                alert("Error canceling task. Please try again.");
            }
        } catch (error) {
            console.error("Error:", error);
            alert("Something went wrong. Please try again.");
        } finally {
            // Enable button and hide spinner
            cancelButton.disabled = false;
            spinner.classList.add("hidden");
        }
    }


</script>
</body>
</html>