{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ group.name }} Tasks</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Optional: Add custom styles for modern card & progress bar -->
    <style>
        .card {
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .progress-bar {
            border-radius: 20px;
        }
        .modal-content {
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="mb-4" style="font-size: 2rem; color: #2c3e50; font-weight: bold;">
            {{ group.name }} Tasks
        </h1>

        <div class="row">
            {% for task in tasks %}
                <div class="col-md-4 mb-4">
                    <div class="card border-light">
                        <div class="card-header bg-primary text-white">
                            <h5 class="card-title">{{ task.title }}</h5>
                        </div>
                        <div class="card-body">
                            <p><strong>Description:</strong> {{ task.description }}</p>
                            <p><strong>Priority:</strong> {{ task.priority }}</p>
                            <p><strong>Deadline:</strong> {{ task.start }}</p>
        
                            <!-- Modern Progress Bar -->
                            <div class="progress mb-3">
                                <div class="progress-bar" role="progressbar" style="width: {{ task.progress }}%" aria-valuenow="{{ task.progress }}" aria-valuemin="0" aria-valuemax="100">{{ task.progress }}%</div>
                            </div>
                        </div>
                        <div class="card-footer text-end">
                            <button class="btn btn-info" data-bs-toggle="modal" data-bs-target="#taskModal" onclick="populateModal('{{ task.title }}', '{{ task.description }}', '{{ task.priority }}', '{{ task.start }}', {{ task.progress }})">View Details</button>
        
                            {% if task.in_my_day %}
                                <!-- If the task is already added to My Day, show Launch Task button -->
                                <a href="{% url 'task_detail' org_id=group.organization.id group_id=group.id task_id=task.id %}" class="btn btn-success">
                                    Launch Task
                                </a>
                            {% else %}
                                <!-- If the task is not in My Day, show Add to My Day button -->
                                <button 
                                    class="btn btn-warning" 
                                    onclick="addToMyDay('{{ group.organization.id }}', '{{ group.id }}', '{{ task.id }}')">
                                    Add to My Day
                                </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
        

        <!-- Pagination Controls -->
        <div class="d-flex justify-content-center mt-4">
            <nav aria-label="Page navigation">
                <ul class="pagination">
                    {% if page_obj.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page=1" aria-label="First">
                                <span aria-hidden="true">&laquo;&laquo;</span>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.previous_page_number }}" aria-label="Previous">
                                <span aria-hidden="true">&laquo;</span>
                            </a>
                        </li>
                    {% endif %}

                    <li class="page-item active" aria-current="page">
                        <span class="page-link">
                            Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
                        </span>
                    </li>

                    {% if page_obj.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.next_page_number }}" aria-label="Next">
                                <span aria-hidden="true">&raquo;</span>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}" aria-label="Last">
                                <span aria-hidden="true">&raquo;&raquo;</span>
                            </a>
                        </li>
                    {% endif %}
                </ul>
            </nav>
        </div>

    </div>

    <!-- Modal for Task Details -->
    <div class="modal fade" id="taskModal" tabindex="-1" aria-labelledby="taskModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="taskModalLabel">Task Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <h4 id="taskTitle"></h4>
                    <p id="taskDescription"></p>
                    <p><strong>Priority:</strong> <span id="taskPriority"></span></p>
                    <p><strong>Deadline:</strong> <span id="taskDeadline"></span></p>
                    <p><strong>Progress:</strong> <span id="taskProgress"></span>%</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        function populateModal(title, description, priority, deadline, progress) {
            document.getElementById('taskTitle').innerText = title;
            document.getElementById('taskDescription').innerText = description;
            document.getElementById('taskPriority').innerText = priority;
            document.getElementById('taskDeadline').innerText = deadline;
            document.getElementById('taskProgress').innerText = progress;
        }

        // Ajax handler to add day 
        function addToMyDay(orgId, groupId, taskId) {
        const csrfToken = "{{ csrf_token }}"; // CSRF token for Django POST requests

        // Dynamically construct the URL with all required parameters
        const url = `/tasks/add-to-my-day/${orgId}/${groupId}/${taskId}/`;

        fetch(url, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrfToken
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert("Task successfully added to My Day!");
            } else {
                alert("Failed to add task to My Day: " + data.error);
            }
        })
        .catch(error => {
            console.error("Error adding task to My Day:", error);
            alert("An unexpected error occurred. Please try again.");
        });
    }
    </script>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>




