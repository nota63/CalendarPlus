{% extends 'custom.html' %}

{% block content %}


<!-- Bootstrap 5 CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- Bootstrap 5 JS Bundle (includes Popper.js) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<style>
#loadingSpinner {
    display: none;
    text-align: center;
}

.spinner-border {
    width: 3rem;
    height: 3rem;
}


</style>


<div class="container mt-4">
    <h2>Transfer Ownership - {{ organization.name }}</h2>

    <button type="button" class="btn btn-danger delete-btn" data-org-id="{{ organization.id }}">
        Delete {{organization.name}}
    </button>
    <br>
    
    <!-- Search Form -->
    <form method="GET" action="{% url 'workspace_members' org_id=organization.id %}" class="mb-3">
        <div class="input-group">
            <input type="text" class="form-control" name="email" placeholder="Search by email" value="{{ email_search }}">
            <button type="submit" class="btn btn-outline-secondary">Search</button>
        </div>
    </form>
    
    <table class="table table-bordered mt-3">
        <thead>
            <tr>
                <th>Profile Picture</th>
                <th>Full Name</th>
                <th>Email</th>
                <th>Role</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for member in members %}
            <tr>
                <td>
                    {% if member.profile_picture %}
                        <img src="{{ member.profile_picture.url }}" alt="Profile" width="40" height="40" class="rounded-circle">
                    {% else %}
                        <img src="/static/default_profile.png" alt="Default Profile" width="40" height="40" class="rounded-circle">
                    {% endif %}
                </td>
                <td>{{ member.user.username }}</td>
                <td>{{ member.user.email }}</td>
                <td>
                    {% if member.is_admin %}
                        <span class="badge bg-danger">Admin</span>
                    {% elif member.is_manager %}
                        <span class="badge bg-warning">Manager</span>
                    {% else %}
                        <span class="badge bg-primary">Employee</span>
                    {% endif %}
                </td>
                <td>
                    {% if not member.is_admin %}
                        <button class="btn btn-sm btn-outline-danger transfer-btn"
                                data-user-id="{{ member.user.id }}">
                            Transfer Ownership
                        </button>
                    {% else %}
                        <span class="text-muted">Current Owner</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- -------------------------------------------------------------------------------------------------------------------- -->

<!-- Modals -->

<!-- Transfer ownership -->

<!-- Transfer Ownership Modal -->
<div class="modal fade" id="transferOwnershipModal" tabindex="-1" aria-labelledby="transferOwnershipLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="transferOwnershipLabel">Transfer Ownership</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to transfer ownership? This action cannot be undone.</p>
                <input type="password" id="adminPassword" class="form-control" placeholder="Enter your password">
                <input type="hidden" id="selectedUserId">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmTransferBtn">Confirm Transfer</button>
            </div>
        </div>
    </div>
</div>
<!-- Loading spinner -->
 <!-- Add this spinner and text container somewhere in your HTML, hidden by default -->
<div id="loadingSpinner" style="display: none; text-align: center;">
    <div class="spinner-border" role="status">
        <span class="sr-only">Loading...</span>
    </div>
    <p>Operation in progress...</p>
</div>


<!-- Modal for Delete Workspace -->
 <!-- Modal for Delete Workspace -->
<div class="modal fade" id="deleteWorkspaceModal" tabindex="-1" aria-labelledby="deleteWorkspaceModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteWorkspaceModalLabel">Delete Workspace</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this workspace? This action cannot be undone.</p>
                <div class="mb-3">
                    <label for="adminPasswordDeleteModal" class="form-label">Enter your password to confirm:</label>
                    <input type="password" class="form-control" id="adminPasswordDeleteModal" placeholder="Password" required>
                </div>
                <div id="loadingSpinner" style="display: none; text-align: center;">
                    <div class="spinner-border" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                    <p>Deleting workspace...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete Workspace</button>
            </div>
        </div>
    </div>
</div>










<!-- ------------------------------------------------------------------------------------------------------------ -->
<script>
document.addEventListener("DOMContentLoaded", function () {
    let selectedUserId = null;

    // Open modal and set selected user ID
    document.querySelectorAll(".transfer-btn").forEach(button => {
        button.addEventListener("click", function () {
            selectedUserId = this.getAttribute("data-user-id");
            document.getElementById("selectedUserId").value = selectedUserId;
            new bootstrap.Modal(document.getElementById("transferOwnershipModal")).show();
        });
    });

    // Handle confirm transfer click
    document.getElementById("confirmTransferBtn").addEventListener("click", function () {
        const orgId = "{{ organization.id }}";  // Pass the org_id dynamically
        const password = document.getElementById("adminPassword").value;
        const userId = document.getElementById("selectedUserId").value;

        if (!password) {
            alert("Please enter your password.");
            return;
        }

        // Show loading spinner and message
        document.getElementById("loadingSpinner").style.display = "block";

        // Hide the modal while waiting for the request to complete
        const modal = bootstrap.Modal.getInstance(document.getElementById("transferOwnershipModal"));
        modal.hide();

        // Make the request to transfer ownership
        fetch(`/organizations/transfer-ownership/${orgId}/${userId}/`, {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
                "X-CSRFToken": "{{ csrf_token }}"  // Pass CSRF token dynamically
            },
            body: new URLSearchParams({ password })
        })
        .then(response => response.json())
        .then(data => {
            // Hide the loading spinner
            document.getElementById("loadingSpinner").style.display = "none";

            if (data.success) {
                alert("Ownership transferred successfully!");
                window.location.reload();  // Reload the page after success
            } else {
                alert(data.error || "Something went wrong!");
            }
        })
        .catch(error => {
            // Hide the loading spinner on error
            document.getElementById("loadingSpinner").style.display = "none";
            console.error("Error:", error);
            alert("An error occurred, please try again.");
        });
    });
});


// DELETE WORKSPACE
document.addEventListener("DOMContentLoaded", function () {
    let selectedOrgId = null;

    // Open modal to set organization ID
    document.querySelectorAll(".delete-btn").forEach(button => {
        button.addEventListener("click", function () {
            selectedOrgId = this.getAttribute("data-org-id");
            console.log("Selected Org ID:", selectedOrgId); // Debugging: check if org ID is being set correctly
            new bootstrap.Modal(document.getElementById("deleteWorkspaceModal")).show();
        });
    });

    // Handle confirm delete button click
    document.getElementById("confirmDeleteBtn").addEventListener("click", function () {
        const password = document.getElementById("adminPasswordDeleteModal").value; // Updated to new ID
        console.log("Entered Password:", password);  // Debugging: check if password is captured correctly

        if (!password) {
            alert("Please enter your password.");
            return;
        }

        // Show loading spinner
        document.getElementById("loadingSpinner").style.display = "block";

        fetch(`/organizations/delete-workspace/${selectedOrgId}/`, {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
                "X-CSRFToken": "{{ csrf_token }}"  // Pass CSRF token dynamically
            },
            body: new URLSearchParams({ password })
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById("loadingSpinner").style.display = "none"; // Hide spinner
            if (data.success) {
                alert("Workspace deleted successfully!");
                window.location.reload();  // Reload the page after success
            } else {
                alert(data.error || "Something went wrong!");
            }
        })
        .catch(error => {
            document.getElementById("loadingSpinner").style.display = "none"; // Hide spinner in case of error
            console.error("Error:", error);
        });
    });
});

</script>

{% endblock %}
