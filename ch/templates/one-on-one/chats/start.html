<div id="chat-box">
    {% for msg in messages %}
        <p><b>{{ msg.sender.username }}</b>: {{ msg.message }}</p>
    {% endfor %}
</div>

<input type="text" id="message-input" placeholder="Type a message...">
<button id="send-button">Send</button>

<script>
    const chatSocket = new WebSocket("ws://" + window.location.host + "/ws/chat/{{ other_user.username }}/");

    chatSocket.onopen = function() {
        console.log("‚úÖ WebSocket connection established.");
    };

    chatSocket.onmessage = function(e) {
        try {
            const data = JSON.parse(e.data);
            console.log("üì© Received message:", data);

            if (data.message && data.sender) {
                const chatBox = document.getElementById("chat-box");
                const newMessage = document.createElement("p");
                newMessage.innerHTML = `<b>${data.sender}</b>: ${data.message}`;
                chatBox.appendChild(newMessage);

                chatBox.scrollTop = chatBox.scrollHeight; // Auto-scroll to the latest message
            } else {
                console.warn("‚ö†Ô∏è Received incomplete message data:", data);
            }
        } catch (error) {
            console.error("‚ùå Error parsing message:", error);
        }
    };

    chatSocket.onclose = function() {
        console.warn("‚ùå WebSocket connection closed.");
    };

    document.getElementById("send-button").addEventListener("click", function() {
        sendMessage();
    });

    document.getElementById("message-input").addEventListener("keypress", function(event) {
        if (event.key === "Enter") {
            sendMessage();
        }
    });

    function sendMessage() {
        const input = document.getElementById("message-input");
        const message = input.value.trim();

        if (message) {
            const messageData = { "message": message };
            
            console.log("üöÄ Sending message:", messageData);
            chatSocket.send(JSON.stringify(messageData));

            input.value = ""; // Clear input field after sending
        } else {
            console.warn("‚ö†Ô∏è Cannot send empty message.");
        }
    }
</script>

