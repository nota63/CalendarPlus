
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Groups - {{ organization.name }}</title>

      
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">

 
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js"></script>

   
</head>
<body>

    <style>
        /* Style for the dropdown button (3 dots) */
.dropdown-toggle {
    background-color: transparent;
    border: none;
    font-size: 1.5rem;
    color: #495057;  /* Dark gray color */
    padding: 0.3rem 0.6rem;
    transition: all 0.3s ease;
}

/* Change color of the 3-dot button when hovered */
.dropdown-toggle:hover {
    color: #007bff;  /* Bootstrap primary color */
}

/* Style for the dropdown menu */
.dropdown-menu {
    background-color: #ffffff;
    border: 1px solid #ddd;
    border-radius: 0.375rem;
    box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
    padding: 0.5rem;
    min-width: 150px;
}

/* Style for each dropdown item */
.dropdown-item {
    padding: 0.5rem 1rem;
    font-size: 1rem;
    color: #333;
    transition: background-color 0.3s ease;
}

/* Hover effect for dropdown items */
.dropdown-item:hover {
    background-color: #f8f9fa;
    color: #007bff;  /* Bootstrap primary color */
}

/* Styling for the dropdown icon (3 dots) */
.dropdown-toggle::before {
    content: "\2022 \2022 \2022";  /* Unicode for vertical ellipsis */
    font-size: 1.5rem;
    font-weight: bold;
    margin-right: 0.5rem;
}



#loading-spinner {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 9999;
}



/* Modal container */
.modal-content {
  border-radius: 10px;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
  overflow: hidden;
}

/* Modal header */
.modal-header {
  background-color: #f8f9fa;
  border-bottom: 1px solid #dee2e6;
  padding: 15px 20px;
}

.modal-title {
  font-weight: 600;
  font-size: 1.25rem;
  color: #343a40;
}

/* Close button */
.modal-header .btn-close {
  filter: brightness(80%);
}

.modal-header .btn-close:hover {
  filter: brightness(100%);
}

/* Modal body */
.modal-body {
  padding: 20px;
  background-color: #ffffff;
  max-height: 400px; /* Scrollable content */
  overflow-y: auto;
}

/* List group in modal */
.modal-body .list-group {
  margin-top: 10px;
}

.modal-body .list-group-item {
  border: 1px solid #dee2e6;
  border-radius: 5px;
  margin-bottom: 10px;
  background-color: #fdfdfe;
  transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
}

.modal-body .list-group-item:hover {
  transform: scale(1.02);
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
}

/* Highlighted user name */
.modal-body .list-group-item strong {
  color: #0d6efd; /* Bootstrap primary color */
  font-weight: 600;
}

/* Small text */
.modal-body .list-group-item small {
  display: block;
  color: #6c757d;
  margin-top: 5px;
  font-size: 0.9rem;
}

/* Modal footer */
.modal-footer {
  background-color: #f8f9fa;
  border-top: 1px solid #dee2e6;
  padding: 10px 20px;
}

/* Buttons */
.modal-footer .btn {
  padding: 8px 20px;
  font-size: 0.95rem;
  border-radius: 5px;
}

.modal-footer .btn-secondary {
  background-color: #6c757d;
  border: none;
}

.modal-footer .btn-secondary:hover {
  background-color: #5a6268;
}

    </style>

    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">


    <!-- Modals  -->

    <!-- Modal to display group members -->
<div class="modal fade" id="membersModal" tabindex="-1" aria-labelledby="membersModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="membersModalLabel">Group Members</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="teamLeaderDetails">
                    <!-- Team Leader details will go here -->
                </div>
                <h5>Members:</h5>
                <ul id="membersList">
                    <!-- Members will be listed here -->
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Activity Logs -->
<div class="modal fade" id="activityLogsModal" tabindex="-1" aria-labelledby="activityLogsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="activityLogsModalLabel">Activity Logs</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="activityLogsModalBody">
          <!-- Activity logs will be dynamically loaded here -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
  

<!-- ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- -->








<div class="container mt-5">
    <div class="card shadow">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">Groups in {{ organization.name }}</h4>
        </div>
        <div class="card-body">
            {% if groups %}
                <div class="row">
                    {% for group in groups %}
                        <div class="col-md-4 mb-4">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h5 class="card-title">{{ group.name }}</h5>
                                </div>
                                <div class="card-body">
                                    <p class="card-text">{{ group.description|default:"No description available." }}</p>
                                    <p><strong>Team Leader:</strong> {{ group.team_leader.username|default:"No team leader assigned" }}</p>
                                    <p><strong>Created by:</strong> {{ group.created_by.username }}</p>
                                    <p><small class="text-muted">Created on: {{ group.created_at }}</small></p>
                                </div>
                                 <!-- Dropdown for 3-dot menu -->
                              <!-- Dropdown for 3-dot menu -->
                              <div class="dropdown">
                                <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
                                &#x22EE; <!-- This is the Unicode character for 3 dots -->
                           </button>
                          <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                             <li>
                                <a class="dropdown-item" href="{% url 'invite_members_to_group' org_id=group.organization.id group_id=group.id %}">
                                   Invite Teammates
                                 </a>
                               </li>
                            <li>
                               <a class="dropdown-item" href="javascript:void(0);" onclick="fetchGroupMembers({{ group.organization.id }}, {{ group.id }})">
                                    Fetch Members
                                </a>
                             </li>

                             <li>
                                 <a class="dropdown-item text-danger" href="javascript:void(0);" onclick="deleteGroup({{ group.organization.id }}, {{ group.id }})">
                                  Delete Group
                                </a>
                             </li>

                             <li>
                                <a class="dropdown-item" href="javascript:void(0);" onclick="fetchGroupActivityLogs({{ group.organization.id }}, {{ group.id }})">
                                  View Activity Logs
                                </a>
                             </li>
              
                             </div>
                         </ul>
                               <!-- Spinner (Initially hidden) -->
                               <div id="loading-spinner" style="display:none;">
                                <div class="spinner-border text-primary" role="status">
                               <span class="visually-hidden">Loading...</span>
                            </div>

                            </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <p>No groups available for this organization.</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- Bootstrap 5 JS -->
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js"></script>


<script>
    function fetchGroupMembers(org_id, group_id) {
    // Generate the dynamic URL
    const url = `/groups/groups/${org_id}/${group_id}/fetch_group_members/`;

    fetch(url, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,  // Assuming you have CSRF token in your template
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            console.error('Error:', data.error);
            alert('Error fetching members.');
        } else {
            // Show team leader details
            const teamLeaderDetails = `
                <p><strong>Team Leader:</strong> ${data.team_leader.username}</p>
                <p><strong>Role:</strong> ${data.team_leader.role}</p>
            `;
            document.getElementById('teamLeaderDetails').innerHTML = teamLeaderDetails;

            // List the group members
            let membersHtml = '';
            data.members.forEach(member => {
                membersHtml += `
                    <li>
                        <strong>${member.username}</strong> (${member.role})
                        <p>Joined at: ${member.joined_at}</p>
                    </li>
                `;
            });
            document.getElementById('membersList').innerHTML = membersHtml;

            // Show the modal
            const modal = new bootstrap.Modal(document.getElementById('membersModal'));
            modal.show();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to fetch data.');
    });
}

// Function to delete the group
// Function to delete the group
function deleteGroup(orgId, groupId) {
    // Show the loading spinner
    document.getElementById('loading-spinner').style.display = 'block';

    // Confirm the action before proceeding
    if (confirm("Are you sure you want to delete this group? This action cannot be undone.")) {
        // Make an AJAX request to delete the group
        fetch(`/groups/groups/${orgId}/${groupId}/delete_group/`, {
            method: 'POST', // Using POST for deletion
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken') // Get CSRF token for POST request (if CSRF is enabled)
            },
        })
        .then(response => response.json())
        .then(data => {
            // Hide the spinner once the request is complete
            document.getElementById('loading-spinner').style.display = 'none';
            
            if (data.success) {
                alert(data.message);  // Success message
                // Optionally, remove the group's HTML element from the DOM
                document.getElementById(`group-card-${groupId}`).remove();
            } else {
                alert(data.message);  // Failure message
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while deleting the group.');
            // Hide the spinner in case of error
            document.getElementById('loading-spinner').style.display = 'none';
        });
    } else {
        // Hide the spinner if the user cancels the action
        document.getElementById('loading-spinner').style.display = 'none';
    }
}

// Utility function to get the CSRF token (if needed for POST)
function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}


// Function to fetch activity logs

// Function to fetch the activity logs via AJAX
 // Function to fetch group activity logs
 function fetchGroupActivityLogs(orgId, groupId) {
    const url = `/groups/groups/${orgId}/${groupId}/activities`; // Adjust the URL pattern as needed

    // Show a loading spinner while fetching data
    const modalBody = document.getElementById("activityLogsModalBody");
    modalBody.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"></div></div>';

    // Make an AJAX call to fetch the logs
    fetch(url)
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const activities = data.activities;

          // Prepare the logs to display
          if (activities.length === 0) {
            modalBody.innerHTML = "<p>No activity logs available for this group.</p>";
          } else {
            let logsHTML = '<ul class="list-group">';
            activities.forEach(activity => {
              logsHTML += `
                <li class="list-group-item">
                  <strong>${activity.user}</strong>: ${activity.action_type}<br>
                  <small>${activity.details}</small><br>
                  <small class="text-muted">${activity.timestamp}</small>
                </li>
              `;
            });
            logsHTML += "</ul>";
            modalBody.innerHTML = logsHTML;
          }
        } else {
          modalBody.innerHTML = "<p>Failed to fetch activity logs. Please try again later.</p>";
        }
      })
      .catch(error => {
        console.error("Error fetching activity logs:", error);
        modalBody.innerHTML = "<p>There was an error fetching the activity logs.</p>";
      });

    // Show the modal
    const activityLogsModal = new bootstrap.Modal(document.getElementById("activityLogsModal"));
    activityLogsModal.show();
  }
</script>

</body>
</html>

