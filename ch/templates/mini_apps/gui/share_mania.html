{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShareMania - {{ organization.name }}</title>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Styles -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .glass-card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.9);
            box-shadow: 0 4px 24px -2px rgba(0, 0, 0, 0.08);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen text-slate-800 p-6">

<div class="max-w-7xl mx-auto space-y-8">
    <!-- App Header -->
    <div class="glass-card rounded-2xl p-6 shadow-sm">
        <div class="flex items-center gap-6">
            <img src="{{ app.mini_app.icon.url }}" class="w-24 h-24 rounded-xl shadow-md border border-white">
            <div>
                <h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-cyan-500">
                    {{ app.mini_app.name }}
                </h1>
                <p class="text-slate-500 mt-2">Version {{ app.mini_app.version }}</p>
            </div>
        </div>
    </div>

    <!-- Main Content Grid -->
    <div class="grid lg:grid-cols-2 gap-8">
        <!-- Commands Section -->
        <div class="glass-card rounded-2xl p-6">
            <h2 class="text-2xl font-semibold mb-6 text-blue-700">Available Commands</h2>
            <div class="grid grid-cols-2 gap-3">
                {% for command in app.mini_app.commands %}
                <div class="group bg-white hover:bg-blue-50 p-4 rounded-xl transition-all duration-200 cursor-pointer border border-gray-200 hover:border-blue-300">
                    <span class="text-blue-600 font-mono">$</span>
                    <span class="ml-2 text-slate-700 group-hover:text-blue-900">{{ command }}</span>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Shared Files Section -->
        <div class="glass-card rounded-2xl p-6">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-semibold text-slate-800">Shared Files</h2>
                <button class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-lg font-medium transition-all flex items-center gap-2 shadow-sm"
                        data-bs-toggle="modal" data-bs-target="#fileUploadModal">
                    <span class="material-icons-round text-sm">cloud_upload</span>
                    New Upload
                </button>
            </div>

            {% if shared_files %}
            <div class="space-y-4">
                {% for file in shared_files %}
                <div class="bg-white hover:bg-gray-50 p-4 rounded-xl border border-gray-200 transition-all shadow-sm">
                    <div class="flex items-center gap-4">
                        <div class="bg-blue-100 p-3 rounded-lg">
                            <span class="material-icons-round text-blue-600">description</span>
                        </div>
                        <div class="flex-1">
                            <h3 class="font-medium text-slate-800">{{ file.file_name }}</h3>
                            <p class="text-sm text-slate-500">{{ file.file_size }} • Expires {{ file.expires_at|date:"M d" }}</p>
                        </div>
                        <button class="text-blue-600 hover:text-blue-700 p-2 rounded-lg"
                                data-bs-toggle="modal" data-bs-target="#fileDetailsModal"
                                onclick="loadFileDetails('{{ file.unique_link }}')">
                            <span class="material-icons-round">info</span>
                        </button>
                    </div>
                    <div class="mt-3 pt-3 border-t border-gray-100">
                        <p class="text-sm text-slate-500">
                            Shared with: {% for user in file.shared_with.all %}{{ user.username }}{% if not forloop.last %}, {% endif %}{% empty %}No one{% endfor %}
                        </p>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-12">
                <div class="max-w-xs mx-auto mb-6 opacity-75">
                    <img src="https://www.svgrepo.com/show/450139/files.svg" class="w-full h-auto filter invert-[20%]">
                </div>
                <p class="text-slate-500">No files shared yet. Upload your first file!</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- CTA Section -->
    <div class="glass-card rounded-2xl p-6 bg-gradient-to-r from-blue-50 to-cyan-50 border border-blue-100">
        <div class="flex items-center gap-6">
            <div class="flex-1">
                <h3 class="text-xl font-semibold mb-2 text-slate-800">🚀 Supercharged File Sharing</h3>
                <p class="text-slate-600">Experience blazing-fast transfers up to 20GB with {{ organization.name }}'s secure platform.</p>
            </div>
            <div class="flex gap-3">
                <button class="bg-white text-slate-700 hover:bg-gray-50 px-6 py-3 rounded-xl flex items-center gap-2 transition-all border border-gray-200 shadow-sm">
                    <span class="material-icons-round text-blue-600">help</span>
                    Documentation
                </button>
            </div>
        </div>
    </div>
</div>



<!-- MODALS -->
<!-- 2️⃣ FILE UPLOAD MODAL -->
<div class="modal fade" id="fileUploadModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Share File</h5>
                <p>Team-mates will be able to download the shared file even if they have'nt installed share-mania!</p>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="fileUploadForm">
                    <input type="hidden" name="org_id" id="org_id" value="YOUR_ORG_ID_HERE">
                    <div class="mb-3">
                        <label class="form-label">Select File</label>
                        <input type="file" class="form-control" name="file" id="fileInput" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">File Name</label>
                        <input type="text" class="form-control" name="file_name" id="fileNameInput" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Expires In (Days)</label>
                        <input type="number" class="form-control" name="expires_in_days" id="expiresInput" value="7">
                    </div>
                    <button type="submit" class="btn btn-success">Upload</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- 3️⃣ USER SELECTION MODAL -->
<div class="modal fade" id="userSelectionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Select Users to Share</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <ul id="userList" class="list-group"></ul>
            </div>
            <div class="modal-footer">
                <button id="sendFileLink" class="btn btn-primary">Send</button>
            </div>
        </div>
    </div>
</div>

<!-- FILE DETAILS MODAL -->
 <!-- Bootstrap Modal -->
<div class="modal fade" id="fileDetailsModal" tabindex="-1" aria-labelledby="fileDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="fileDetailsModalLabel">File Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="fileDetailsContent">
                <p>Loading file details...</p>
            </div>
        </div>
    </div>
</div>



<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
 document.addEventListener("DOMContentLoaded", function () {
    const fileUploadForm = document.getElementById("fileUploadForm");
    const fileInput = document.getElementById("fileInput");
    const fileNameInput = document.getElementById("fileNameInput");
    const expiresInput = document.getElementById("expiresInput");
    const userList = document.getElementById("userList");
    const sendFileLinkBtn = document.getElementById("sendFileLink");
    const userSelectionModalEl = document.getElementById("userSelectionModal");
    const fileUploadModalEl = document.getElementById("fileUploadModal");
    const orgId = "{{ organization.id }}"; // Ensure this is passed correctly in your template

    let uploadedFileId = null;
    let selectedUsers = [];

    // 📌 File Upload Form Submission
    fileUploadForm.addEventListener("submit", function (e) {
        e.preventDefault();

        if (!fileInput.files.length) {
            alert("Please select a file to upload.");
            return;
        }

        let formData = new FormData();
        formData.append("file", fileInput.files[0]);
        formData.append("file_name", fileNameInput.value);
        formData.append("expires_in_days", expiresInput.value);

        fetch(`/apps/upload-file/${orgId}/`, {
            method: "POST",
            body: formData,
            headers: {
                "X-CSRFToken": getCSRFToken(),
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                uploadedFileId = data.file_id;
                console.log("✅ File uploaded successfully. File ID:", uploadedFileId);

                // Close file upload modal
                bootstrap.Modal.getOrCreateInstance(fileUploadModalEl).hide();

                // Fetch members and open selection modal
                fetchMembers();
            } else {
                console.error("❌ File upload failed:", data.error);
                alert("File upload failed. Please try again.");
            }
        })
        .catch(error => {
            console.error("❌ Error uploading file:", error);
            alert("An error occurred during file upload.");
        });
    });

    // 📌 Fetch Members (GET Request)
    function fetchMembers() {
        console.log("🔄 Fetching members...");

        fetch(`/apps/fetch-members-workspace/${orgId}/`, {
            method: "GET",
            headers: { "X-CSRFToken": getCSRFToken() },
        })
        .then(response => response.json())
        .then(data => {
            if (data.members && data.members.length > 0) {
                userList.innerHTML = ""; // Clear previous list
                data.members.forEach(user => {
                    let listItem = document.createElement("li");
                    listItem.className = "list-group-item";
                    listItem.innerHTML = `
                        <input type="checkbox" class="form-check-input user-checkbox" value="${user.user}"> 
                        <img src="${user.profile_picture}" alt="Profile" class="rounded-circle" width="30"> 
                        ${user.full_name}
                    `;
                    userList.appendChild(listItem);
                });

                console.log("✅ Members fetched successfully. Opening selection modal...");
                bootstrap.Modal.getOrCreateInstance(userSelectionModalEl).show();
            } else {
                console.warn("⚠️ No members found in the workspace.");
                alert("No members found in the workspace.");
            }
        })
        .catch(error => {
            console.error("❌ Error fetching members:", error);
            alert("An error occurred while fetching members.");
        });
    }

    // 📌 Send File Link to Selected Users (POST Request)
    sendFileLinkBtn.addEventListener("click", function () {
        selectedUsers = Array.from(document.querySelectorAll(".user-checkbox:checked"))
                            .map(checkbox => checkbox.value);

        if (!uploadedFileId) {
            alert("No file uploaded.");
            return;
        }
        if (selectedUsers.length === 0) {
            alert("Please select at least one user.");
            return;
        }

        console.log("📤 Sending file link to selected users:", selectedUsers);

        fetch(`/apps/fetch-members-workspace/${orgId}/`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCSRFToken(),
            },
            body: JSON.stringify({
                file_id: uploadedFileId,
                selected_users: selectedUsers,
            }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log("✅ File link sent successfully!");
                alert("File link sent successfully!");
                bootstrap.Modal.getOrCreateInstance(userSelectionModalEl).hide();
            } else {
                console.error("❌ Failed to send file link:", data.error);
                alert("Failed to send file link.");
            }
        })
        .catch(error => {
            console.error("❌ Error sending file link:", error);
            alert("An error occurred. Please try again.");
        });
    });

    // 📌 Get CSRF Token Function
    function getCSRFToken() {
        const cookieValue = document.cookie
            .split("; ")
            .find(row => row.startsWith("csrftoken="))
            ?.split("=")[1];
        return cookieValue || "";
    }
});

// FETCH FILE DETAILS 
function loadFileDetails(uniqueLink) {
    fetch(`/apps/fetch-file-details/${uniqueLink}/`)
        .then(response => response.json())
        .then(data => {
            let content = `
                <p><strong>File Name:</strong> ${data.file_name}</p>
                <p><strong>File Size:</strong> ${data.file_size}</p>
                <p><strong>Uploaded By:</strong> ${data.uploaded_by}</p>
                <p><strong>Shared With:</strong> ${data.shared_with}</p>
                <p><strong>Downloaded By:</strong> ${data.downloaded_by}</p>
                <p><strong>Expires At:</strong> ${data.expires_at}</p>
                <a href="${data.file_url}" class="btn btn-success">📥 Download</a>
                ${data.is_expired ? '<p class="text-danger">❌ This file has expired.</p>' : ''}
            `;
            document.getElementById('fileDetailsContent').innerHTML = content;
        });
}



</script>


</body>
</html>