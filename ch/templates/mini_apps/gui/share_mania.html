
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"> */


    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jkanban@1.2.0/dist/jkanban.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/jkanban@1.2.0/dist/jkanban.min.js"></script>


    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <meta name="csrf-token" content="{{ csrf_token }}">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'apps/launch.css'%}">

<title>ShareMania</title>

</head>
<body>

   <!-- App Card -->
   <div class="glass-card p-6 mb-8">
    <div class="flex items-center space-x-6">
        <img src="{{ app.mini_app.icon.url }}" class="w-20 h-20 rounded-2xl shadow-lg">
        <div>
            <h2 class="text-4xl font-bold mb-1">{{ app.mini_app.name }}</h2>
            <p class="text-indigo-200 text-lg">Version {{ app.mini_app.version }}</p>
        </div>
    </div>
</div>

<!-- Commands Section -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
    <div class="glass-card p-6">
        <h3 class="text-xl font-semibold mb-4">Available Commands</h3>
        <div class="grid grid-cols-2 gap-3">
            {% for command in app.mini_app.commands %}
            <div class="bg-white/5 hover:bg-white/10 p-3 rounded-lg transition-colors">
                <span class="font-mono text-indigo-300">$</span>
                <span class="ml-2">{{ command }}</span>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- fetch already shared files  -->

    <div class="shared-files">
        {% if shared_files %}
           <p>Recent shared files</p>
             {% for file in shared_files %}
                <strong>{{file.file_name}}</strong>
                <p>{{file.file_size}}</p>
                <p>Will expire on {{file.expires_at}}</p>
                <p><strong>Sent To:</strong> 
                    {% if file.shared_with.all %}
                        {% for user in file.shared_with.all %}
                            {{ user.username }}{% if not forloop.last %}, {% endif %}
                        {% endfor %}
                    {% else %}
                        No one
                    {% endif %}
                </p>
                
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#fileDetailsModal" 
                onclick="loadFileDetails('{{ file.unique_link }}')">
                     üìÇ Details
                 </button>
             {% endfor %}  
            {% else %}
             <img src="https://www.svgrepo.com/show/450139/files.svg" alt="No files shared yet">
             <p>No Files Shared Yet</p>   
              
        {% endif %}      
    </div>


<!-- 1Ô∏è‚É£ BUTTON TO TRIGGER FILE UPLOAD MODAL -->
<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#fileUploadModal">
    <i class="material-icons">cloud_upload</i> Upload File
</button>




<!-- MODALS -->
<!-- 2Ô∏è‚É£ FILE UPLOAD MODAL -->
<div class="modal fade" id="fileUploadModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Upload File</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="fileUploadForm">
                    <input type="hidden" name="org_id" id="org_id" value="YOUR_ORG_ID_HERE">
                    <div class="mb-3">
                        <label class="form-label">Select File</label>
                        <input type="file" class="form-control" name="file" id="fileInput" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">File Name</label>
                        <input type="text" class="form-control" name="file_name" id="fileNameInput" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Expires In (Days)</label>
                        <input type="number" class="form-control" name="expires_in_days" id="expiresInput" value="7">
                    </div>
                    <button type="submit" class="btn btn-success">Upload</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- 3Ô∏è‚É£ USER SELECTION MODAL -->
<div class="modal fade" id="userSelectionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Select Users to Share</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <ul id="userList" class="list-group"></ul>
            </div>
            <div class="modal-footer">
                <button id="sendFileLink" class="btn btn-primary">Send</button>
            </div>
        </div>
    </div>
</div>

<!-- FILE DETAILS MODAL -->
 <!-- Bootstrap Modal -->
<div class="modal fade" id="fileDetailsModal" tabindex="-1" aria-labelledby="fileDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="fileDetailsModalLabel">File Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="fileDetailsContent">
                <p>Loading file details...</p>
            </div>
        </div>
    </div>
</div>



<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
 document.addEventListener("DOMContentLoaded", function () {
    const fileUploadForm = document.getElementById("fileUploadForm");
    const fileInput = document.getElementById("fileInput");
    const fileNameInput = document.getElementById("fileNameInput");
    const expiresInput = document.getElementById("expiresInput");
    const userList = document.getElementById("userList");
    const sendFileLinkBtn = document.getElementById("sendFileLink");
    const userSelectionModalEl = document.getElementById("userSelectionModal");
    const fileUploadModalEl = document.getElementById("fileUploadModal");
    const orgId = "{{ organization.id }}"; // Ensure this is passed correctly in your template

    let uploadedFileId = null;
    let selectedUsers = [];

    // üìå File Upload Form Submission
    fileUploadForm.addEventListener("submit", function (e) {
        e.preventDefault();

        if (!fileInput.files.length) {
            alert("Please select a file to upload.");
            return;
        }

        let formData = new FormData();
        formData.append("file", fileInput.files[0]);
        formData.append("file_name", fileNameInput.value);
        formData.append("expires_in_days", expiresInput.value);

        fetch(`/apps/upload-file/${orgId}/`, {
            method: "POST",
            body: formData,
            headers: {
                "X-CSRFToken": getCSRFToken(),
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                uploadedFileId = data.file_id;
                console.log("‚úÖ File uploaded successfully. File ID:", uploadedFileId);

                // Close file upload modal
                bootstrap.Modal.getOrCreateInstance(fileUploadModalEl).hide();

                // Fetch members and open selection modal
                fetchMembers();
            } else {
                console.error("‚ùå File upload failed:", data.error);
                alert("File upload failed. Please try again.");
            }
        })
        .catch(error => {
            console.error("‚ùå Error uploading file:", error);
            alert("An error occurred during file upload.");
        });
    });

    // üìå Fetch Members (GET Request)
    function fetchMembers() {
        console.log("üîÑ Fetching members...");

        fetch(`/apps/fetch-members-workspace/${orgId}/`, {
            method: "GET",
            headers: { "X-CSRFToken": getCSRFToken() },
        })
        .then(response => response.json())
        .then(data => {
            if (data.members && data.members.length > 0) {
                userList.innerHTML = ""; // Clear previous list
                data.members.forEach(user => {
                    let listItem = document.createElement("li");
                    listItem.className = "list-group-item";
                    listItem.innerHTML = `
                        <input type="checkbox" class="form-check-input user-checkbox" value="${user.user}"> 
                        <img src="${user.profile_picture}" alt="Profile" class="rounded-circle" width="30"> 
                        ${user.full_name}
                    `;
                    userList.appendChild(listItem);
                });

                console.log("‚úÖ Members fetched successfully. Opening selection modal...");
                bootstrap.Modal.getOrCreateInstance(userSelectionModalEl).show();
            } else {
                console.warn("‚ö†Ô∏è No members found in the workspace.");
                alert("No members found in the workspace.");
            }
        })
        .catch(error => {
            console.error("‚ùå Error fetching members:", error);
            alert("An error occurred while fetching members.");
        });
    }

    // üìå Send File Link to Selected Users (POST Request)
    sendFileLinkBtn.addEventListener("click", function () {
        selectedUsers = Array.from(document.querySelectorAll(".user-checkbox:checked"))
                            .map(checkbox => checkbox.value);

        if (!uploadedFileId) {
            alert("No file uploaded.");
            return;
        }
        if (selectedUsers.length === 0) {
            alert("Please select at least one user.");
            return;
        }

        console.log("üì§ Sending file link to selected users:", selectedUsers);

        fetch(`/apps/fetch-members-workspace/${orgId}/`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCSRFToken(),
            },
            body: JSON.stringify({
                file_id: uploadedFileId,
                selected_users: selectedUsers,
            }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log("‚úÖ File link sent successfully!");
                alert("File link sent successfully!");
                bootstrap.Modal.getOrCreateInstance(userSelectionModalEl).hide();
            } else {
                console.error("‚ùå Failed to send file link:", data.error);
                alert("Failed to send file link.");
            }
        })
        .catch(error => {
            console.error("‚ùå Error sending file link:", error);
            alert("An error occurred. Please try again.");
        });
    });

    // üìå Get CSRF Token Function
    function getCSRFToken() {
        const cookieValue = document.cookie
            .split("; ")
            .find(row => row.startsWith("csrftoken="))
            ?.split("=")[1];
        return cookieValue || "";
    }
});

// FETCH FILE DETAILS 
function loadFileDetails(uniqueLink) {
    fetch(`/apps/fetch-file-details/${uniqueLink}/`)
        .then(response => response.json())
        .then(data => {
            let content = `
                <p><strong>File Name:</strong> ${data.file_name}</p>
                <p><strong>File Size:</strong> ${data.file_size}</p>
                <p><strong>Uploaded By:</strong> ${data.uploaded_by}</p>
                <p><strong>Shared With:</strong> ${data.shared_with}</p>
                <p><strong>Downloaded By:</strong> ${data.downloaded_by}</p>
                <p><strong>Expires At:</strong> ${data.expires_at}</p>
                <a href="${data.file_url}" class="btn btn-success">üì• Download</a>
                ${data.is_expired ? '<p class="text-danger">‚ùå This file has expired.</p>' : ''}
            `;
            document.getElementById('fileDetailsContent').innerHTML = content;
        });
}



</script>


</body>
</html>